<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of importNMRdata</title>
  <meta name="keywords" content="importNMRdata">
  <meta name="description" content=" is the general import routine for NMR data">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- # nucleus --><!-- # functions --><!-- menu.html interface -->
<h1>importNMRdata
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong> is the general import routine for NMR data</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function importNMRdata(src) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment">importNMRdata is the general import routine for NMR data

 Syntax:
       importNMRdata(src)

 Inputs:
       src - handle of the calling menu

 Outputs:
       none

 Example:
       importNMRdata(src)

 Other m-files required:
       cleanupGUIData
       clearAllAxes
       displayStatusText
       enableGUIelements('NMR');
       LoadNMRData_driver
       NUCLEUSinv_updateInterface

 Subfunctions:
       getNMRPathFile
       importDataBGR
       importDataBGRmat
       importDataDart
       importDataGeneral
       importDataLIAG
       importDataLIAGproject
       importDataMouse
       importDataHelios 
       loadGUIParameters
       loadGUIrawdata

 MAT-files required:
       none

 See also: NUCLEUSinv, NUCLEUSmod
 Author: see AUTHORS.md
 email: see AUTHORS.md
 License: MIT License (at end)</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../nucleus/NUCLEUSinv/NUCLEUSinv_updateInterface.html" class="code" title="function NUCLEUSinv_updateInterface">NUCLEUSinv_updateInterface</a>	 updates all GUI elements</li><li><a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>	 loads NMR raw data from different file formats</li><li><a href="../../../nucleus/functions/import/fixParameterString.html" class="code" title="function str = fixParameterString(str)">fixParameterString</a>	 cleans parameter file lines when the properties have a</li><li><a href="../../../nucleus/functions/import/rotateT2phase.html" class="code" title="function [s_rot,alpha] = rotateT2phase(s,varargin)">rotateT2phase</a>	 rotateT2phase rotates the complex NMR T2 signal so that the imaginary</li><li><a href="cleanupGUIData.html" class="code" title="function data = cleanupGUIData(data)">cleanupGUIData</a>	 removes unnecessary fields from the global "data" struct</li><li><a href="clearAllAxes.html" class="code" title="function clearAllAxes(figh)">clearAllAxes</a>	 clears all axes of a given figure</li><li><a href="displayStatusText.html" class="code" title="function displayStatusText(gui,string)">displayStatusText</a>	 shows status information either in the GUI or on the</li><li><a href="enableGUIelements.html" class="code" title="function enableGUIelements(importtype)">enableGUIelements</a>	 activates all necessary GUI elements after successful</li><li><a href="makeINIfile.html" class="code" title="function gui = makeINIfile(gui,method)">makeINIfile</a>	 creates or updates the ini-File</li><li><a href="../../../nucleus/functions/inversion/fitDataFree.html" class="code" title="function [fitdata] = fitDataFree(time,signal,flag,parameter,nExp)">fitDataFree</a>	 is a control routine that uses 'lsqcurvefit' to fit NMR data</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../nucleus/callbacks/menus/onMenuImport.html" class="code" title="function onMenuImport(src,~)">onMenuImport</a>	 handles the import menu entries</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function [NMRpath,NMRfile] = getNMRPathFile(label,import)</a></li><li><a href="#_sub2" class="code">function [data,gui] = importDataMouseCPMG(data,gui)</a></li><li><a href="#_sub3" class="code">function [data,gui] = importDataBGRmat(data,gui)</a></li><li><a href="#_sub4" class="code">function [data,gui] = importDataBGRliftSingle(data,gui)</a></li><li><a href="#_sub5" class="code">function [data,gui] = importDataBGRlift(data,gui)</a></li><li><a href="#_sub6" class="code">function [data,gui] = importDataHeliosCPMG(data,gui)</a></li><li><a href="#_sub7" class="code">function [data,gui] = importDataHeliosSeries(data,gui)</a></li><li><a href="#_sub8" class="code">function [data,gui] = importDataDartSeries(data,gui)</a></li><li><a href="#_sub9" class="code">function [data,gui] = importDataDartT2logging(data,gui,useburst)</a></li><li><a href="#_sub10" class="code">function [data,gui] = importDataDart(data,gui)</a></li><li><a href="#_sub11" class="code">function [data,gui] = importDataRoCAT1T2(data,gui)</a></li><li><a href="#_sub12" class="code">function [data,gui] = importDataGeneral(data,gui)</a></li><li><a href="#_sub13" class="code">function [data,gui] = importDataLIAG(data,gui)</a></li><li><a href="#_sub14" class="code">function [data,gui] = importDataLIAGcore(data,gui)</a></li><li><a href="#_sub15" class="code">function [data,gui] = importDataLIAGproject(data,gui)</a></li><li><a href="#_sub16" class="code">function [data,gui] = importDataMouse(data,gui)</a></li><li><a href="#_sub17" class="code">function [data,gui] = importDataIBAC(data,gui)</a></li><li><a href="#_sub18" class="code">function data = loadGUIParameters(datapath,fname)</a></li><li><a href="#_sub19" class="code">function data = loadGUIrawdata(data,NMRpath,NMRfile)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function importNMRdata(src)</a>
0002 <span class="comment">%importNMRdata is the general import routine for NMR data</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% Syntax:</span>
0005 <span class="comment">%       importNMRdata(src)</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% Inputs:</span>
0008 <span class="comment">%       src - handle of the calling menu</span>
0009 <span class="comment">%</span>
0010 <span class="comment">% Outputs:</span>
0011 <span class="comment">%       none</span>
0012 <span class="comment">%</span>
0013 <span class="comment">% Example:</span>
0014 <span class="comment">%       importNMRdata(src)</span>
0015 <span class="comment">%</span>
0016 <span class="comment">% Other m-files required:</span>
0017 <span class="comment">%       cleanupGUIData</span>
0018 <span class="comment">%       clearAllAxes</span>
0019 <span class="comment">%       displayStatusText</span>
0020 <span class="comment">%       enableGUIelements('NMR');</span>
0021 <span class="comment">%       LoadNMRData_driver</span>
0022 <span class="comment">%       NUCLEUSinv_updateInterface</span>
0023 <span class="comment">%</span>
0024 <span class="comment">% Subfunctions:</span>
0025 <span class="comment">%       getNMRPathFile</span>
0026 <span class="comment">%       importDataBGR</span>
0027 <span class="comment">%       importDataBGRmat</span>
0028 <span class="comment">%       importDataDart</span>
0029 <span class="comment">%       importDataGeneral</span>
0030 <span class="comment">%       importDataLIAG</span>
0031 <span class="comment">%       importDataLIAGproject</span>
0032 <span class="comment">%       importDataMouse</span>
0033 <span class="comment">%       importDataHelios</span>
0034 <span class="comment">%       loadGUIParameters</span>
0035 <span class="comment">%       loadGUIrawdata</span>
0036 <span class="comment">%</span>
0037 <span class="comment">% MAT-files required:</span>
0038 <span class="comment">%       none</span>
0039 <span class="comment">%</span>
0040 <span class="comment">% See also: NUCLEUSinv, NUCLEUSmod</span>
0041 <span class="comment">% Author: see AUTHORS.md</span>
0042 <span class="comment">% email: see AUTHORS.md</span>
0043 <span class="comment">% License: MIT License (at end)</span>
0044 
0045 <span class="comment">%------------- BEGIN CODE --------------</span>
0046 
0047 <span class="comment">%% get GUI handle and data</span>
0048 fig = findobj(<span class="string">'Tag'</span>,<span class="string">'INV'</span>);
0049 gui = getappdata(fig,<span class="string">'gui'</span>);
0050 data = getappdata(fig,<span class="string">'data'</span>);
0051 
0052 <span class="comment">% try is used to catch any import error</span>
0053 <span class="comment">% often the wrong input file format is the case</span>
0054 <span class="keyword">try</span>
0055     <span class="comment">% check what import format is chosen</span>
0056     label = get(src,<span class="string">'Label'</span>);
0057     
0058     <span class="comment">% set file format for later use</span>
0059     <span class="keyword">if</span> strcmp(label,<span class="string">'Dart T1T2'</span>)
0060         data.import.fileformat = <span class="string">'dartSeries'</span>;
0061     <span class="keyword">elseif</span> strcmp(label,<span class="string">'Dart T2 logging'</span>)
0062         data.import.fileformat = <span class="string">'dartT2logging'</span>;    
0063     <span class="keyword">elseif</span> strcmp(label,<span class="string">'BAM TOM'</span>)
0064         data.import.fileformat = <span class="string">'bamtom'</span>;
0065     <span class="keyword">elseif</span> strcmp(label,<span class="string">'BGR mat'</span>)
0066         data.import.fileformat = <span class="string">'bgrmat'</span>;
0067     <span class="keyword">elseif</span> strcmp(label,<span class="string">'BGR std'</span>)
0068         data.import.fileformat = <span class="string">'bgr'</span>;
0069     <span class="keyword">elseif</span> strcmp(label,<span class="string">'CoreLab ascii'</span>)
0070         data.import.fileformat = <span class="string">'corelab'</span>;
0071     <span class="keyword">elseif</span> strcmp(label,<span class="string">'DART'</span>)
0072         data.import.fileformat = <span class="string">'dart'</span>;
0073     <span class="keyword">elseif</span> strcmp(label,<span class="string">'DART (+Burst)'</span>)
0074         data.import.fileformat = <span class="string">'dartT2logging'</span>;    
0075     <span class="keyword">elseif</span> strcmp(label,<span class="string">'GGE ascii'</span>)
0076         data.import.fileformat = <span class="string">'rwth'</span>;
0077     <span class="keyword">elseif</span> strcmp(label,<span class="string">'GGE field'</span>)
0078         data.import.fileformat = <span class="string">'field'</span>;
0079     <span class="keyword">elseif</span> strcmp(label,<span class="string">'GGE Dart'</span>)
0080         data.import.fileformat = <span class="string">'dart'</span>;
0081     <span class="keyword">elseif</span> strcmp(label,<span class="string">'HeliosCPMG'</span>)
0082         data.import.fileformat = <span class="string">'heliosCPMG'</span>;
0083     <span class="keyword">elseif</span> strcmp(label,<span class="string">'HeliosSeries'</span>)
0084         data.import.fileformat = <span class="string">'heliosSeries'</span>;    
0085     <span class="keyword">elseif</span> strcmp(label,<span class="string">'LIAG core'</span>)
0086         data.import.fileformat = <span class="string">'liag'</span>;
0087     <span class="keyword">elseif</span> strcmp(label,<span class="string">'LIAG from project'</span>)
0088         data.import.fileformat = <span class="string">'liag'</span>;
0089     <span class="keyword">elseif</span> strcmp(label,<span class="string">'LIAG last project'</span>)
0090         data.import.fileformat = <span class="string">'liag'</span>;
0091     <span class="keyword">elseif</span> strcmp(label,<span class="string">'LIAG single'</span>)
0092         data.import.fileformat = <span class="string">'liag'</span>;
0093     <span class="keyword">elseif</span> strcmp(label,<span class="string">'MOUSE'</span>)
0094         data.import.fileformat = <span class="string">'mouse'</span>;
0095     <span class="keyword">elseif</span> strcmp(label,<span class="string">'MouseCPMG'</span>)
0096         data.import.fileformat = <span class="string">'MouseCPMG'</span>;
0097     <span class="keyword">elseif</span> strcmp(label,<span class="string">'MouseLift'</span>)
0098         data.import.fileformat = <span class="string">'MouseLift'</span>;
0099     <span class="keyword">elseif</span> strcmp(label,<span class="string">'PM5'</span>)
0100         data.import.fileformat = <span class="string">'pm5'</span>;
0101     <span class="keyword">elseif</span> strcmp(label,<span class="string">'PM25'</span>)
0102         data.import.fileformat = <span class="string">'pm25'</span>;
0103     <span class="keyword">elseif</span> strcmp(label,<span class="string">'RoCA T1T2'</span>)
0104         data.import.fileformat = <span class="string">'rocaT1T2'</span>;
0105     <span class="keyword">else</span>
0106         helpdlg(<span class="string">'Something is utterly wrong.'</span>,<span class="string">'onMenuImport: Choose again.'</span>);
0107     <span class="keyword">end</span>
0108     
0109     <span class="comment">% remove info field if any</span>
0110     ih = findobj(<span class="string">'Tag'</span>,<span class="string">'inv_info'</span>);
0111     <span class="keyword">if</span> ~isempty(ih); delete(ih); <span class="keyword">end</span>
0112     
0113     <span class="comment">% depending on the import format get the corresponding path / file</span>
0114     [NMRpath,NMRfile] = <a href="#_sub1" class="code" title="subfunction [NMRpath,NMRfile] = getNMRPathFile(label,import)">getNMRPathFile</a>(label,data.import);
0115     
0116     <span class="comment">% only continue if user didn't cancel</span>
0117     <span class="keyword">if</span> sum([NMRpath NMRfile]) &gt; 0
0118         <span class="comment">%  remove old fields and data</span>
0119         data = <a href="cleanupGUIData.html" class="code" title="function data = cleanupGUIData(data)">cleanupGUIData</a>(data);
0120         
0121         <span class="comment">% check for mat-file with GUI rawdata and import data</span>
0122         isfile = dir(fullfile(NMRpath,<span class="string">'NUCLEUSinv_raw.mat'</span>));
0123         
0124         <span class="comment">% if there is no raw-file import from folder/file</span>
0125         <span class="keyword">if</span> isempty(isfile)
0126             <span class="comment">% import data</span>
0127             data.import.path = NMRpath;
0128             data.import.file = -1;
0129             <a href="displayStatusText.html" class="code" title="function displayStatusText(gui,string)">displayStatusText</a>(gui,<span class="string">'Reading NMR Data ...'</span>);
0130             <span class="comment">% call the corresponding subroutines</span>
0131             <span class="keyword">switch</span> label
0132                 <span class="keyword">case</span> {<span class="string">'BAM TOM'</span>,<span class="string">'BGR std'</span>,<span class="string">'CoreLab ascii'</span>,<span class="string">'GGE ascii'</span>,<span class="keyword">...</span>
0133                         <span class="string">'GGE field'</span>}
0134                     [data,gui] = <a href="#_sub12" class="code" title="subfunction [data,gui] = importDataGeneral(data,gui)">importDataGeneral</a>(data,gui);
0135                 <span class="keyword">case</span> <span class="string">'GGE Dart'</span>
0136                     data.import.file = NMRfile;
0137                     <span class="comment">% the data in the example folder is an older type</span>
0138                     <span class="keyword">if</span> contains(NMRpath,<span class="string">'nucleus\example_data\dart'</span>)
0139                         data.import.version = 1;
0140                     <span class="keyword">else</span>
0141                         data.import.version = 2;
0142                     <span class="keyword">end</span>
0143                     [data,gui] = <a href="#_sub10" class="code" title="subfunction [data,gui] = importDataDart(data,gui)">importDataDart</a>(data,gui);
0144                 <span class="keyword">case</span> <span class="string">'DART'</span>
0145                     data.import.file = NMRfile;
0146                     data.import.version = 3;
0147                     [data,gui] = <a href="#_sub10" class="code" title="subfunction [data,gui] = importDataDart(data,gui)">importDataDart</a>(data,gui);
0148                 <span class="keyword">case</span> <span class="string">'DART (+Burst)'</span>
0149                     data.import.file = NMRfile;
0150                     [data,gui] = <a href="#_sub9" class="code" title="subfunction [data,gui] = importDataDartT2logging(data,gui,useburst)">importDataDartT2logging</a>(data,gui,1);    
0151                 <span class="keyword">case</span> <span class="string">'MOUSE'</span>
0152                     [data,gui] = <a href="#_sub16" class="code" title="subfunction [data,gui] = importDataMouse(data,gui)">importDataMouse</a>(data,gui);
0153                 <span class="keyword">case</span> <span class="string">'LIAG single'</span>
0154                     [data,gui] = <a href="#_sub13" class="code" title="subfunction [data,gui] = importDataLIAG(data,gui)">importDataLIAG</a>(data,gui);
0155                 <span class="keyword">case</span> <span class="string">'LIAG core'</span>
0156                     [data,gui] = <a href="#_sub14" class="code" title="subfunction [data,gui] = importDataLIAGcore(data,gui)">importDataLIAGcore</a>(data,gui);    
0157                 <span class="keyword">case</span> {<span class="string">'LIAG from project'</span>,<span class="string">'LIAG last project'</span>}
0158                     [data,gui] = <a href="#_sub15" class="code" title="subfunction [data,gui] = importDataLIAGproject(data,gui)">importDataLIAGproject</a>(data,gui);
0159                     <span class="comment">% make the Petro Panel visible as default</span>
0160                     tmp_h = gui.myui.heights(2,:);
0161                     tmp_h(3) = gui.myui.heights(2,3);
0162                     <span class="comment">% but the CPS panel stays minimized</span>
0163                     tmp_h(5) = gui.myui.heights(1,3);
0164                     set(gui.panels.main,<span class="string">'Heights'</span>,tmp_h);
0165                     set(gui.panels.petro.main,<span class="string">'Minimized'</span>,false);
0166                 <span class="keyword">case</span> <span class="string">'BGR mat'</span>
0167                     data.import.file = NMRfile;
0168                     [data,gui] = <a href="#_sub3" class="code" title="subfunction [data,gui] = importDataBGRmat(data,gui)">importDataBGRmat</a>(data,gui);
0169                 <span class="keyword">case</span> <span class="string">'MouseCPMG'</span>
0170                     [data,gui] = <a href="#_sub2" class="code" title="subfunction [data,gui] = importDataMouseCPMG(data,gui)">importDataMouseCPMG</a>(data,gui);
0171                 <span class="keyword">case</span> <span class="string">'MouseLift'</span>
0172                     [data,gui] = <a href="#_sub5" class="code" title="subfunction [data,gui] = importDataBGRlift(data,gui)">importDataBGRlift</a>(data,gui);
0173                 <span class="keyword">case</span> <span class="string">'HeliosCPMG'</span>
0174                     data.import.file = NMRfile;
0175                     [data,gui] = <a href="#_sub6" class="code" title="subfunction [data,gui] = importDataHeliosCPMG(data,gui)">importDataHeliosCPMG</a>(data,gui);
0176                 <span class="keyword">case</span> <span class="string">'HeliosSeries'</span>
0177                     data.import.file = NMRfile;
0178                     [data,gui] = <a href="#_sub7" class="code" title="subfunction [data,gui] = importDataHeliosSeries(data,gui)">importDataHeliosSeries</a>(data,gui);
0179                 <span class="keyword">case</span> {<span class="string">'PM5'</span>,<span class="string">'PM25'</span>}
0180                     data.import.file = NMRfile;
0181                     [data,gui] = <a href="#_sub17" class="code" title="subfunction [data,gui] = importDataIBAC(data,gui)">importDataIBAC</a>(data,gui);
0182                 <span class="keyword">case</span> <span class="string">'Dart T1T2'</span>
0183                     data.import.file = NMRfile;
0184                     [data,gui] = <a href="#_sub8" class="code" title="subfunction [data,gui] = importDataDartSeries(data,gui)">importDataDartSeries</a>(data,gui);
0185                 <span class="keyword">case</span> <span class="string">'Dart T2 logging'</span>
0186                     data.import.file = NMRfile;
0187                     [data,gui] = <a href="#_sub9" class="code" title="subfunction [data,gui] = importDataDartT2logging(data,gui,useburst)">importDataDartT2logging</a>(data,gui,0);
0188                 <span class="keyword">case</span> <span class="string">'RoCA T1T2'</span>
0189                     data.import.file = NMRfile;
0190                     [data,gui] = <a href="#_sub11" class="code" title="subfunction [data,gui] = importDataRoCAT1T2(data,gui)">importDataRoCAT1T2</a>(data,gui);     
0191             <span class="keyword">end</span>
0192             <a href="displayStatusText.html" class="code" title="function displayStatusText(gui,string)">displayStatusText</a>(gui,<span class="string">'Reading NMR Data ... done'</span>);
0193         <span class="keyword">else</span>
0194             <span class="comment">% import from mat-file</span>
0195             <a href="displayStatusText.html" class="code" title="function displayStatusText(gui,string)">displayStatusText</a>(gui,<span class="string">'Importing NMR raw data from mat-file ...'</span>);
0196             data = <a href="#_sub19" class="code" title="subfunction data = loadGUIrawdata(data,NMRpath,NMRfile)">loadGUIrawdata</a>(data,NMRpath,NMRfile);
0197             <a href="displayStatusText.html" class="code" title="function displayStatusText(gui,string)">displayStatusText</a>(gui,<span class="string">'Importing NMR raw data from mat-file ... done'</span>);
0198         <span class="keyword">end</span>
0199         
0200         <span class="comment">% update the path info field with &quot;NMRpath&quot; (&quot;NMRfile&quot;)</span>
0201         <span class="keyword">if</span> NMRfile &gt; 0
0202             tmpstr = fullfile(NMRpath,NMRfile);
0203         <span class="keyword">else</span>
0204             tmpstr = NMRpath;
0205         <span class="keyword">end</span>
0206         <span class="keyword">if</span> length(tmpstr)&gt;50
0207             set(gui.text_handles.data_path,<span class="string">'String'</span>,[<span class="string">'...'</span>,tmpstr(end-50:end)],<span class="keyword">...</span>
0208                 <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>);
0209         <span class="keyword">else</span>
0210             set(gui.text_handles.data_path,<span class="string">'String'</span>,tmpstr,<span class="keyword">...</span>
0211                 <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>);
0212         <span class="keyword">end</span>
0213         set(gui.text_handles.data_path,<span class="string">'TooltipString'</span>,tmpstr);
0214         
0215         <span class="comment">% update the ini-file</span>
0216         gui.myui.inidata.importpath = data.import.path;
0217         gui = <a href="makeINIfile.html" class="code" title="function gui = makeINIfile(gui,method)">makeINIfile</a>(gui,<span class="string">'update'</span>);
0218         
0219         <span class="comment">% update the list of file names</span>
0220         set(gui.listbox_handles.signal,<span class="string">'String'</span>,data.import.NMR.filesShort);
0221         set(gui.listbox_handles.signal,<span class="string">'Value'</span>,[],<span class="string">'Max'</span>,2,<span class="string">'Min'</span>,0);
0222         
0223         <span class="comment">% create a global INVdata struct for every file in the list</span>
0224         <span class="keyword">if</span> isstruct(getappdata(fig,<span class="string">'INVdata'</span>))
0225             setappdata(fig,<span class="string">'INVdata'</span>,[]);
0226         <span class="keyword">end</span>
0227         INVdata = cell(length(data.import.NMR.filesShort),1);
0228         setappdata(fig,<span class="string">'INVdata'</span>,INVdata);
0229         
0230         <span class="comment">% clear all axes</span>
0231         <a href="clearAllAxes.html" class="code" title="function clearAllAxes(figh)">clearAllAxes</a>(gui.figh);
0232         
0233         <span class="comment">% update GUI data and interface</span>
0234         setappdata(fig,<span class="string">'data'</span>,data);
0235         setappdata(fig,<span class="string">'gui'</span>,gui);
0236         <a href="enableGUIelements.html" class="code" title="function enableGUIelements(importtype)">enableGUIelements</a>(<span class="string">'NMR'</span>);
0237         
0238         <span class="comment">% special treatment of LIAG projects</span>
0239         <span class="keyword">switch</span> label
0240             <span class="keyword">case</span> {<span class="string">'LIAG from project'</span>,<span class="string">'LIAG last project'</span>}
0241                 cpath = data.import.LIAG.calibrationpath;
0242                 <span class="comment">% check if this calibration file was already used</span>
0243                 isfile = dir(fullfile(cpath,<span class="string">'NUCLEUS_calibData.mat'</span>));
0244                 <span class="keyword">if</span> ~isempty(isfile)
0245                     id = 2;
0246                     <span class="comment">% if data is there reuse it</span>
0247                     calib = load(fullfile(cpath,isfile.name),<span class="string">'calib'</span>);
0248                     INVdata{id} = calib.calib;
0249                     data.calib = INVdata{id}.calib;
0250                     data.import.LIAG.Tbulk = INVdata{id}.results.invstd.T2;
0251                     setappdata(fig,<span class="string">'INVdata'</span>,INVdata);
0252                     setappdata(fig,<span class="string">'data'</span>,data);
0253                     <span class="comment">% color the list entry</span>
0254                     strL = get(gui.listbox_handles.signal,<span class="string">'String'</span>);
0255                     str1 = strL{id};
0256                     str2 = [<span class="string">'&lt;HTML&gt;&lt;BODY bgcolor=&quot;rgb('</span>,<span class="keyword">...</span>
0257                         sprintf(<span class="string">'%d,%d,%d'</span>,gui.myui.colors.listINV.*255),<span class="string">')&quot;&gt;'</span>,<span class="keyword">...</span>
0258                         str1,<span class="string">'&lt;/BODY&gt;&lt;/HTML&gt;'</span>];
0259                     strL{id} = str2;
0260                     set(gui.listbox_handles.signal,<span class="string">'String'</span>,strL);
0261                 <span class="keyword">end</span>
0262             <span class="keyword">otherwise</span>
0263         <span class="keyword">end</span>
0264         <span class="comment">% update GUI interface</span>
0265         <a href="../../../nucleus/NUCLEUSinv/NUCLEUSinv_updateInterface.html" class="code" title="function NUCLEUSinv_updateInterface">NUCLEUSinv_updateInterface</a>;
0266     <span class="keyword">end</span>
0267     
0268 <span class="keyword">catch</span> ME
0269     <span class="comment">% show error message in case import fails</span>
0270     errmsg = {ME.message;[ME.stack(1).name,<span class="string">' Line: '</span>,num2str(ME.stack(1).line)];<span class="keyword">...</span>
0271         <span class="string">'Check File Format settings.'</span>};
0272     errordlg(errmsg,<span class="string">'importNMRdata: Error!'</span>);    
0273 <span class="keyword">end</span>
0274 
0275 <span class="keyword">end</span>
0276 
0277 <span class="comment">%%</span>
0278 <a name="_sub1" href="#_subfunctions" class="code">function [NMRpath,NMRfile] = getNMRPathFile(label,import)</a>
0279 
0280 NMRpath = -1;
0281 NMRfile = -1;
0282 <span class="comment">% for almost all import cases we load a folder ... but not for all</span>
0283 <span class="keyword">switch</span> label
0284     <span class="keyword">case</span> {<span class="string">'BAM TOM'</span>,<span class="string">'BGR std'</span>,<span class="string">'CoreLab ascii'</span>,<span class="string">'GGE ascii'</span>,<span class="string">'GGE field'</span>,<span class="keyword">...</span>
0285             <span class="string">'HeliosCPMG'</span>,<span class="string">'HeliosSeries'</span>,<span class="string">'LIAG core'</span>,<span class="string">'LIAG single'</span>,<span class="keyword">...</span>
0286             <span class="string">'MOUSE'</span>,<span class="string">'MouseCPMG'</span>,<span class="string">'MouseLift'</span>,<span class="string">'PM25'</span>,<span class="string">'Dart T1T2'</span>,<span class="string">'Dart T2 logging'</span>,<span class="keyword">...</span>
0287             <span class="string">'DART (+Burst)'</span>,<span class="string">'RoCA T1T2'</span>}
0288         <span class="comment">% if there is already a data folder present we start from here</span>
0289         <span class="keyword">if</span> isfield(import,<span class="string">'path'</span>)
0290             NMRpath = uigetdir(import.path,<span class="string">'Choose Data Path'</span>);
0291         <span class="keyword">else</span>
0292             <span class="comment">% otherwise we start at the current working dircetory</span>
0293             <span class="comment">% 'NMRpath' holds the name of the choosen data path</span>
0294             here = mfilename(<span class="string">'fullpath'</span>);
0295             [pathstr,~,~] = fileparts(here);
0296             NMRpath = uigetdir(pathstr,<span class="string">'Choose Data Path'</span>);
0297         <span class="keyword">end</span>
0298     <span class="keyword">case</span> <span class="string">'LIAG from project'</span>
0299         <span class="comment">% if there is already a data folder present we start from here</span>
0300         <span class="keyword">if</span> isfield(import,<span class="string">'path'</span>)
0301             NMRpath = uigetdir(import.path,<span class="string">'Choose Project Path'</span>);
0302         <span class="keyword">else</span>
0303             <span class="comment">% otherwise we start at the current working dircetory</span>
0304             <span class="comment">% 'NMRpath' holds the name of the choosen data path</span>
0305             here = mfilename(<span class="string">'fullpath'</span>);
0306             [pathstr,~,~] = fileparts(here);
0307             NMRpath = uigetdir(pathstr,<span class="string">'Choose Project Path'</span>);
0308         <span class="keyword">end</span>
0309     <span class="keyword">case</span> <span class="string">'LIAG last project'</span>
0310         <span class="comment">% there is already a data folder and we use this one</span>
0311         <span class="keyword">if</span> isfield(import,<span class="string">'path'</span>)
0312             NMRpath = import.path;
0313         <span class="keyword">else</span>
0314             <span class="comment">% otherwise we start at the current working dircetory</span>
0315             <span class="comment">% 'NMRpath' holds the name of the choosen data path</span>
0316             here = mfilename(<span class="string">'fullpath'</span>);
0317             [pathstr,~,~] = fileparts(here);
0318             NMRpath = uigetdir(pathstr,<span class="string">'Choose Project Path'</span>);
0319         <span class="keyword">end</span>
0320     <span class="keyword">case</span> {<span class="string">'GGE Dart'</span>,<span class="string">'DART'</span>,<span class="string">'BGR mat'</span>,<span class="string">'NMR mat'</span>}
0321         <span class="comment">% if there is already a data folder present we start from here</span>
0322         <span class="keyword">if</span> isfield(import,<span class="string">'path'</span>)
0323             [NMRfile,NMRpath] = uigetfile(import.path,<span class="string">'Choose Data file'</span>);
0324         <span class="keyword">else</span>
0325             <span class="comment">% otherwise we start at the current working dircetory</span>
0326             <span class="comment">% 'foldername' hold s the name of the choosen data path</span>
0327             here = mfilename(<span class="string">'fullpath'</span>);
0328             [pathstr,~,~] = fileparts(here);
0329             [NMRfile,NMRpath] = uigetfile(pathstr,<span class="string">'Choose Data file'</span>);
0330         <span class="keyword">end</span>
0331     <span class="keyword">case</span> <span class="string">'PM5'</span>
0332         <span class="comment">% if there is already a data folder present we start from here</span>
0333         <span class="keyword">if</span> isfield(import,<span class="string">'path'</span>)
0334             NMRpath = uigetdir(import.path,<span class="string">'Choose PM5 Data Path'</span>);
0335         <span class="keyword">else</span>
0336             <span class="comment">% otherwise we start at the current working dircetory</span>
0337             <span class="comment">% 'NMRpath' holds the name of the choosen data path</span>
0338             here = mfilename(<span class="string">'fullpath'</span>);
0339             [pathstr,~,~] = fileparts(here);
0340             NMRpath = uigetdir(pathstr,<span class="string">'Choose PM5 Data Path'</span>);
0341         <span class="keyword">end</span>
0342         
0343         <span class="comment">% check if there are multiple inf-files available</span>
0344         <span class="comment">% if yes -&gt; choose one</span>
0345         inffiles = dir(fullfile(NMRpath,<span class="string">'*.inf'</span>));
0346         <span class="keyword">if</span> numel(inffiles) &gt; 1
0347             [NMRfile,NMRpath] = uigetfile(fullfile(NMRpath,<span class="string">'*.inf'</span>),<span class="keyword">...</span>
0348                 <span class="string">'Choose INF file'</span>);
0349         <span class="keyword">elseif</span> numel(inffiles) == 1
0350             NMRfile = inffiles.name;            
0351         <span class="keyword">end</span>
0352 <span class="keyword">end</span>
0353 
0354 <span class="keyword">end</span>
0355 
0356 <span class="comment">%%</span>
0357 <a name="_sub2" href="#_subfunctions" class="code">function [data,gui] = importDataMouseCPMG(data,gui)</a>
0358 
0359 csv_t2path = dir(fullfile(data.import.path,<span class="string">'CPMG'</span>));
0360 csv_t2path = csv_t2path(~ismember({csv_t2path.name},{<span class="string">'.'</span>,<span class="string">'..'</span>}));
0361 
0362 fnames = struct;
0363 <span class="comment">% shownames is just a dummy to hold all data file names that</span>
0364 <span class="comment">% will be shown in the listbox</span>
0365 shownames = cell(1,1);
0366 
0367 c = 0;
0368 <span class="keyword">if</span> ~isempty(csv_t2path)
0369     <span class="keyword">for</span> i = 1:size(csv_t2path,1)
0370         in.T1T2 = <span class="string">'T2'</span>;
0371         in.path = fullfile(data.import.path,<span class="string">'CPMG'</span>,csv_t2path(i).name);
0372         in.fileformat = data.import.fileformat;
0373         out = <a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>(in);
0374         
0375         <span class="keyword">for</span> j = 1:size(out.nmrData,2)
0376             <span class="comment">% the individual file names</span>
0377             c = c + 1;
0378             fnames(c).parfile = <span class="string">'acqu.par'</span>;
0379             fnames(c).datafile = out.nmrData{j}.datfile;
0380             fnames(c).T2specfile = <span class="string">''</span>;
0381             
0382             shownames{c} = [<span class="string">'T2_'</span>,csv_t2path(i).name,<span class="string">'_'</span>,fnames(c).datafile];
0383             
0384             <span class="comment">% the NMR data</span>
0385             <span class="comment">% here we fix the time scale from [ms] to [s]</span>
0386             <span class="keyword">if</span> max(out.nmrData{j}.time) &gt; 100
0387                 out.nmrData{j}.time = out.nmrData{j}.time/1000;
0388                 out.nmrData{j}.raw.time = out.nmrData{j}.raw.time/1000;
0389             <span class="keyword">end</span>
0390             data.import.NMR.data{c} = out.nmrData{j};
0391             data.import.NMR.para{c} = out.parData;
0392         <span class="keyword">end</span>
0393     <span class="keyword">end</span>
0394 <span class="keyword">end</span>
0395 
0396 <span class="keyword">if</span> isempty(csv_t2path)
0397     helpdlg(<span class="string">'No data folders in the given directory.'</span>,<span class="string">'onMenuImport: No data.'</span>);
0398 <span class="keyword">else</span>
0399     <span class="comment">% update the global data structure</span>
0400     data.import.NMR.files = fnames;
0401     data.import.NMR.filesShort = shownames;
0402 <span class="keyword">end</span>
0403 
0404 <span class="keyword">end</span>
0405 
0406 <span class="comment">%%</span>
0407 <a name="_sub3" href="#_subfunctions" class="code">function [data,gui] = importDataBGRmat(data,gui)</a>
0408 
0409 in.path = fullfile(data.import.path);
0410 in.name = data.import.file;
0411 in.fileformat = data.import.fileformat;
0412 out = <a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>(in);
0413 
0414 fnames = struct;
0415 <span class="comment">% shownames is just a dummy to hold all data file names that</span>
0416 <span class="comment">% will be shown in the listbox</span>
0417 shownames = cell(1,1);
0418 
0419 c = 0;
0420 table = {true,0,1,<span class="string">'D'</span>};
0421 <span class="keyword">for</span> j = 1:size(out.nmrData,2)
0422     <span class="comment">% the individual file names</span>
0423     c = c + 1;
0424     fnames(c).parfile = <span class="string">''</span>;
0425     fnames(c).datafile = data.import.file;
0426     fnames(c).T2specfile = <span class="string">''</span>;
0427     
0428     shownames{c} = out.parData{j}.file;
0429     
0430     data.import.NMR.data{c} = out.nmrData{j};
0431     data.import.NMR.para{c} = out.parData{j};
0432     
0433     <span class="keyword">if</span> isfield(out,<span class="string">'pressData'</span>)
0434         <span class="comment">% convert hPa to Pa</span>
0435         table{c,1} = true;
0436         table{c,2} = out.pressData.p(j)*1e2;
0437         table{c,3} = out.pressData.S(j);
0438         table{c,4} = <span class="string">'D'</span>;
0439     <span class="keyword">end</span>
0440 <span class="keyword">end</span>
0441 
0442 <span class="comment">% global Tbulk</span>
0443 data.invstd.Tbulk = out.parData{1}.Tbulk;
0444 <span class="comment">% global porosity</span>
0445 data.import.BGR.porosity = out.parData{1}.porosity;
0446 
0447 data.import.NMR.files = fnames;
0448 data.import.NMR.filesShort = shownames;
0449 
0450 <span class="comment">% import pressure / saturation data</span>
0451 <span class="keyword">if</span> isfield(out,<span class="string">'pressData'</span>)
0452     data.pressure.unit = <span class="string">'kPa'</span>;
0453     data.pressure.unitfac = 1e-3;
0454     data.pressure.table = table;
0455 <span class="keyword">end</span>
0456 
0457 <span class="keyword">end</span>
0458 
0459 <span class="comment">%%</span>
0460 <a name="_sub4" href="#_subfunctions" class="code">function [data,gui] = importDataBGRliftSingle(data,gui)</a>
0461 
0462 <span class="comment">% first check whether T1 or T2 was measured...</span>
0463 <span class="comment">% by analyzing the name of data folder</span>
0464 ind = find(data.import.path == filesep);
0465 checkT1T2 = data.import.path(ind(end-1)+1:ind(end)-1);
0466 <span class="keyword">if</span> strcmp(checkT1T2,<span class="string">'t1test'</span>)
0467     in.T1T2 = <span class="string">'T1'</span>;
0468 <span class="keyword">elseif</span> strcmp(checkT1T2,<span class="string">'T1auto'</span>)
0469     in.T1T2 = <span class="string">'T1'</span>; 
0470 <span class="keyword">elseif</span> strcmp(checkT1T2,<span class="string">'cpmgfastautotest'</span>)
0471     in.T1T2 = <span class="string">'T2'</span>; 
0472 <span class="keyword">elseif</span> strcmp(checkT1T2,<span class="string">'cpmgfastauto'</span>)
0473     in.T1T2 = <span class="string">'T2'</span>; 
0474 <span class="keyword">else</span>
0475     disp(<span class="string">'Please chose an original Prospa folder for Mouse Lift data!'</span>);
0476 <span class="keyword">end</span>
0477 
0478 <span class="comment">% % there should be folders with integer values in their names</span>
0479 <span class="comment">% t1t2path = data.import.path;</span>
0480 
0481 fnames = struct;
0482 <span class="comment">% shownames is just a dummy to hold all data file names that</span>
0483 <span class="comment">% will be shown in the listbox</span>
0484 shownames = cell(1,1);
0485 
0486 c = 0;
0487 <span class="keyword">if</span> ~isempty(data.import.path)
0488 <span class="comment">%    for i = 1:size(t1t2path,1)</span>
0489         in.path = data.import.path;
0490         in.fileformat = data.import.fileformat;
0491         out = <a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>(in);
0492         
0493         <span class="keyword">for</span> j = 1:size(out.nmrData,2)
0494             <span class="comment">% the individual file names</span>
0495             c = c + 1;
0496             fnames(c).parfile = <span class="string">'acq.par'</span>;
0497             fnames(c).datafile = out.nmrData{j}.datfile;
0498             
0499             shownames{c} = [in.T1T2,<span class="string">'_'</span>,fnames(c).datafile];
0500             
0501             <span class="comment">% the NMR data</span>
0502             <span class="comment">% here we fix the time scale from [ms] to [s]</span>
0503             <span class="keyword">if</span> max(out.nmrData{j}.time) &gt; 100
0504                 out.nmrData{j}.time = out.nmrData{j}.time/1000;
0505                 out.nmrData{j}.raw.time = out.nmrData{j}.raw.time/1000;
0506             <span class="keyword">end</span>
0507             data.import.NMR.data{c} = out.nmrData{j};
0508             data.import.NMR.para{c} = out.parData;
0509         <span class="keyword">end</span>
0510 <span class="keyword">else</span>
0511     helpdlg(<span class="string">'No data folders in the given directory.'</span>,<span class="string">'onMenuImport: No data.'</span>);
0512 <span class="keyword">end</span>
0513 
0514 <span class="comment">% update the global data structure</span>
0515 data.import.NMR.files = fnames;
0516 data.import.NMR.filesShort = shownames;
0517 
0518 <span class="keyword">end</span>
0519 
0520 <span class="comment">%%</span>
0521 <a name="_sub5" href="#_subfunctions" class="code">function [data,gui] = importDataBGRlift(data,gui)</a>
0522 
0523 <span class="comment">% 1) show all folders and ask for sample</span>
0524 subdirs = dir(data.import.path);
0525 <span class="comment">% remove the dot-dirs</span>
0526 subdirs = subdirs(~ismember({subdirs.name},{<span class="string">'.'</span>,<span class="string">'..'</span>}));
0527 
0528 fnames = {subdirs.name};
0529 [indx,~] = listdlg(<span class="string">'PromptString'</span>,<span class="string">'Choose data set:'</span>,<span class="keyword">...</span>
0530     <span class="string">'SelectionMode'</span>,<span class="string">'multiple'</span>,<span class="keyword">...</span>
0531     <span class="string">'ListString'</span>,fnames);
0532 
0533 <span class="comment">% first check whether T1 or T2 was measured</span>
0534 ind = find(data.import.path == filesep);
0535 checkT1T2 = data.import.path(ind(end)+1:end);
0536 <span class="keyword">if</span> strcmp(checkT1T2,<span class="string">'t1test'</span>)
0537     in.T1T2 = <span class="string">'T1'</span>;
0538 <span class="keyword">elseif</span> strcmp(checkT1T2,<span class="string">'T1auto'</span>)
0539     in.T1T2 = <span class="string">'T1'</span>; 
0540 <span class="keyword">elseif</span> strcmp(checkT1T2,<span class="string">'cpmgfastautotest'</span>)
0541     in.T1T2 = <span class="string">'T2'</span>; 
0542 <span class="keyword">elseif</span> strcmp(checkT1T2,<span class="string">'cpmgfastauto'</span>)
0543     in.T1T2 = <span class="string">'T2'</span>; 
0544 <span class="keyword">else</span>
0545     helpdlg(<span class="string">'No original data folder'</span>,<span class="string">'onMenuImport: No data.'</span>);
0546 <span class="keyword">end</span>
0547 
0548 <span class="comment">% now ask for stacking</span>
0549 answer = questdlg(<span class="string">'Do you want to stack the slices?'</span>);
0550 <span class="keyword">switch</span> answer
0551     <span class="keyword">case</span> <span class="string">'Yes'</span>
0552         doSliceStack = true;
0553         <span class="comment">% if stacking ask for stack-rotate-order</span>
0554         answer = questdlg(<span class="string">'Select stack-rotate-order:'</span>,<span class="keyword">...</span>
0555             <span class="string">'Select order'</span>, <span class="keyword">...</span>
0556             <span class="string">'stack-rotate (default)'</span>,<span class="string">'rotate-stack'</span>,<span class="string">'Cancel'</span>,<span class="string">'stack-rotate (default)'</span>);
0557         <span class="keyword">switch</span> answer
0558             <span class="keyword">case</span> <span class="string">'stack-rotate'</span>
0559                 StackFirst = true;
0560             <span class="keyword">case</span> <span class="string">'rotate-stack'</span>
0561                 StackFirst = false;
0562             <span class="keyword">otherwise</span>
0563                 StackFirst = true;
0564         <span class="keyword">end</span>
0565     <span class="keyword">otherwise</span>
0566         doSliceStack = false;
0567 <span class="keyword">end</span>
0568 
0569 fnames = struct;
0570 <span class="comment">% shownames is just a dummy to hold all data file names that</span>
0571 <span class="comment">% will be shown in the listbox</span>
0572 shownames = cell(1,1);
0573 
0574 c = 0;
0575 <span class="keyword">if</span> ~isempty(indx)
0576     <span class="keyword">for</span> i = indx
0577         in.path = fullfile(data.import.path,subdirs(i).name);
0578         in.fileformat = data.import.fileformat;
0579         out = <a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>(in);
0580 
0581         <span class="keyword">if</span> doSliceStack
0582             <span class="comment">% the individual file names</span>
0583             c = c + 1;
0584             fnames(c).parfile = <span class="string">'acq.par'</span>;
0585             fnames(c).datafile = out.nmrData{1}.datfile;
0586 
0587             shownames{c} = [in.T1T2,<span class="string">'_'</span>,subdirs(i).name];
0588 
0589             <span class="comment">% use the meta data from the first slice</span>
0590             <span class="comment">% fix the time scale from [ms] to [s]</span>
0591             <span class="keyword">if</span> max(out.nmrData{1}.time) &gt; 100
0592                 out.nmrData{1}.time = out.nmrData{1}.time/1000;
0593                 out.nmrData{1}.raw.time = out.nmrData{1}.raw.time/1000;
0594             <span class="keyword">end</span>
0595             <span class="comment">% import into GUI data struct</span>
0596             data.import.NMR.data{c} = out.nmrData{1};
0597 
0598             <span class="comment">% stacking</span>
0599             <span class="keyword">for</span> j = 1:size(out.nmrData,2)
0600                 <span class="keyword">if</span> j == 1
0601                     signal = out.nmrData{j}.signal;
0602                 <span class="keyword">else</span>
0603                     signal = signal + out.nmrData{j}.signal;
0604                 <span class="keyword">end</span>
0605             <span class="keyword">end</span>
0606             signal = signal./size(out.nmrData,2);
0607 
0608             <span class="comment">% now rotate after the stacking</span>
0609             <span class="keyword">if</span> StackFirst
0610                 [signal,phase] = <a href="../../../nucleus/functions/import/rotateT2phase.html" class="code" title="function [s_rot,alpha] = rotateT2phase(s,varargin)">rotateT2phase</a>(signal);
0611                 data.import.NMR.data{c}.phase = phase;
0612                 data.import.NMR.data{c}.signal = signal;
0613                 data.import.NMR.data{c}.raw.signal = signal;
0614             <span class="keyword">else</span>
0615                 <span class="comment">% no rotation after stacking</span>
0616                 data.import.NMR.data{c}.signal = signal;
0617                 data.import.NMR.data{c}.raw.signal = signal;
0618             <span class="keyword">end</span>
0619             
0620             <span class="comment">% parameter data</span>
0621             data.import.NMR.para{c} = out.parData;
0622         <span class="keyword">else</span>
0623 
0624             <span class="keyword">for</span> j = 1:size(out.nmrData,2)
0625                 <span class="comment">% the individual file names</span>
0626                 c = c + 1;
0627                 fnames(c).parfile = <span class="string">'acq.par'</span>;
0628                 fnames(c).datafile = out.nmrData{j}.datfile;
0629 
0630                 shownames{c} = [in.T1T2,<span class="string">'_'</span>,subdirs(i).name,<span class="string">'_'</span>,fnames(c).datafile];
0631 
0632                 <span class="comment">% the NMR data</span>
0633                 <span class="comment">% here we fix the time scale from [ms] to [s]</span>
0634                 <span class="keyword">if</span> max(out.nmrData{j}.time) &gt; 100
0635                     out.nmrData{j}.time = out.nmrData{j}.time/1000;
0636                     out.nmrData{j}.raw.time = out.nmrData{j}.raw.time/1000;
0637                 <span class="keyword">end</span>
0638                 data.import.NMR.data{c} = out.nmrData{j};
0639                 data.import.NMR.para{c} = out.parData;
0640             <span class="keyword">end</span>
0641         <span class="keyword">end</span>
0642     <span class="keyword">end</span>
0643 <span class="keyword">else</span>
0644     helpdlg(<span class="string">'No data folders in the given directory.'</span>,<span class="string">'onMenuImport: No data.'</span>);
0645 <span class="keyword">end</span>
0646 
0647 <span class="comment">% update the global data structure</span>
0648 data.import.NMR.files = fnames;
0649 data.import.NMR.filesShort = shownames;
0650 
0651 <span class="keyword">end</span>
0652 
0653 <span class="comment">%%</span>
0654 <a name="_sub6" href="#_subfunctions" class="code">function [data,gui] = importDataHeliosCPMG(data,gui)</a>
0655 
0656 <span class="comment">% first check the subpaths</span>
0657 <span class="comment">% there should be some folders with names ...</span>
0658 <span class="comment">% ... similar to the data filenames inside them</span>
0659 datpath = dir(data.import.path);
0660 datpath = datpath(~ismember({datpath.name},{<span class="string">'.'</span>,<span class="string">'..'</span>}));
0661 
0662 fnames = struct;
0663 <span class="comment">% shownames is just a dummy to hold all data file names that</span>
0664 <span class="comment">% will be shown in the listbox</span>
0665 shownames = cell(1,1);
0666 
0667 c = 0;
0668 <span class="keyword">if</span> ~isempty(datpath)
0669     <span class="keyword">for</span> i = 1:size(datpath,1)
0670         <span class="comment">% does datpath.name points to a folder?</span>
0671         <span class="keyword">if</span> datpath(i).isdir    
0672             <span class="comment">% check if datpath.name includes regular Helios data files</span>
0673             content = dir([data.import.path,filesep,datpath(i).name]);
0674             content = content(~ismember({content.name},{<span class="string">'.'</span>,<span class="string">'..'</span>}));
0675             <span class="comment">% only keep hrd-files</span>
0676             content = content(contains({content.name},<span class="string">'.hrd'</span>));
0677             <span class="comment">% remove reference hrd-files</span>
0678             content = content(~contains({content.name},<span class="string">'_ref.hrd'</span>));
0679             <span class="keyword">for</span> j = 1:size(content,1)
0680                 in.T1T2 = <span class="string">'T2'</span>;
0681                 in.name = content(j).name;
0682                 in.path = fullfile(data.import.path,filesep,datpath(i).name);
0683                 in.fileformat = data.import.fileformat;
0684                 out = <a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>(in);
0685 
0686                 <span class="comment">% the individual file names</span>
0687                 c = c + 1;
0688                 fnames(c).parfile = <span class="string">''</span>;
0689                 fnames(c).datafile = out.nmrData.datfile;
0690                 fnames(c).T2specfile = <span class="string">''</span>;
0691                 shownames{c} = [<span class="string">'T2_'</span>,datpath(i).name];
0692 
0693                 data.import.NMR.data{c} = out.nmrData;
0694                 data.import.NMR.para{c} = out.parData;
0695             <span class="keyword">end</span>
0696         <span class="keyword">end</span>
0697     <span class="keyword">end</span>
0698 <span class="keyword">end</span>
0699 
0700 <span class="comment">% update the global data structure</span>
0701 data.import.NMR.files = fnames;
0702 data.import.NMR.filesShort = shownames;
0703 
0704 <span class="keyword">end</span>
0705 
0706 <span class="comment">%%</span>
0707 <a name="_sub7" href="#_subfunctions" class="code">function [data,gui] = importDataHeliosSeries(data,gui)</a>
0708 
0709 <span class="comment">% first ask the user if it is pure T2 data or T2 data belonging to a T1</span>
0710 <span class="comment">% measurement to generate T1-T2 maps</span>
0711 answer = questdlg(<span class="string">'Is this series a T1 measurement or pure T2?'</span>, <span class="keyword">...</span>
0712     <span class="string">'HELIOS import'</span>, <span class="keyword">...</span>
0713     <span class="string">'T1'</span>,<span class="string">'T2'</span>,<span class="string">'T2'</span>);
0714 <span class="keyword">switch</span> answer
0715     <span class="keyword">case</span> <span class="string">'T1'</span>
0716         is_T1 = true;
0717     <span class="keyword">case</span> <span class="string">'T2'</span>
0718         is_T1 = false;
0719     <span class="keyword">otherwise</span>
0720         is_T1 = false;
0721 <span class="keyword">end</span>
0722 
0723 <span class="comment">% now ask for manualS stacking (only for T2 data)</span>
0724 <span class="keyword">if</span> ~is_T1
0725     answer = questdlg(<span class="string">'Do you want to stack several files?'</span>,<span class="string">'Stack Dialog'</span>,<span class="string">'No'</span>);
0726     <span class="keyword">switch</span> answer
0727         <span class="keyword">case</span> <span class="string">'Yes'</span>
0728             doStack = true;
0729             prompt = {<span class="string">'Enter No. of files to stack together'</span>};
0730             dlgtitle = <span class="string">'Stack Value'</span>;
0731             fieldsize = [1 40];
0732             definput = {<span class="string">'16'</span>};
0733             answer2 = inputdlg(prompt,dlgtitle,fieldsize,definput);
0734             <span class="keyword">if</span> ~isempty(answer2)
0735                 nstacks = str2double(answer2{1,1});
0736             <span class="keyword">else</span>
0737                 doStack = false;
0738             <span class="keyword">end</span>
0739         <span class="keyword">otherwise</span>
0740             doStack = false;
0741     <span class="keyword">end</span>
0742 <span class="keyword">end</span>
0743 
0744 <span class="comment">% now check the subpaths</span>
0745 <span class="comment">% there should be some folders with names ...</span>
0746 <span class="comment">% ... similar to the data filenames inside them</span>
0747 datpath = dir(data.import.path);
0748 datpath = datpath(~ismember({datpath.name},{<span class="string">'.'</span>,<span class="string">'..'</span>}));
0749 <span class="comment">% remove any subfolder within the data directory</span>
0750 datpath = datpath(~ismember([datpath.isdir],true));
0751 <span class="comment">% only keep hrd-files</span>
0752 datpath = datpath(contains({datpath.name},<span class="string">'.hrd'</span>));
0753 <span class="comment">% remove reference hrd-files</span>
0754 datpath = datpath(~contains({datpath.name},<span class="string">'_ref.hrd'</span>));
0755 
0756 fnames = struct;
0757 <span class="comment">% shownames is just a dummy to hold all data file names that</span>
0758 <span class="comment">% will be shown in the listbox</span>
0759 shownames = cell(1,1);
0760 
0761 c = 0;
0762 <span class="keyword">if</span> ~isempty(datpath)
0763     content = datpath;
0764     <span class="keyword">if</span> is_T1
0765         t_recov = zeros(floor(numel(content)/2),2);
0766     <span class="keyword">end</span>
0767     <span class="keyword">for</span> j = 1:size(content,1)
0768         in.T1T2 = <span class="string">'T2'</span>;
0769         in.name = content(j).name;
0770         in.path = fullfile(data.import.path);
0771         in.fileformat = data.import.fileformat;
0772         out = <a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>(in);
0773         <span class="comment">% the individual file names</span>
0774         c = c + 1;
0775         fnames(c).parfile = <span class="string">''</span>;
0776         fnames(c).datafile = out.nmrData.datfile;
0777         fnames(c).T2specfile = <span class="string">''</span>;
0778         <span class="keyword">if</span> is_T1
0779             shownames{c} = content(j).name;
0780         <span class="keyword">else</span>
0781             shownames{c} = [<span class="string">'T2_'</span>,content(j).name];
0782         <span class="keyword">end</span>
0783 
0784         data.import.NMR.data{c} = out.nmrData;
0785         data.import.NMR.para{c} = out.parData;
0786 
0787         <span class="comment">% collect recovery times in case of T1 data set</span>
0788         <span class="keyword">if</span> is_T1
0789             t_recov(c,1) = out.parData.t_recov;
0790             t_recov(c,2) = out.nmrData.phase;
0791         <span class="keyword">end</span>
0792     <span class="keyword">end</span>
0793     
0794     <span class="comment">% in case of T1 data, use the phase of the signal with the longest</span>
0795     <span class="comment">% recovery time to rotate the other signals</span>
0796     <span class="keyword">if</span> is_T1
0797         phase = t_recov(t_recov(:,1)==max(t_recov(:,1)),2);
0798         <span class="keyword">for</span> i1 = 1:numel(data.import.NMR.data)
0799             <span class="comment">% the original raw data</span>
0800             s = data.import.NMR.data{i1}.raw.signal;
0801             s =  s * exp(1i*(-data.import.NMR.data{i1}.phase));
0802             <span class="comment">% s_rot is the rotated signal</span>
0803             s_rot = s .* exp(1i*phase);
0804             <span class="comment">% write the rotated signal back to the data struct</span>
0805             data.import.NMR.data{i1}.signal = s_rot;
0806             data.import.NMR.data{i1}.phase = phase;
0807 
0808             <span class="comment">% get the shortest T2 signal length</span>
0809             <span class="keyword">if</span> i1 == 1
0810                 t2N = numel(data.import.NMR.data{i1}.raw.time);
0811             <span class="keyword">else</span>
0812                 t2N = min([t2N numel(data.import.NMR.data{i1}.raw.time)]);
0813             <span class="keyword">end</span>
0814             t2 = data.import.NMR.data{i1}.raw.time(1:t2N);
0815         <span class="keyword">end</span>
0816 
0817         <span class="comment">% for convenience, sort the data by recovery time</span>
0818         [t_s,ix] = sort(t_recov(:,1));
0819         data.import.NMR.data = data.import.NMR.data(ix);
0820         data.import.NMR.para = data.import.NMR.para(ix);
0821         fnames = fnames(ix);
0822         shownames = shownames(ix);
0823 
0824         <span class="comment">% save the recovery time vector for later use</span>
0825         data.import.T1T2map.t_recov = t_s(:,1)/1000;
0826         data.import.T1T2map.t2 = t2;
0827         data.import.T1T2map.t2N = t2N;
0828 
0829         <span class="comment">% ask if the single measurements should be &quot;stacked&quot; to one T1</span>
0830         <span class="comment">% curve</span>
0831         answer = questdlg(<span class="string">'Do you want a single T1 curve or T1-T2 2D Inversion?'</span>, <span class="keyword">...</span>
0832             <span class="string">'HELIOS import'</span>, <span class="keyword">...</span>
0833             <span class="string">'single T1'</span>,<span class="string">'2D Inv'</span>,<span class="string">'2D Inv'</span>);
0834         <span class="keyword">switch</span> answer
0835             <span class="keyword">case</span> <span class="string">'single T1'</span>
0836                 singleT1 = true;
0837             <span class="keyword">case</span> <span class="string">'2D Inv'</span>
0838                 singleT1 = false;
0839         <span class="keyword">end</span>
0840         
0841         <span class="keyword">if</span> singleT1
0842             <span class="comment">% ask how many T2-echos should be stacked together to one T1</span>
0843             <span class="comment">% point</span>
0844             prompt = {<span class="string">'Enter T2 #echos for one T1 point'</span>};
0845             dlgtitle = <span class="string">'How many T2 echos'</span>;
0846             fieldsize = [1 45];
0847             definput = {<span class="string">'3'</span>};
0848             answer = inputdlg(prompt,dlgtitle,fieldsize,definput);
0849             Nechos = str2double(answer{1});
0850             
0851             flag = <span class="string">'T1'</span>;
0852             time = data.import.T1T2map.t_recov;
0853             signal = zeros(numel(data.import.NMR.data),1);
0854             <span class="keyword">for</span> i1 = 1:numel(data.import.NMR.data)
0855                 signal(i1) = mean(real(data.import.NMR.data{i1}.signal(1:Nechos)));
0856             <span class="keyword">end</span>
0857 
0858             disp(<span class="string">'NUCLUESinv import: Estimating noise from exponential fit ...'</span>);
0859             param.T1IRfac = 2;
0860             param.noise = 0;
0861             param.optim = <span class="string">'off'</span>;
0862             param.Tfixed_bool = [0 0 0 0 0];
0863             param.Tfixed_val = [0 0 0 0 0];
0864             <span class="keyword">for</span> i1 = 1:5
0865                 invstd = <a href="../../../nucleus/functions/inversion/fitDataFree.html" class="code" title="function [fitdata] = fitDataFree(time,signal,flag,parameter,nExp)">fitDataFree</a>(time,signal,flag,param,i1);
0866                 <span class="keyword">if</span> i1 == 1
0867                     noise = invstd.rms;
0868                 <span class="keyword">else</span>
0869                     noise = min([noise invstd.rms]);
0870                 <span class="keyword">end</span>
0871             <span class="keyword">end</span>
0872             disp(<span class="string">'NUCLUESinv import: done.'</span>)
0873             
0874             <span class="comment">% finally create a new &quot;import&quot; data set</span>
0875             data_new = data.import.NMR.data(1);
0876             para_new = data.import.NMR.para(1);
0877             data.import = rmfield(data.import,<span class="string">'T1T2map'</span>);
0878 
0879             data_new{1}.flag = flag;
0880             data_new{1}.T1IRfac = param.T1IRfac;
0881             data_new{1}.time = time;
0882             data_new{1}.signal = signal;
0883             data_new{1}.noise = noise;
0884             data_new{1}.raw.time = time;
0885             data_new{1}.raw.signal = signal;            
0886 
0887             fnames = fnames(1);
0888             shownames = shownames(1);
0889 
0890             data.import.NMR.data = data_new;
0891             data.import.NMR.para = para_new;
0892         <span class="keyword">else</span>
0893             prompt = {<span class="string">'Enter T2 #echos for one T1 point for the merged T1 curve'</span>};
0894             dlgtitle = <span class="string">'How many T2 echos'</span>;
0895             fieldsize = [1 45];
0896             definput = {<span class="string">'3'</span>};
0897             answer = inputdlg(prompt,dlgtitle,fieldsize,definput);
0898             Nechos = str2double(answer{1});
0899 
0900             <span class="comment">% add the stacked signal to the data</span>
0901             flag = <span class="string">'T1'</span>;
0902             time = data.import.T1T2map.t_recov;
0903             signal = zeros(numel(data.import.NMR.data),1);
0904             <span class="keyword">for</span> i1 = 1:numel(data.import.NMR.data)
0905                 signal(i1) = mean(real(data.import.NMR.data{i1}.signal(1:Nechos)));
0906             <span class="keyword">end</span>
0907             
0908             disp(<span class="string">'NUCLUESinv import: Estimating noise from exponential fit ...'</span>);
0909             param.T1IRfac = 2;
0910             param.noise = 0;
0911             param.optim = <span class="string">'off'</span>;
0912             param.Tfixed_bool = [0 0 0 0 0];
0913             param.Tfixed_val = [0 0 0 0 0];
0914             <span class="keyword">for</span> i1 = 1:5
0915                 invstd = <a href="../../../nucleus/functions/inversion/fitDataFree.html" class="code" title="function [fitdata] = fitDataFree(time,signal,flag,parameter,nExp)">fitDataFree</a>(time,signal,flag,param,i1);
0916                 <span class="keyword">if</span> i1 == 1
0917                     noise = invstd.rms;
0918                 <span class="keyword">else</span>
0919                     noise = min([noise invstd.rms]);
0920                 <span class="keyword">end</span>
0921             <span class="keyword">end</span>
0922             disp(<span class="string">'NUCLUESinv import: done.'</span>)
0923 
0924             <span class="comment">% finally create a new &quot;import&quot; data set</span>
0925             data_new = data.import.NMR.data(1);
0926             para_new = data.import.NMR.para(1);
0927 
0928             data_new{1}.flag = flag;
0929             data_new{1}.T1IRfac = param.T1IRfac;
0930             data_new{1}.time = time;
0931             data_new{1}.signal = signal;
0932             data_new{1}.noise = noise;
0933             data_new{1}.raw.time = time;
0934             data_new{1}.raw.signal = signal;
0935 
0936             data.import.NMR.data{numel(t_s)+1} = data_new{1};
0937             data.import.NMR.para{numel(t_s)+1} = para_new{1};
0938             fnames(numel(t_s)+1).datafile = <span class="string">'T1_merged.dat'</span>;
0939             shownames{numel(t_s)+1} = <span class="string">'T1_merged'</span>;
0940             <span class="comment">% set global echo time</span>
0941             data.inv2D.prop.te = data.import.NMR.para{1}.t_echo;
0942             <span class="comment">% set T1 SR/IR factor</span>
0943             data.inv2D.inv.T1IRfac = 2; <span class="comment">% Helios default</span>
0944         <span class="keyword">end</span>
0945     <span class="keyword">else</span> <span class="comment">% pure T2 data</span>
0946         <span class="comment">% do restacking if desired</span>
0947         <span class="keyword">if</span> doStack
0948             <span class="comment">% before stacking, sort the data by date (time)</span>
0949             N = length(shownames);
0950             time = zeros(N,1);
0951             <span class="keyword">for</span> i = 1:N
0952                 time(i,1) = data.import.NMR.data{i}.datenum;
0953             <span class="keyword">end</span>
0954             [~,ix] = sort(time);
0955             <span class="comment">% now apply changes - resort the imported data</span>
0956             data.import.NMR.data = {data.import.NMR.data{ix'}}; <span class="comment">%#ok&lt;*CCAT1&gt;</span>
0957             data.import.NMR.para = {data.import.NMR.para{ix'}};
0958             fnames = fnames(ix);
0959             shownames = {shownames{ix'}};
0960 
0961             c = 0;
0962             <span class="comment">% prepare data variables</span>
0963             datanew = cell(1,1);
0964             paranew = cell(1,1);
0965             fnamesnew = fnames(1);
0966             shownamesnew = cell(1,1);
0967             tmp_signal = zeros(size(data.import.NMR.data{1}.signal));
0968             <span class="comment">% loop over all already imported files</span>
0969             <span class="keyword">for</span> i1 = 1:numel(fnames)
0970                 <span class="comment">% stack up files</span>
0971                 tmp_signal = tmp_signal + data.import.NMR.data{i1}.signal;
0972                 <span class="comment">% check if stack count is reached</span>
0973                 <span class="keyword">if</span> mod(i1,nstacks)==0                   
0974                     <span class="comment">% current stack has finished</span>
0975                     c = c + 1;
0976                     <span class="comment">% save data</span>
0977                     datanew{c} = data.import.NMR.data{i1};
0978                     datanew{c}.signal = tmp_signal./nstacks;
0979                     datanew{c}.raw.signal = tmp_signal./nstacks;
0980 
0981                     paranew{c} = data.import.NMR.para{i1};
0982                     paranew{c}.Nscans = paranew{c}.Nscans*nstacks;
0983                     paranew{c}.all{1,1}{6} = [<span class="string">'Nscans = '</span>,num2str(paranew{c}.Nscans)];
0984 
0985                     fnamesnew(c) = fnames(i1);
0986                     shownamesnew{c} = [shownames{i1},<span class="string">'_'</span>,num2str(nstacks)];
0987                     
0988                     <span class="comment">% reset the tmp_signal to zero</span>
0989                     tmp_signal = zeros(size(data.import.NMR.data{1}.signal));
0990                 <span class="keyword">end</span>
0991             <span class="keyword">end</span>
0992             data.import.NMR.data = datanew;
0993             data.import.NMR.para = paranew;
0994 
0995             fnames = fnamesnew;
0996             shownames = shownamesnew;
0997         <span class="keyword">end</span>
0998     <span class="keyword">end</span>
0999 <span class="keyword">end</span>
1000 
1001 <span class="comment">% update the global data structure</span>
1002 data.import.NMR.files = fnames;
1003 data.import.NMR.filesShort = shownames;
1004 
1005 <span class="keyword">end</span>
1006 
1007 <span class="comment">%%</span>
1008 <a name="_sub8" href="#_subfunctions" class="code">function [data,gui] = importDataDartSeries(data,gui)</a>
1009 
1010 <span class="comment">% first ask the user if it is pure T2 data or T2 data belonging to a T1</span>
1011 <span class="comment">% measurement to generate T1-T2 maps</span>
1012 answer = questdlg(<span class="string">'Is this series a T1 measurement or pure T2?'</span>, <span class="keyword">...</span>
1013     <span class="string">'DART import'</span>, <span class="keyword">...</span>
1014     <span class="string">'T1'</span>,<span class="string">'T2'</span>,<span class="string">'T2'</span>);
1015 <span class="keyword">switch</span> answer
1016     <span class="keyword">case</span> <span class="string">'T1'</span>
1017         is_T1 = true;
1018     <span class="keyword">case</span> <span class="string">'T2'</span>
1019         is_T1 = false;
1020     <span class="keyword">otherwise</span>
1021         is_T1 = false;
1022 <span class="keyword">end</span>
1023 
1024 <span class="comment">% now check the subpaths</span>
1025 <span class="comment">% there should be some folders with names ...</span>
1026 <span class="comment">% ... similar to the data filenames inside them</span>
1027 datpath = dir(data.import.path);
1028 datpath = datpath(~ismember({datpath.name},{<span class="string">'.'</span>,<span class="string">'..'</span>}));
1029 <span class="comment">% remove any subfolder within the data directory</span>
1030 datpath = datpath(~ismember([datpath.isdir],true));
1031 
1032 fnames = struct;
1033 <span class="comment">% shownames is just a dummy to hold all data file names that</span>
1034 <span class="comment">% will be shown in the listbox</span>
1035 shownames = cell(1,1);
1036 
1037 c = 0;
1038 <span class="keyword">if</span> ~isempty(datpath)
1039     content = datpath;
1040     <span class="keyword">if</span> is_T1
1041         t_recov = zeros(1,2);
1042     <span class="keyword">end</span>
1043     <span class="keyword">for</span> j = 1:size(content,1)
1044         <span class="keyword">if</span> strcmp(content(j).name(end-3:end),<span class="string">'.jrd'</span>)
1045             in.T1T2 = <span class="string">'T2'</span>;
1046             in.name = content(j).name;
1047             in.path = fullfile(data.import.path);
1048             in.fileformat = data.import.fileformat;
1049             in.version = 4;
1050             out = <a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>(in);
1051             <span class="comment">% the individual file names</span>
1052             c = c + 1;
1053             fnames(c).parfile = <span class="string">''</span>;
1054             fnames(c).datafile = out.nmrData.datfile;
1055             fnames(c).T2specfile = <span class="string">''</span>;
1056             <span class="keyword">if</span> is_T1
1057                 shownames{c} = content(j).name;
1058             <span class="keyword">else</span>
1059                 shownames{c} = [<span class="string">'T2_'</span>,content(j).name];
1060             <span class="keyword">end</span>
1061 
1062             data.import.NMR.data{c} = out.nmrData;
1063             data.import.NMR.para{c} = out.parData;
1064 
1065             <span class="comment">% collect recovery times in case of T1 data set</span>
1066             <span class="keyword">if</span> is_T1
1067                 t_recov(c,1) = out.parData.t_recov;
1068                 t_recov(c,2) = out.nmrData.phase;
1069             <span class="keyword">end</span>
1070         <span class="keyword">end</span>
1071     <span class="keyword">end</span>
1072     
1073     <span class="comment">% in case if T1 data, use the phase of the signal with the longest</span>
1074     <span class="comment">% recovery time to rotate the other signals</span>
1075     <span class="keyword">if</span> is_T1
1076         phase = t_recov(t_recov(:,1)==max(t_recov(:,1)),2);
1077         <span class="keyword">for</span> i1 = 1:numel(data.import.NMR.data)
1078             <span class="comment">% the original raw data</span>
1079             s = data.import.NMR.data{i1}.raw.signal;
1080             <span class="comment">% s_rot is the rotated signal</span>
1081             s_rot = s .* exp(1i*phase);
1082             <span class="comment">% write the rotated signal back to the data struct</span>
1083             data.import.NMR.data{i1}.signal = s_rot;
1084             data.import.NMR.data{i1}.phase = phase;
1085 
1086             <span class="comment">% get the shortest T2 signal length</span>
1087             <span class="keyword">if</span> i1 == 1
1088                 t2N = numel(data.import.NMR.data{i1}.raw.time);
1089             <span class="keyword">else</span>
1090                 t2N = min([t2N numel(data.import.NMR.data{i1}.raw.time)]);
1091             <span class="keyword">end</span>
1092             t2 = data.import.NMR.data{i1}.raw.time(1:t2N);
1093         <span class="keyword">end</span>
1094 
1095         <span class="comment">% for convenience, sort the data by recovery time</span>
1096         [t_s,ix] = sort(t_recov(:,1));
1097         data.import.NMR.data = data.import.NMR.data(ix);
1098         data.import.NMR.para = data.import.NMR.para(ix);
1099         fnames = fnames(ix);
1100         shownames = shownames(ix);
1101 
1102         <span class="comment">% save the recovery time vector for later use</span>
1103         data.import.T1T2map.t_recov = t_s(:,1)/1000;
1104         data.import.T1T2map.t2 = t2;
1105         data.import.T1T2map.t2N = t2N;
1106 
1107         <span class="comment">% ask if the single measurements should be &quot;stacked&quot; to one T1</span>
1108         <span class="comment">% curve</span>
1109         answer = questdlg(<span class="string">'Do you want a single T1 curve or T1-T2 2D Inversion?'</span>, <span class="keyword">...</span>
1110             <span class="string">'DART import'</span>, <span class="keyword">...</span>
1111             <span class="string">'single T1'</span>,<span class="string">'2D Inv'</span>,<span class="string">'2D Inv'</span>);
1112         <span class="keyword">switch</span> answer
1113             <span class="keyword">case</span> <span class="string">'single T1'</span>
1114                 singleT1 = true;
1115             <span class="keyword">case</span> <span class="string">'2D Inv'</span>
1116                 singleT1 = false;
1117         <span class="keyword">end</span>
1118         
1119         <span class="keyword">if</span> singleT1
1120             <span class="comment">% ask how many T2-echos should be stacked together to one T1</span>
1121             <span class="comment">% point</span>
1122             prompt = {<span class="string">'Enter T2 #echos for one T1 point'</span>};
1123             dlgtitle = <span class="string">'How many T2 echos'</span>;
1124             fieldsize = [1 45];
1125             definput = {<span class="string">'3'</span>};
1126             answer = inputdlg(prompt,dlgtitle,fieldsize,definput);
1127             Nechos = str2double(answer{1});
1128             
1129             flag = <span class="string">'T1'</span>;
1130             time = data.import.T1T2map.t_recov;
1131             signal = zeros(numel(data.import.NMR.data),1);
1132             <span class="keyword">for</span> i1 = 1:numel(data.import.NMR.data)
1133                 signal(i1) = mean(real(data.import.NMR.data{i1}.signal(1:Nechos)));
1134             <span class="keyword">end</span>
1135 
1136             disp(<span class="string">'NUCLUESinv import: Estimating noise from exponential fit ...'</span>);
1137             param.T1IRfac = 1;
1138             param.noise = 0;
1139             param.optim = <span class="string">'off'</span>;
1140             param.Tfixed_bool = [0 0 0 0 0];
1141             param.Tfixed_val = [0 0 0 0 0];
1142             <span class="keyword">for</span> i1 = 1:5
1143                 invstd = <a href="../../../nucleus/functions/inversion/fitDataFree.html" class="code" title="function [fitdata] = fitDataFree(time,signal,flag,parameter,nExp)">fitDataFree</a>(time,signal,flag,param,i1);
1144                 <span class="keyword">if</span> i1 == 1
1145                     noise = invstd.rms;
1146                 <span class="keyword">else</span>
1147                     noise = min([noise invstd.rms]);
1148                 <span class="keyword">end</span>
1149             <span class="keyword">end</span>
1150             disp(<span class="string">'NUCLUESinv import: done.'</span>)
1151             
1152             <span class="comment">% finally create a new &quot;import&quot; data set</span>
1153             data_new = data.import.NMR.data(1);
1154             para_new = data.import.NMR.para(1);
1155             data.import = rmfield(data.import,<span class="string">'T1T2map'</span>);
1156 
1157             data_new{1}.flag = flag;
1158             data_new{1}.T1IRfac = param.T1IRfac;
1159             data_new{1}.time = time;
1160             data_new{1}.signal = signal;
1161             data_new{1}.noise = noise;
1162             data_new{1}.raw.time = time;
1163             data_new{1}.raw.signal = signal;            
1164 
1165             fnames = fnames(1);
1166             shownames = shownames(1);
1167 
1168             data.import.NMR.data = data_new;
1169             data.import.NMR.para = para_new;
1170         <span class="keyword">else</span>
1171             prompt = {<span class="string">'Enter T2 #echos for one T1 point for the merged T1 curve'</span>};
1172             dlgtitle = <span class="string">'How many T2 echos'</span>;
1173             fieldsize = [1 45];
1174             definput = {<span class="string">'3'</span>};
1175             answer = inputdlg(prompt,dlgtitle,fieldsize,definput);
1176             Nechos = str2double(answer{1});
1177 
1178             <span class="comment">% add the stacked signal to the data</span>
1179             flag = <span class="string">'T1'</span>;
1180             time = data.import.T1T2map.t_recov;
1181             signal = zeros(numel(data.import.NMR.data),1);
1182             <span class="keyword">for</span> i1 = 1:numel(data.import.NMR.data)
1183                 signal(i1) = mean(real(data.import.NMR.data{i1}.signal(1:Nechos)));
1184             <span class="keyword">end</span>
1185             
1186             disp(<span class="string">'NUCLUESinv import: Estimating noise from exponential fit ...'</span>);
1187             param.T1IRfac = 1;
1188             param.noise = 0;
1189             param.optim = <span class="string">'off'</span>;
1190             param.Tfixed_bool = [0 0 0 0 0];
1191             param.Tfixed_val = [0 0 0 0 0];
1192             <span class="keyword">for</span> i1 = 1:5
1193                 invstd = <a href="../../../nucleus/functions/inversion/fitDataFree.html" class="code" title="function [fitdata] = fitDataFree(time,signal,flag,parameter,nExp)">fitDataFree</a>(time,signal,flag,param,i1);
1194                 <span class="keyword">if</span> i1 == 1
1195                     noise = invstd.rms;
1196                 <span class="keyword">else</span>
1197                     noise = min([noise invstd.rms]);
1198                 <span class="keyword">end</span>
1199             <span class="keyword">end</span>
1200             disp(<span class="string">'NUCLUESinv import: done.'</span>)
1201 
1202             <span class="comment">% finally create a new &quot;import&quot; data set</span>
1203             data_new = data.import.NMR.data(1);
1204             para_new = data.import.NMR.para(1);
1205 
1206             data_new{1}.flag = flag;
1207             data_new{1}.T1IRfac = param.T1IRfac;
1208             data_new{1}.time = time;
1209             data_new{1}.signal = signal;
1210             data_new{1}.noise = noise;
1211             data_new{1}.raw.time = time;
1212             data_new{1}.raw.signal = signal;
1213 
1214             data.import.NMR.data{numel(t_s)+1} = data_new{1};
1215             data.import.NMR.para{numel(t_s)+1} = para_new{1};
1216             fnames(numel(t_s)+1).datafile = <span class="string">'T1_merged.dat'</span>;
1217             shownames{numel(t_s)+1} = <span class="string">'T1_merged'</span>;
1218             <span class="comment">% set global echo time</span>
1219             data.inv2D.prop.te = data.import.NMR.para{1}.t_echo;
1220             <span class="comment">% set T1 SR/IR factor</span>
1221             data.inv2D.inv.T1IRfac = 1; <span class="comment">% Dart default</span>
1222         <span class="keyword">end</span>
1223     <span class="keyword">end</span>
1224 <span class="keyword">end</span>
1225 
1226 <span class="comment">% update the global data structure</span>
1227 data.import.NMR.files = fnames;
1228 data.import.NMR.filesShort = shownames;
1229 
1230 <span class="keyword">end</span>
1231 
1232 <span class="comment">%%</span>
1233 <a name="_sub9" href="#_subfunctions" class="code">function [data,gui] = importDataDartT2logging(data,gui,useburst)</a>
1234 
1235 <span class="comment">% now check the subpaths</span>
1236 <span class="comment">% there should be some folders with names ...</span>
1237 <span class="comment">% ... similar to the data filenames inside them</span>
1238 datpath = dir(data.import.path);
1239 datpath = datpath(~ismember({datpath.name},{<span class="string">'.'</span>,<span class="string">'..'</span>}));
1240 <span class="comment">% remove any subfolder within the data directory</span>
1241 datpath = datpath(~ismember([datpath.isdir],true));
1242 
1243 fnames = struct;
1244 <span class="comment">% shownames is just a dummy to hold all data file names that</span>
1245 <span class="comment">% will be shown in the listbox</span>
1246 shownames = cell(1,1);
1247 
1248 c = 0;
1249 <span class="keyword">if</span> ~isempty(datpath)
1250     content = datpath;
1251     <span class="keyword">for</span> j = 1:size(content,1)
1252         in.T1T2 = <span class="string">'T2'</span>;
1253         in.name = content(j).name;
1254         in.path = fullfile(data.import.path);
1255         in.fileformat = data.import.fileformat;
1256         in.version = 5;
1257         out = <a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>(in);
1258 
1259         <span class="keyword">if</span> useburst
1260             <span class="keyword">for</span> nn = 1:2
1261                 <span class="comment">% get normal and burst signal</span>
1262                 idN = nn;
1263                 idB = idN+2;
1264 
1265                 <span class="comment">% add both signals to the data</span>
1266                 c = c + 1;
1267                 fnames(c).parfile = <span class="string">''</span>;
1268                 fnames(c).datafile = out.nmrData{idN}.datfile;
1269                 fnames(c).T2specfile = <span class="string">''</span>;
1270                 <span class="keyword">if</span> out.parData{nn}.freq/1e3 &lt; 450
1271                     <span class="comment">% 433 kHz</span>
1272                     shownames{c} = [<span class="string">'433kHz_'</span>,content(j).name];
1273                 <span class="keyword">else</span>
1274                     <span class="comment">% 486 kHz</span>
1275                     shownames{c} = [<span class="string">'486kHz_'</span>,content(j).name];
1276                 <span class="keyword">end</span>
1277                 data.import.NMR.data{c} = out.nmrData{idN};
1278                 data.import.NMR.para{c} = out.parData{idN};
1279 
1280                 c = c + 1;
1281                 fnames(c).parfile = <span class="string">''</span>;
1282                 fnames(c).datafile = out.nmrData{idB}.datfile;
1283                 fnames(c).T2specfile = <span class="string">''</span>;
1284                 <span class="keyword">if</span> out.parData{nn}.freq/1e3 &lt; 450
1285                     <span class="comment">% 433 kHz</span>
1286                     shownames{c} = [<span class="string">'433kHz_'</span>,content(j).name,<span class="string">'_burst'</span>];
1287                 <span class="keyword">else</span>
1288                     <span class="comment">% 486 kHz</span>
1289                     shownames{c} = [<span class="string">'486kHz_'</span>,content(j).name,<span class="string">'_burst'</span>];
1290                 <span class="keyword">end</span>
1291                 data.import.NMR.data{c} = out.nmrData{idB};
1292                 data.import.NMR.para{c} = out.parData{idB};
1293 
1294                 <span class="comment">% 1. fit both T2 signals mono-exponentially</span>
1295                 time0 = data.import.NMR.data{c-1}.time;
1296                 signal = data.import.NMR.data{c-1}.signal;
1297                 param.T1IRfac = 1;
1298                 param.noise = std(imag(signal));
1299                 param.optim = <span class="string">'off'</span>;
1300                 param.Tfixed_bool = [0 0 0 0 0];
1301                 param.Tfixed_val = [0 0 0 0 0];
1302                 invstd0 = <a href="../../../nucleus/functions/inversion/fitDataFree.html" class="code" title="function [fitdata] = fitDataFree(time,signal,flag,parameter,nExp)">fitDataFree</a>(time0,real(signal),<span class="string">'T2'</span>,param,1);
1303 
1304                 time1 = data.import.NMR.data{c}.time;
1305                 signal = data.import.NMR.data{c}.signal;
1306                 param.T1IRfac = 1;
1307                 param.noise = std(imag(signal));
1308                 param.optim = <span class="string">'off'</span>;
1309                 param.Tfixed_bool = [0 0 0 0 0];
1310                 param.Tfixed_val = [0 0 0 0 0];
1311                 invstd1 = <a href="../../../nucleus/functions/inversion/fitDataFree.html" class="code" title="function [fitdata] = fitDataFree(time,signal,flag,parameter,nExp)">fitDataFree</a>(time1,real(signal),<span class="string">'T2'</span>,param,1);
1312 
1313                 <span class="comment">% now assemble a dummy T1 curve</span>
1314                 t = [1e-4 data.import.NMR.para{c}.t_wait data.import.NMR.para{c-1}.t_wait];
1315                 s = [0 invstd1.E0 invstd0.E0];
1316                 <span class="comment">% finally create a new &quot;import&quot; data set</span>
1317                 data_new = data.import.NMR.data(c);
1318                 para_new = data.import.NMR.para(c);
1319 
1320                 data_new{1}.flag = <span class="string">'T1'</span>;
1321                 data_new{1}.T1IRfac = 1;
1322                 data_new{1}.time = t;
1323                 data_new{1}.signal = s;
1324                 data_new{1}.noise = 0;
1325                 data_new{1}.raw.time = t;
1326                 data_new{1}.raw.signal = s;
1327                 
1328                 c = c + 1;
1329                 data.import.NMR.data{c} = data_new{1};
1330                 data.import.NMR.para{c} = para_new{1};
1331                 fnames(c).datafile = <span class="string">'T1_merged.dat'</span>;
1332                 shownames{c} = [shownames{c-1}(1:end-5),<span class="string">'T1_merged'</span>];
1333             <span class="keyword">end</span>
1334         <span class="keyword">else</span>
1335             <span class="keyword">for</span> nn = 1:2
1336                 <span class="comment">% the individual file names</span>
1337                 c = c + 1;
1338                 fnames(c).parfile = <span class="string">''</span>;
1339                 fnames(c).datafile = out.nmrData{nn}.datfile;
1340                 fnames(c).T2specfile = <span class="string">''</span>;
1341                 <span class="keyword">if</span> out.parData{nn}.freq/1e3 &lt; 450
1342                     <span class="comment">% 433 kHz</span>
1343                     shownames{c} = [<span class="string">'433kHz_'</span>,content(j).name];
1344                 <span class="keyword">else</span>
1345                     <span class="comment">% 486 kHz</span>
1346                     shownames{c} = [<span class="string">'486kHz_'</span>,content(j).name];
1347                 <span class="keyword">end</span>
1348 
1349                 data.import.NMR.data{c} = out.nmrData{nn};
1350                 data.import.NMR.para{c} = out.parData{nn};
1351             <span class="keyword">end</span>
1352         <span class="keyword">end</span>
1353     <span class="keyword">end</span>
1354 <span class="keyword">end</span>
1355 
1356 <span class="comment">% update the global data structure</span>
1357 data.import.NMR.files = fnames;
1358 data.import.NMR.filesShort = shownames;
1359 
1360 <span class="keyword">end</span>
1361 
1362 <span class="comment">%%</span>
1363 <a name="_sub10" href="#_subfunctions" class="code">function [data,gui] = importDataDart(data,gui)</a>
1364 
1365 in.path = fullfile(data.import.path);
1366 in.name = data.import.file;
1367 in.fileformat = data.import.fileformat;
1368 in.version = data.import.version;
1369 out = <a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>(in);
1370 
1371 fnames = struct;
1372 <span class="comment">% shownames is just a dummy to hold all data file names that</span>
1373 <span class="comment">% will be shown in the listbox</span>
1374 shownames = cell(1,1);
1375 
1376 c = 0;
1377 <span class="keyword">for</span> j = 1:size(out.nmrData,2)
1378     <span class="comment">% the individual file names</span>
1379     c = c + 1;
1380     fnames(c).parfile = <span class="string">''</span>;
1381     fnames(c).datafile = data.import.file;
1382     fnames(c).T2specfile = <span class="string">''</span>;
1383     
1384     shownames{c} = [<span class="string">'depth_'</span>,sprintf(<span class="string">'%04.3f'</span>,out.parData{j}.depth)];
1385     
1386     <span class="comment">% the NMR data</span>
1387     <span class="comment">% here we fix the time scale from [ms] to [s]</span>
1388     <span class="keyword">if</span> max(out.nmrData{j}.time) &gt; 100
1389         out.nmrData{j}.time = out.nmrData{j}.time/1000;
1390         out.nmrData{j}.raw.time = out.nmrData{j}.raw.time/1000;
1391     <span class="keyword">end</span>
1392     data.import.NMR.data{c} = out.nmrData{j};
1393     data.import.NMR.para{c} = out.parData{j};
1394 <span class="keyword">end</span>
1395 
1396 <span class="comment">% update the global data structure</span>
1397 data.import.NMR.files = fnames;
1398 data.import.NMR.filesShort = shownames;
1399 
1400 <span class="keyword">end</span>
1401 
1402 <span class="comment">%%</span>
1403 <a name="_sub11" href="#_subfunctions" class="code">function [data,gui] = importDataRoCAT1T2(data,gui)</a>
1404 
1405 <span class="comment">% there should be some folders with names ...</span>
1406 <span class="comment">% ... similar to the data filenames inside them</span>
1407 datpath = dir(data.import.path);
1408 datpath = datpath(~ismember({datpath.name},{<span class="string">'.'</span>,<span class="string">'..'</span>}));
1409 <span class="comment">% remove any subfolder within the data directory</span>
1410 datpath = datpath(~ismember([datpath.isdir],true));
1411 
1412 fnames = struct;
1413 <span class="comment">% shownames is just a dummy to hold all data file names that</span>
1414 <span class="comment">% will be shown in the listbox</span>
1415 shownames = cell(1,1);
1416 
1417 c = 0;
1418 <span class="keyword">if</span> ~isempty(datpath)
1419     content = datpath;
1420     <span class="keyword">for</span> j = 1:size(content,1)
1421         <span class="keyword">if</span> strcmp(content(j).name,<span class="string">'data2.csv'</span>)
1422             in.T1T2 = <span class="string">'T2'</span>;
1423             in.name = content(j).name;
1424             in.path = fullfile(data.import.path);
1425             in.fileformat = data.import.fileformat;
1426             out = <a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>(in);
1427 
1428             <span class="keyword">for</span> j1 = 1:numel(out.nmrData)
1429                 <span class="comment">% the individual file names</span>
1430                 c = c + 1;
1431                 fnames(c).parfile = <span class="string">'acqu.par'</span>;
1432                 fnames(c).datafile = out.nmrData{j1}.datfile;
1433                 fnames(c).T2specfile = <span class="string">''</span>;
1434 
1435                 shownames{c} = [<span class="string">'T2_'</span>,content(j).name,<span class="string">'_'</span>,sprintf(<span class="string">'%03d'</span>,j1)];
1436 
1437                 data.import.NMR.data{c} = out.nmrData{j1};
1438                 data.import.NMR.para{c} = out.parData;
1439             <span class="keyword">end</span>
1440         <span class="keyword">end</span>
1441     <span class="keyword">end</span>
1442 
1443     <span class="comment">% save the recovery time vector for later use</span>
1444     t2 = data.import.NMR.data{1}.time;
1445     t2N = numel(t2);
1446     t_recov = logspace(log10(out.parData.minTau),log10(out.parData.maxTau),out.parData.tauSteps);
1447     data.import.T1T2map.t_recov = t_recov(:)./1e3; <span class="comment">% to [s]</span>
1448     data.import.T1T2map.t2 = t2;
1449     data.import.T1T2map.t2N = t2N;
1450     
1451     <span class="comment">% add the stacked signal to the data</span>
1452     Nechos = 1;
1453     flag = <span class="string">'T1'</span>;
1454     time = data.import.T1T2map.t_recov;
1455     signal = zeros(numel(data.import.NMR.data),1);
1456     <span class="keyword">for</span> i1 = 1:numel(data.import.NMR.data)
1457         signal(i1) = mean(real(data.import.NMR.data{i1}.signal(1:Nechos)));
1458     <span class="keyword">end</span>
1459 
1460     disp(<span class="string">'NUCLUESinv import: Estimating noise from exponential fit ...'</span>);
1461     param.T1IRfac = 2;
1462     param.noise = 0;
1463     param.optim = <span class="string">'off'</span>;
1464     param.Tfixed_bool = [0 0 0 0 0];
1465     param.Tfixed_val = [0 0 0 0 0];
1466     <span class="keyword">for</span> i1 = 1:5
1467         invstd = <a href="../../../nucleus/functions/inversion/fitDataFree.html" class="code" title="function [fitdata] = fitDataFree(time,signal,flag,parameter,nExp)">fitDataFree</a>(time,signal,flag,param,i1);
1468         <span class="keyword">if</span> i1 == 1
1469             noise = invstd.rms;
1470         <span class="keyword">else</span>
1471             noise = min([noise invstd.rms]);
1472         <span class="keyword">end</span>
1473     <span class="keyword">end</span>
1474     disp(<span class="string">'NUCLUESinv import: done.'</span>)
1475 
1476     <span class="comment">% finally create a new &quot;import&quot; data set</span>
1477     data_new = data.import.NMR.data(1);
1478     para_new = data.import.NMR.para(1);
1479 
1480     data_new{1}.flag = flag;
1481     data_new{1}.T1IRfac = param.T1IRfac;
1482     data_new{1}.time = time;
1483     data_new{1}.signal = signal;
1484     data_new{1}.noise = noise;
1485     data_new{1}.raw.time = time;
1486     data_new{1}.raw.signal = signal;
1487 
1488     data.import.NMR.data{c+1} = data_new{1};
1489     data.import.NMR.para{c+1} = para_new{1};
1490     fnames(c+1).datafile = <span class="string">'T1_merged.dat'</span>;
1491     shownames{c+1} = <span class="string">'T1_merged'</span>;
1492     <span class="comment">% set global echo time</span>
1493     data.inv2D.prop.te = data.import.NMR.para{1}.echoTime/1e6; <span class="comment">% [s]</span>
1494     <span class="comment">% set T1 SR/IR factor</span>
1495     data.inv2D.inv.T1IRfac = 2; <span class="comment">% Rock Core Analyzer default(?)</span>
1496 <span class="keyword">end</span>
1497 
1498 <span class="comment">% update the global data structure</span>
1499 data.import.NMR.files = fnames;
1500 data.import.NMR.filesShort = shownames;
1501 
1502 <span class="keyword">end</span>
1503 
1504 <span class="comment">%%</span>
1505 <a name="_sub12" href="#_subfunctions" class="code">function [data,gui] = importDataGeneral(data,gui)</a>
1506 
1507 <span class="comment">% look for all files ending with '.par'</span>
1508 <span class="comment">% should exist for T1 and T2 measurements</span>
1509 filenames = dir(fullfile(data.import.path,<span class="string">'*.par'</span>));
1510 
1511 fnames = struct;
1512 <span class="comment">% shownames is just a dummy to hold all data file names that</span>
1513 <span class="comment">% will be shown in the listbox</span>
1514 shownames = cell(1,1);
1515 
1516 <span class="comment">% loop over all found files and import the data</span>
1517 c = 0;
1518 in.path = data.import.path;
1519 <span class="keyword">for</span> i = 1:size(filenames,1)
1520     ind = strfind(filenames(i).name,<span class="string">'.'</span>);
1521     ind = max(ind);
1522     in.name = filenames(i).name(1:ind-1);
1523     in.fileformat = data.import.fileformat;
1524     out = <a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>(in);
1525     
1526     <span class="keyword">for</span> j = 1:size(out.nmrData,2)
1527         <span class="comment">% the individual file names</span>
1528         c = c + 1;
1529         fnames(c).parfile = filenames(i).name;
1530         fnames(c).datafile = out.nmrData{j}.datfile;
1531         <span class="keyword">if</span> strcmp(out.nmrData{j}.flag,<span class="string">'T2'</span>) &amp;&amp; isfield(out.nmrData{j},<span class="string">'specfile'</span>)
1532             fnames(c).T2specfile = out.nmrData{j}.specfile;
1533         <span class="keyword">else</span>
1534             fnames(c).T2specfile = <span class="string">''</span>;
1535         <span class="keyword">end</span>
1536         shownames{c} = fnames(c).datafile;
1537         
1538         <span class="comment">% the NMR data</span>
1539         <span class="comment">% here we fix the time scale from [ms] to [s]</span>
1540         <span class="keyword">if</span> max(out.nmrData{j}.time) &gt; 100
1541             out.nmrData{j}.time = out.nmrData{j}.time/1000;
1542             out.nmrData{j}.raw.time = out.nmrData{j}.raw.time/1000;
1543         <span class="keyword">end</span>
1544         data.import.NMR.data{c} = out.nmrData{j};
1545         data.import.NMR.para{c} = out.parData;
1546     <span class="keyword">end</span>
1547 <span class="keyword">end</span>
1548 
1549 <span class="keyword">switch</span> data.import.fileformat
1550     <span class="keyword">case</span> <span class="string">'bamtom'</span>
1551         nslices = out.parData.nSlices;
1552         ncsvfiles = numel(fnames);
1553         
1554         <span class="comment">% check for background file (&quot;Leermessung&quot;)</span>
1555         has_bg = false;
1556         <span class="keyword">for</span> i = 1:numel(fnames)
1557             <span class="keyword">if</span> ~isempty(strfind(fnames(i).datafile,<span class="string">'000'</span>))
1558                 has_bg = true;
1559                 index_bg = i;
1560                 <span class="keyword">break</span>;
1561             <span class="keyword">end</span>
1562         <span class="keyword">end</span>
1563         
1564         <span class="keyword">if</span> has_bg
1565             <span class="comment">% background data set</span>
1566             bg = data.import.NMR.data{index_bg};
1567             
1568             <span class="comment">% vector of indices of the files that get corrected</span>
1569             ind_files = 1:1:ncsvfiles;
1570             ind_files(ind_files==index_bg) = [];
1571             
1572             <span class="keyword">for</span> i = ind_files                
1573                 <span class="comment">% subtract the background signal</span>
1574                 s = data.import.NMR.data{i}.signal;
1575                 s_bg = bg.signal;
1576                 <span class="comment">% if the background signal is longer than the signal cut it</span>
1577                 <span class="keyword">if</span> numel(s_bg) &gt; numel(s)
1578                     tmp_s = s_bg(1:numel(s));
1579                 <span class="keyword">else</span> <span class="comment">% if not pad it with zeros</span>
1580                     tmp_s = zeros(size(s));
1581                     tmp_s(1:numel(s_bg)) = s_bg;
1582                 <span class="keyword">end</span>
1583                 s = complex(real(s)-real(tmp_s),imag(s)-imag(tmp_s));
1584                 <span class="comment">% update original data set</span>
1585                 data.import.NMR.data{i}.signal = s;                
1586             <span class="keyword">end</span>
1587             
1588             <span class="comment">% check if the number of slices is equal to the number of files</span>
1589             <span class="comment">% (excluding the background file)</span>
1590             <span class="keyword">if</span> nslices == numel(ind_files)
1591                 <span class="comment">% create z-vector</span>
1592                 p = out.parData;
1593                 zslice = linspace(p.startPos,p.endPos,p.nSlices)';
1594                 data.import.BAM.use_z = true;
1595                 data.import.BAM.zslice = zslice;
1596                 <span class="keyword">if</span> numel(zslice) &gt; 1
1597                     c = 0;
1598                     <span class="keyword">for</span> i = ind_files
1599                         c = c + 1;
1600                         tmp = shownames{i};
1601                         shownames{i} = [tmp,<span class="string">' z:'</span>,sprintf(<span class="string">'%5.4f'</span>,zslice(c))];
1602                     <span class="keyword">end</span>
1603                 <span class="keyword">end</span>
1604             <span class="keyword">else</span>
1605                 data.import.BAM.use_z = false;
1606                 data.import.BAM.zslice = 1:1:max([numel(ind_files) 1]);
1607             <span class="keyword">end</span>
1608             
1609         <span class="keyword">else</span>
1610             <span class="keyword">if</span> nslices == ncsvfiles
1611                 <span class="comment">% create z-vector</span>
1612                 p = out.parData;
1613                 zslice = linspace(p.startPos,p.endPos,p.nSlices)';
1614                 data.import.BAM.use_z = true;
1615                 data.import.BAM.zslice = zslice;
1616                 <span class="keyword">if</span> numel(zslice) &gt; 1
1617                     <span class="keyword">for</span> i = 1:numel(zslice)
1618                         tmp = shownames{i};
1619                         shownames{i} = [tmp,<span class="string">' z:'</span>,sprintf(<span class="string">'%5.4f'</span>,zslice(i))];
1620                     <span class="keyword">end</span>
1621                 <span class="keyword">end</span>
1622             <span class="keyword">else</span>
1623                 data.import.BAM.use_z = false;
1624                 data.import.BAM.zslice = 1:1:ncsvfiles;
1625             <span class="keyword">end</span>
1626         <span class="keyword">end</span>    
1627 <span class="keyword">end</span>
1628 
1629 <span class="comment">% update the global data structure</span>
1630 data.import.NMR.files = fnames;
1631 data.import.NMR.filesShort = shownames;
1632 
1633 <span class="keyword">end</span>
1634 
1635 <span class="comment">%%</span>
1636 <a name="_sub13" href="#_subfunctions" class="code">function [data,gui] = importDataLIAG(data,gui)</a>
1637 
1638 in.path = fullfile(data.import.path);
1639 in.fileformat = data.import.fileformat;
1640 out = <a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>(in);
1641 
1642 fnames = struct;
1643 <span class="comment">% shownames is just a dummy to hold all data file names that</span>
1644 <span class="comment">% will be shown in the listbox</span>
1645 shownames = cell(1,1);
1646 
1647 c = 0;
1648 <span class="keyword">for</span> j = 1:size(out.nmrData,2)
1649     <span class="comment">% the individual file names</span>
1650     c = c + 1;
1651     fnames(c).parfile = <span class="string">'acqu.par'</span>;
1652     fnames(c).datafile = out.nmrData{j}.datfile;
1653     fnames(c).T2specfile = <span class="string">''</span>;
1654     
1655     shownames{c} = fnames(c).datafile;
1656     
1657     <span class="comment">% the NMR data</span>
1658     <span class="comment">% here we fix the time scale to [s] if neccessary</span>
1659     TE = out.parData.echoTime; <span class="comment">% [µs]</span>
1660     <span class="keyword">if</span> out.nmrData{j}.time(1)== TE/1e3
1661         <span class="comment">% change [ms] to [s]</span>
1662         out.nmrData{j}.time = out.nmrData{j}.time/1e3;
1663         out.nmrData{j}.raw.time = out.nmrData{j}.raw.time/1e3;
1664     <span class="keyword">elseif</span> out.nmrData{j}.time(1)== TE
1665         <span class="comment">% change [µs] to [s] -&gt; very unlikely</span>
1666         out.nmrData{j}.time = out.nmrData{j}.time/1e6;
1667         out.nmrData{j}.raw.time = out.nmrData{j}.raw.time/1e6;
1668     <span class="keyword">end</span>
1669     data.import.NMR.data{c} = out.nmrData{j};
1670     data.import.NMR.para{c} = out.parData;
1671 <span class="keyword">end</span>
1672 
1673 <span class="comment">% update the global data structure</span>
1674 data.import.NMR.files = fnames;
1675 data.import.NMR.filesShort = shownames;
1676 
1677 <span class="keyword">end</span>
1678 
1679 <span class="comment">%%</span>
1680 <a name="_sub14" href="#_subfunctions" class="code">function [data,gui] = importDataLIAGcore(data,gui)</a>
1681 
1682 <span class="comment">% get all subfolders containing a measurement at a certain heigth</span>
1683 subdirs = dir(data.import.path);
1684 <span class="comment">% remove the dot-dirs</span>
1685 subdirs = subdirs(~ismember({subdirs.name},{<span class="string">'.'</span>,<span class="string">'..'</span>}));
1686 
1687 <span class="comment">% now get the background data (&quot;Leermessung&quot;)</span>
1688 bgPath = uigetdir(data.import.path,<span class="string">'Choose Background Data Path'</span>);
1689 isbgPath = false;
1690 <span class="keyword">if</span> bgPath == 0
1691     disp(<span class="string">'NUCLEUSinv: LIAG core import: No background file provided.'</span>);
1692 <span class="keyword">else</span>
1693     isbgPath = true;
1694     in.path = fullfile(bgPath);
1695     in.fileformat = data.import.fileformat;
1696     bgout = <a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>(in);
1697     ref1.t = bgout.nmrData{1}.time;
1698     ref1.s = bgout.nmrData{1}.signal;
1699     [ref1.s,~] = <a href="../../../nucleus/functions/import/rotateT2phase.html" class="code" title="function [s_rot,alpha] = rotateT2phase(s,varargin)">rotateT2phase</a>(ref1.s);
1700 <span class="keyword">end</span>
1701 
1702 <span class="comment">% get the Position file</span>
1703 [posFile,posFilePath] = uigetfile(<span class="string">'*.*'</span>,<span class="string">'Choose Lift Position File'</span>,data.import.path);
1704 isposFile = false;
1705 <span class="keyword">if</span> posFilePath == 0
1706     disp(<span class="string">'NUCLEUSinv: LIAG core import: No position file provided.'</span>);
1707 <span class="keyword">else</span>
1708     isposFile = true;
1709     <span class="comment">% import LIAG lift file</span>
1710     buffer = fileread(fullfile(posFilePath,posFile));
1711 
1712     <span class="comment">% get the time stamps of the lift positions</span>
1713     substr = <span class="string">'Zeit:'</span> ;
1714     loc = strfind(buffer, substr);
1715     timepoint = cell(1,1);
1716     <span class="keyword">for</span> i = 1:length(loc)
1717         timestr = strtrim(buffer(loc(i)+numel(substr):loc(i)+numel(substr)+19));
1718         timepoint{i} = datetime(timestr,<span class="string">'InputFormat'</span>,<span class="string">'dd.MM.yyyy HH:mm:ss'</span>);
1719     <span class="keyword">end</span>
1720     <span class="comment">% ignore the first time stamp</span>
1721     t_range = [datenum(timepoint{2}), datenum(timepoint{3})];
1722     <span class="comment">% get the z coords</span>
1723     substr = <span class="string">'Z1='</span>;
1724     loc = strfind(buffer, substr) ;
1725     z_range(1) = sscanf(buffer(loc+numel(substr):loc+numel(substr)+10),<span class="string">'%f'</span>,1);
1726     substr = <span class="string">'Z2='</span>;
1727     loc = strfind(buffer, substr) ;
1728     z_range(2) =  sscanf(buffer(loc+numel(substr):loc+numel(substr)+10),<span class="string">'%f'</span>,1);
1729 <span class="keyword">end</span>
1730 
1731 <span class="comment">% import the NMR data</span>
1732 count = 0;
1733 levels = zeros(size(subdirs));
1734 nmrDataTMP = cell(1,1);
1735 <span class="keyword">for</span> i = 1:numel(subdirs)
1736     <span class="keyword">if</span> ~isnan(str2double(subdirs(i).name))
1737 
1738         <span class="comment">% import the NMR file</span>
1739         in.path = fullfile(data.import.path,subdirs(i).name,<span class="string">'T2CPMG'</span>);
1740         in.fileformat = data.import.fileformat;
1741         out = <a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>(in);
1742 
1743         <span class="comment">% if there is a position file</span>
1744         <span class="keyword">if</span> isposFile
1745             <span class="comment">% keep only files within the correct time range</span>
1746             <span class="keyword">if</span> out.nmrData{1}.datenum &gt; t_range(1) &amp;&amp; out.nmrData{1}.datenum &lt; t_range(2)
1747                 count = count + 1;
1748                 <span class="comment">% interpolate the z position via the time stamp of the NMR file</span>
1749                 levels(count) = interp1(t_range,z_range,out.nmrData{1}.datenum,<span class="string">'linear'</span>);
1750                 nmrDataTMP{count} = out;
1751             <span class="keyword">end</span>
1752         <span class="keyword">else</span> <span class="comment">% just read everything</span>
1753             count = count + 1;
1754             levels(count) = str2double(subdirs(i).name);
1755             nmrDataTMP{count} = out;
1756         <span class="keyword">end</span>
1757     <span class="keyword">end</span>
1758 <span class="keyword">end</span>
1759 <span class="comment">% cut off data that is not part of the scan</span>
1760 levels = levels(1:count);
1761 <span class="comment">% sort in ascending order</span>
1762 [levels,idx] = sort(levels);
1763 
1764 <span class="comment">% sort the NMR data accordingly</span>
1765 fnames = struct;
1766 <span class="comment">% shownames is just a dummy to hold all data file names that</span>
1767 <span class="comment">% will be shown in the listbox</span>
1768 shownames = cell(1,1);
1769 <span class="keyword">for</span> c = 1:numel(levels)
1770     <span class="comment">% the individual file names</span>
1771     fnames(c).parfile = <span class="string">'acqu.par'</span>;
1772     fnames(c).datafile = nmrDataTMP{idx(c)}.nmrData{1}.datfile;
1773     fnames(c).T2specfile = <span class="string">''</span>;
1774     
1775     shownames{c} = fnames(c).datafile;
1776     tmp = shownames{c};
1777     <span class="keyword">if</span> isposFile
1778         shownames{c} = [tmp,<span class="string">': '</span>,sprintf(<span class="string">'%4d'</span>,floor(levels(c))),<span class="string">'mm'</span>];
1779     <span class="keyword">else</span>
1780         shownames{c} = [tmp,<span class="string">' level:'</span>,sprintf(<span class="string">'%d'</span>,levels(c))];
1781     <span class="keyword">end</span>
1782     out = nmrDataTMP{idx(c)};
1783     
1784     <span class="comment">% the NMR data</span>
1785     <span class="comment">% here we fix the time scale to [s] if neccessary</span>
1786     TE = out.parData.echoTime; <span class="comment">% [µs]</span>
1787     <span class="keyword">if</span> out.nmrData{1}.time(1) == TE/1e3
1788         <span class="comment">% change [ms] to [s]</span>
1789         out.nmrData{1}.time = out.nmrData{1}.time/1e3;
1790         out.nmrData{1}.raw.time = out.nmrData{1}.raw.time/1e3;
1791     <span class="keyword">elseif</span> out.nmrData{1}.time(1) == TE
1792         <span class="comment">% change [µs] to [s] -&gt; very unlikely</span>
1793         out.nmrData{1}.time = out.nmrData{1}.time/1e6;
1794         out.nmrData{1}.raw.time = out.nmrData{1}.raw.time/1e6;
1795     <span class="keyword">end</span>
1796     data.import.NMR.data{c} = out.nmrData{1};
1797     data.import.NMR.para{c} = out.parData;
1798 
1799     <span class="comment">% subtract the background signal is one is available</span>
1800     <span class="keyword">if</span> isbgPath
1801         <span class="comment">% get the original signal</span>
1802         s = data.import.NMR.data{c}.signal;
1803         <span class="comment">% if the background signal is longer than the signal cut it, if</span>
1804         <span class="comment">% not extend it with zeros</span>
1805         <span class="keyword">if</span> numel(ref1.s) &gt; numel(s)
1806             tmp_r = ref1.s(1:numel(s));
1807         <span class="keyword">else</span>
1808             tmp_r = zeros(size(s));
1809             tmp_r(1:numel(ref1.s)) = ref1.s;
1810         <span class="keyword">end</span>
1811         s = complex(real(s)-real(tmp_r),imag(s)-imag(tmp_r));
1812 
1813         <span class="comment">% sign check</span>
1814         <span class="keyword">if</span> real(s(1:3))&lt;0
1815             s = s*-1;
1816         <span class="keyword">end</span>
1817 
1818         <span class="comment">% rotate phase again - TEST</span>
1819         [s,~] = <a href="../../../nucleus/functions/import/rotateT2phase.html" class="code" title="function [s_rot,alpha] = rotateT2phase(s,varargin)">rotateT2phase</a>(s);
1820 
1821         <span class="comment">% update signal</span>
1822         data.import.NMR.data{c}.signal = s;
1823         data.import.NMR.data{c}.raw.signal = s;
1824     <span class="keyword">end</span>
1825 <span class="keyword">end</span>
1826 <span class="keyword">if</span> isposFile
1827     data.import.LIAGCORE.use_z = true;
1828 <span class="keyword">else</span>
1829     data.import.LIAGCORE.use_z = false;
1830 <span class="keyword">end</span>
1831 data.import.LIAGCORE.zslice = levels;
1832 
1833 <span class="comment">% update the global data structure</span>
1834 data.import.NMR.files = fnames;
1835 data.import.NMR.filesShort = shownames;
1836 
1837 <span class="keyword">end</span>
1838 
1839 <span class="comment">%%</span>
1840 <a name="_sub15" href="#_subfunctions" class="code">function [data,gui] = importDataLIAGproject(data,gui)</a>
1841 
1842 <span class="comment">% 1) show all folders and ask for sample</span>
1843 subdirs = dir(data.import.path);
1844 <span class="comment">% remove the dot-dirs</span>
1845 subdirs = subdirs(~ismember({subdirs.name},{<span class="string">'.'</span>,<span class="string">'..'</span>}));
1846 
1847 fnames = {subdirs.name};
1848 [indx,~] = listdlg(<span class="string">'PromptString'</span>,<span class="string">'Select Sample:'</span>,<span class="keyword">...</span>
1849     <span class="string">'SelectionMode'</span>,<span class="string">'single'</span>,<span class="keyword">...</span>
1850     <span class="string">'ListString'</span>,fnames);
1851 
1852 <span class="keyword">if</span> ~isempty(indx)
1853     <span class="comment">% 2) check corresponding SampleParameter.par file for reference and</span>
1854     <span class="comment">% calibration sample and other parameters</span>
1855     datapath = fullfile(data.import.path,fnames{indx});
1856     <span class="comment">% load SampleParameter file for sample</span>
1857     [SampleParameter] = <a href="#_sub18" class="code" title="subfunction data = loadGUIParameters(datapath,fname)">loadGUIParameters</a>(datapath,<span class="string">'SampleParameters.par'</span>);
1858     <span class="keyword">if</span> isfield(SampleParameter,<span class="string">'sampleVolume'</span>)
1859         dataVol = SampleParameter.sampleVolume;
1860     <span class="keyword">else</span>
1861         dataVol = 1;
1862     <span class="keyword">end</span>
1863     
1864     <span class="comment">% 2a) background file #1</span>
1865     backgroundFile1 = SampleParameter.backgroundFile;
1866     <span class="keyword">if</span> isempty(backgroundFile1)
1867         bnames = {subdirs.name};
1868         bnames(indx) = [];
1869         [indb,~] = listdlg(<span class="string">'PromptString'</span>,<span class="string">'Select Background File:'</span>,<span class="keyword">...</span>
1870             <span class="string">'SelectionMode'</span>,<span class="string">'single'</span>,<span class="keyword">...</span>
1871             <span class="string">'ListString'</span>,bnames);
1872         <span class="keyword">if</span> ~isempty(indb)
1873             backgroundFile1 = bnames{indb};
1874         <span class="keyword">else</span>
1875             backgroundFile1 = <span class="string">''</span>;
1876         <span class="keyword">end</span>
1877     <span class="keyword">end</span>
1878     <span class="keyword">if</span> ~isempty(backgroundFile1)
1879         ind = strfind(backgroundFile1,filesep);
1880         <span class="keyword">if</span> ~isempty(ind)
1881             backgroundFile1 = backgroundFile1(ind(end)+1:end);
1882         <span class="keyword">end</span>
1883         fileInList = ismember(fnames,{backgroundFile1});
1884         <span class="keyword">if</span> any(fileInList)
1885             backgroundpath1 = fullfile(data.import.path,fnames{fileInList});
1886         <span class="keyword">end</span>
1887     <span class="keyword">else</span>
1888         backgroundpath1 = <span class="string">''</span>;
1889         backgroundFile1 = <span class="string">''</span>;
1890     <span class="keyword">end</span>
1891     backVol = 1;
1892     
1893     <span class="comment">% 2b) calibration file</span>
1894     c = 0;
1895     <span class="keyword">if</span> isfield(SampleParameter,<span class="string">'calibrationFile0'</span>)
1896         c = c + 1;
1897         calibrationFiles{c} = SampleParameter.calibrationFile0;
1898     <span class="keyword">end</span>
1899     <span class="keyword">if</span> isfield(SampleParameter,<span class="string">'calibrationFile1'</span>)
1900         c = c + 1;
1901         calibrationFiles{c} = SampleParameter.calibrationFile1;
1902     <span class="keyword">end</span>
1903     <span class="keyword">if</span> isfield(SampleParameter,<span class="string">'calibrationFile2'</span>)
1904         c = c + 1;
1905         calibrationFiles{c} = SampleParameter.calibrationFile2;
1906     <span class="keyword">end</span>
1907     <span class="keyword">if</span> isfield(SampleParameter,<span class="string">'calibrationFile3'</span>)
1908         c = c + 1;
1909         calibrationFiles{c} = SampleParameter.calibrationFile3;
1910     <span class="keyword">end</span>
1911     
1912     <span class="comment">% find the non-empty one</span>
1913     ind = ismember(calibrationFiles,{<span class="string">''</span>});
1914     <span class="comment">% there are three possibilities: 0, 1 and more than 1 calib. files</span>
1915     calibrationFiles(ind) = [];
1916     <span class="keyword">if</span> isempty(calibrationFiles)
1917         cnames = {subdirs.name};
1918         cnames(indx) = [];
1919         [indc,~] = listdlg(<span class="string">'PromptString'</span>,<span class="string">'Select Calibration File:'</span>,<span class="keyword">...</span>
1920             <span class="string">'SelectionMode'</span>,<span class="string">'single'</span>,<span class="keyword">...</span>
1921             <span class="string">'ListString'</span>,cnames);
1922         <span class="keyword">if</span> ~isempty(indc)
1923             calibrationFiles = cnames{indc};
1924         <span class="keyword">else</span>
1925             calibrationFiles = <span class="string">''</span>;
1926         <span class="keyword">end</span>        
1927     <span class="keyword">else</span>
1928         <span class="comment">% if there are more than one let the user select the correct one</span>
1929         <span class="keyword">if</span> numel(calibrationFiles) &gt; 1
1930             [ind,~] = listdlg(<span class="string">'PromptString'</span>,<span class="string">'Select Calibration File:'</span>,<span class="keyword">...</span>
1931                 <span class="string">'SelectionMode'</span>,<span class="string">'single'</span>,<span class="keyword">...</span>
1932                 <span class="string">'ListString'</span>,calibrationFiles);
1933             calibrationFiles = calibrationFiles{ind};
1934         <span class="keyword">else</span>
1935             calibrationFiles = calibrationFiles{1};
1936         <span class="keyword">end</span>
1937     <span class="keyword">end</span>
1938     <span class="keyword">if</span> ~isempty(calibrationFiles)
1939         ind = strfind(calibrationFiles,filesep);
1940         <span class="keyword">if</span> ~isempty(ind)
1941             calibrationFiles = calibrationFiles(ind(end)+1:end);
1942         <span class="keyword">end</span>
1943         fileInList = ismember(fnames,{calibrationFiles});
1944         <span class="keyword">if</span> any(fileInList)
1945             calibrationpath = fullfile(data.import.path,fnames{fileInList});
1946         <span class="keyword">end</span>
1947     <span class="keyword">else</span>
1948         calibrationpath = <span class="string">''</span>;
1949         calibrationFiles = <span class="string">''</span>;
1950     <span class="keyword">end</span>
1951     
1952     <span class="keyword">if</span> ~isempty(calibrationpath)
1953         [SampleParameterC] = <a href="#_sub18" class="code" title="subfunction data = loadGUIParameters(datapath,fname)">loadGUIParameters</a>(calibrationpath,<span class="string">'SampleParameters.par'</span>);
1954         <span class="keyword">if</span> isfield(SampleParameterC,<span class="string">'sampleVolume'</span>)
1955             calibVol = SampleParameterC.sampleVolume;
1956         <span class="keyword">else</span>
1957             calibVol = 1;
1958         <span class="keyword">end</span>
1959         
1960         <span class="comment">% 2a) background file #2</span>
1961         backgroundFile2 = SampleParameterC.backgroundFile;
1962         <span class="keyword">if</span> isempty(backgroundFile2)
1963             bnames = {subdirs.name};
1964             bnames(indx) = [];
1965             [indb,~] = listdlg(<span class="string">'PromptString'</span>,<span class="string">'Select Background File for Calibration:'</span>,<span class="keyword">...</span>
1966                 <span class="string">'SelectionMode'</span>,<span class="string">'single'</span>,<span class="keyword">...</span>
1967                 <span class="string">'ListString'</span>,bnames);
1968             <span class="keyword">if</span> ~isempty(indb)
1969                 backgroundFile2 = bnames{indb};
1970             <span class="keyword">else</span>
1971                 backgroundFile2 = <span class="string">''</span>;
1972             <span class="keyword">end</span>  
1973         <span class="keyword">end</span>
1974         <span class="keyword">if</span> ~isempty(backgroundFile2)
1975             ind = strfind(backgroundFile2,filesep);
1976             <span class="keyword">if</span> ~isempty(ind)
1977                 backgroundFile2 = backgroundFile2(ind(end)+1:end);
1978             <span class="keyword">end</span>
1979             fileInList = ismember(fnames,{backgroundFile2});
1980             <span class="keyword">if</span> any(fileInList)
1981                 backgroundpath2 = fullfile(data.import.path,fnames{fileInList});
1982             <span class="keyword">end</span>
1983         <span class="keyword">else</span>
1984             backgroundpath2 = <span class="string">''</span>;
1985             backgroundFile2 = <span class="string">''</span>;
1986         <span class="keyword">end</span>
1987     <span class="keyword">else</span>
1988         calibVol = 1;
1989         backgroundpath2 = <span class="string">''</span>;
1990         backgroundFile2 = <span class="string">''</span>;
1991     <span class="keyword">end</span>
1992     
1993     <span class="comment">% 3) now load the data</span>
1994     workpaths = {datapath,calibrationpath,backgroundpath1,backgroundpath2};
1995     workfiles = {fnames{indx},[calibrationFiles,<span class="string">' - calibration'</span>],<span class="keyword">...</span>
1996         [backgroundFile1,<span class="string">' - backgroundS'</span>],[backgroundFile2,<span class="string">' - backgroundC'</span>]};
1997     out = cell(size(workpaths));
1998     count = 0;
1999     keep = false(size(workpaths));
2000     <span class="keyword">for</span> i = 1:numel(workpaths)
2001         <span class="keyword">if</span> ~isempty(workpaths{i})
2002             workdirs = dir(workpaths{i});
2003             workdirs = workdirs(~ismember({workdirs.name},{<span class="string">'.'</span>,<span class="string">'..'</span>}));
2004             isT2 = ismember({workdirs.name},{<span class="string">'T2CPMG'</span>});
2005             <span class="keyword">if</span> any(isT2)
2006                 keep(i) = true;
2007                 count = count + 1;
2008                 T2path = fullfile(workdirs(isT2).folder,workdirs(isT2).name);
2009                 in.path = T2path;
2010                 in.fileformat = data.import.fileformat;
2011                 out{i} = <a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>(in);
2012             <span class="keyword">end</span>
2013         <span class="keyword">end</span>
2014     <span class="keyword">end</span>    
2015     
2016     <span class="keyword">if</span> isempty(backgroundpath1)
2017         ref1 = struct;
2018     <span class="keyword">else</span>
2019         background1 = out{3};
2020         <span class="comment">% get the background data 1</span>
2021         ref1.t = background1.nmrData{1}.time;
2022         ref1.s = background1.nmrData{1}.signal;
2023         [ref1.s,~] = <a href="../../../nucleus/functions/import/rotateT2phase.html" class="code" title="function [s_rot,alpha] = rotateT2phase(s,varargin)">rotateT2phase</a>(ref1.s);
2024     <span class="keyword">end</span>
2025     
2026     <span class="keyword">if</span> isempty(backgroundpath2)
2027         ref2 = struct;
2028     <span class="keyword">else</span>
2029         background2 = out{4};
2030         <span class="comment">% get the background data 2</span>
2031         ref2.t = background2.nmrData{1}.time;
2032         ref2.s = background2.nmrData{1}.signal;
2033         [ref2.s,~] = <a href="../../../nucleus/functions/import/rotateT2phase.html" class="code" title="function [s_rot,alpha] = rotateT2phase(s,varargin)">rotateT2phase</a>(ref2.s);
2034     <span class="keyword">end</span>
2035     
2036     workpaths = workpaths(keep);
2037     workfiles = workfiles(keep);
2038     out = out(keep);
2039     
2040     ffnames = struct;
2041     <span class="comment">% shownames is just a dummy to hold all data file names that</span>
2042     <span class="comment">% will be shown in the listbox</span>
2043     shownames = cell(1,1);
2044     
2045     <span class="keyword">for</span> i = 1:count
2046         ffnames(i).parfile = <span class="string">'acqu.par'</span>;
2047         ffnames(i).datafile = workfiles{i};
2048         ffnames(i).T2specfile = <span class="string">''</span>;
2049         
2050         shownames{i} = ffnames(i).datafile;
2051         
2052         <span class="comment">% the NMR data</span>
2053         <span class="comment">% here we fix the time scale to [s] if neccessary</span>
2054         TE = out{i}.parData.echoTime; <span class="comment">% [µs]</span>
2055         <span class="keyword">if</span> out{i}.nmrData{1}.time(1)== TE/1e3
2056             <span class="comment">% change [ms] to [s]</span>
2057             out{i}.nmrData{1}.time = out{i}.nmrData{1}.time/1e3;
2058             out{i}.nmrData{1}.raw.time = out{i}.nmrData{1}.raw.time/1e3;
2059         <span class="keyword">elseif</span> out{i}.nmrData{1}.time(1)== TE
2060             <span class="comment">% change [µs] to [s] -&gt; very unlikely</span>
2061             out{i}.nmrData{1}.time = out{i}.nmrData{1}.time/1e6;
2062         out{i}.nmrData{1}.raw.time = out{i}.nmrData{1}.raw.time/1e6;
2063         <span class="keyword">end</span>
2064         
2065         data.import.NMR.data{i} = out{i}.nmrData{1};
2066         data.import.NMR.para{i} = out{i}.parData;
2067         data.import.NMR.para{i}.SampleParameter = SampleParameter;
2068         
2069         <span class="comment">% subtract the background signal</span>
2070         s = data.import.NMR.data{i}.signal;
2071         <span class="keyword">if</span> i==1 &amp;&amp; isfield(ref1,<span class="string">'s'</span>)
2072             <span class="comment">% if the background signal is longer than the signal cut it, if</span>
2073             <span class="comment">% not extend it with zeros</span>
2074             <span class="keyword">if</span> numel(ref1.s) &gt; numel(s)
2075                 tmp_r = ref1.s(1:numel(s));
2076             <span class="keyword">else</span>
2077                 tmp_r = zeros(size(s));
2078                 tmp_r(1:numel(ref1.s)) = ref1.s;
2079             <span class="keyword">end</span>
2080             s = complex(real(s)-real(tmp_r),imag(s)-imag(tmp_r));
2081         <span class="keyword">elseif</span> i==2 &amp;&amp; isfield(ref2,<span class="string">'s'</span>)
2082             <span class="comment">% if the background signal is longer than the signal cut it, if</span>
2083             <span class="comment">% not extend it with zeros</span>
2084             <span class="keyword">if</span> numel(ref2.s) &gt; numel(s)
2085                 tmp_r = ref2.s(1:numel(s));
2086             <span class="keyword">else</span>
2087                 tmp_r = zeros(size(s));
2088                 tmp_r(1:numel(ref2.s)) = ref2.s;
2089             <span class="keyword">end</span>
2090             s = complex(real(s)-real(tmp_r),imag(s)-imag(tmp_r));
2091         <span class="keyword">end</span>        
2092         data.import.NMR.data{i}.signal = s;
2093         data.import.NMR.data{i}.raw.signal = s;
2094         
2095         <span class="keyword">if</span> ~isempty(strfind(workfiles{i},<span class="string">' - background'</span>))
2096             data.import.LIAG.sampleVol(i) = backVol;
2097         <span class="keyword">elseif</span> ~isempty(strfind(workfiles{i},<span class="string">' - calibration'</span>))
2098             data.import.LIAG.sampleVol(i) = calibVol;
2099         <span class="keyword">elseif</span> isempty(strfind(workfiles{i},<span class="string">' - background'</span>)) &amp;&amp;<span class="keyword">...</span>
2100                 isempty(strfind(workfiles{i},<span class="string">' - calibration'</span>))
2101             data.import.LIAG.sampleVol(i) = dataVol;
2102         <span class="keyword">end</span>
2103     <span class="keyword">end</span>
2104     data.import.LIAG.Tbulk = 1e6;
2105     data.import.LIAG.Tbulk_keep_fit = false;
2106     data.import.LIAG.workpaths = workpaths;
2107     data.import.LIAG.datapath = datapath;
2108     data.import.LIAG.calibrationpath = calibrationpath;
2109     data.import.LIAG.backgroundpath1 = backgroundpath1;
2110     data.import.LIAG.backgroundpath2 = backgroundpath2;
2111     
2112     <span class="comment">% update the global data structure</span>
2113     data.import.NMR.files = ffnames;
2114     data.import.NMR.filesShort = shownames;
2115 <span class="keyword">end</span>
2116 
2117 <span class="keyword">end</span>
2118 
2119 <span class="comment">%%</span>
2120 <a name="_sub16" href="#_subfunctions" class="code">function [data,gui] = importDataMouse(data,gui)</a>
2121 
2122 in.path = fullfile(data.import.path);
2123 in.fileformat = data.import.fileformat;
2124 out = <a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>(in);
2125 
2126 fnames = struct;
2127 <span class="comment">% shownames is just a dummy to hold all data file names that</span>
2128 <span class="comment">% will be shown in the listbox</span>
2129 shownames = cell(1,1);
2130 
2131 c = 0;
2132 <span class="keyword">for</span> j = 1:size(out.nmrData,2)
2133     <span class="comment">% the individual file names</span>
2134     c = c + 1;
2135     fnames(c).parfile = <span class="string">'acq.par'</span>;
2136     fnames(c).datafile = out.nmrData{j}.datfile;
2137     fnames(c).T2specfile = <span class="string">''</span>;
2138     
2139     shownames{c} = [<span class="string">'T2_'</span>,fnames(c).datafile];
2140     
2141     <span class="comment">% the NMR data</span>
2142     <span class="comment">% here we fix the time scale from [ms] to [s]</span>
2143     <span class="keyword">if</span> max(out.nmrData{j}.time) &gt; 100
2144         out.nmrData{j}.time = out.nmrData{j}.time/1000;
2145         out.nmrData{j}.raw.time = out.nmrData{j}.raw.time/1000;
2146     <span class="keyword">end</span>
2147     data.import.NMR.data{c} = out.nmrData{j};
2148     data.import.NMR.para{c} = out.parData;
2149 <span class="keyword">end</span>
2150 
2151 <span class="comment">% update the global data structure</span>
2152 data.import.NMR.files = fnames;
2153 data.import.NMR.filesShort = shownames;
2154 
2155 <span class="keyword">end</span>
2156 
2157 <span class="comment">%%</span>
2158 <a name="_sub17" href="#_subfunctions" class="code">function [data,gui] = importDataIBAC(data,gui)</a>
2159 
2160 in.path = fullfile(data.import.path);
2161 in.name = data.import.file;
2162 in.fileformat = data.import.fileformat;
2163 out = <a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>(in);
2164 
2165 nslices = out.parData.depths;
2166 nfiles = size(out.nmrData,2);
2167 
2168 fnames = struct;
2169 <span class="comment">% shownames is just a dummy to hold all data file names that</span>
2170 <span class="comment">% will be shown in the listbox</span>
2171 shownames = cell(1,1);
2172 
2173 c = 0;
2174 <span class="keyword">for</span> j = 1:size(out.nmrData,2)
2175     <span class="comment">% the individual file names</span>
2176     c = c + 1;
2177     fnames(c).parfile = out.parData.parfile;
2178     fnames(c).datafile = out.nmrData{j}.datfile;
2179     fnames(c).T2specfile = <span class="string">''</span>;
2180     
2181     shownames{c} = [fnames(c).datafile];
2182 
2183     data.import.NMR.data{c} = out.nmrData{j};
2184     data.import.NMR.para{c} = out.parData;
2185 <span class="keyword">end</span>
2186 
2187 <span class="comment">% check if the number of depth levels is equal to the number of</span>
2188 <span class="comment">% measurements</span>
2189 <span class="keyword">if</span> nslices == nfiles
2190     <span class="comment">% create z-vector</span>
2191     p = out.parData;
2192     zslice = linspace(p.initialdepth,p.finaldepth,p.depths)';
2193     data.import.IBAC.use_z = true;
2194     data.import.IBAC.zslice = zslice;
2195     <span class="keyword">if</span> numel(zslice) &gt; 1
2196         c = 0;
2197         <span class="keyword">for</span> i = 1:nfiles
2198             c = c + 1;
2199             tmp = shownames{i};
2200             shownames{i} = [tmp,<span class="string">' z:'</span>,sprintf(<span class="string">'%05d'</span>,zslice(c))];
2201         <span class="keyword">end</span>
2202     <span class="keyword">end</span>
2203 <span class="keyword">else</span>
2204     data.import.IBAC.use_z = false;
2205     data.import.IBAC.zslice = 1:1:max([nfiles 1]);
2206 <span class="keyword">end</span>
2207 
2208 <span class="comment">% update the global data structure</span>
2209 data.import.NMR.files = fnames;
2210 data.import.NMR.filesShort = shownames;
2211 
2212 <span class="keyword">end</span>
2213 
2214 <span class="comment">%%</span>
2215 <a name="_sub18" href="#_subfunctions" class="code">function data = loadGUIParameters(datapath,fname)</a>
2216 fid = fopen(fullfile(datapath,fname));
2217 d = textscan(fid,<span class="string">'%s'</span>,<span class="string">'Delimiter'</span>,<span class="string">'\n'</span>);
2218 fclose(fid);
2219 data = struct;
2220 <span class="keyword">for</span> i = 1:size(d{1},1)
2221     str = char(d{1}(i));
2222     str = <a href="../../../nucleus/functions/import/fixParameterString.html" class="code" title="function str = fixParameterString(str)">fixParameterString</a>(str);
2223     eval([<span class="string">'data.'</span>,str,<span class="string">';'</span>]); <span class="comment">%#ok&lt;EVLDOT&gt;</span>
2224 <span class="keyword">end</span>
2225 
2226 <span class="keyword">end</span>
2227 
2228 <span class="comment">%%</span>
2229 <a name="_sub19" href="#_subfunctions" class="code">function data = loadGUIrawdata(data,NMRpath,NMRfile)</a>
2230 
2231 load(fullfile(NMRpath,<span class="string">'NUCLEUSinv_raw.mat'</span>),<span class="string">'savedata'</span>);
2232 
2233 data.import.file = NMRfile;
2234 data.import.path = NMRpath;
2235 data.import.NMR = savedata;
2236 
2237 <span class="keyword">end</span>
2238 
2239 <span class="comment">%------------- END OF CODE --------------</span>
2240 
2241 <span class="comment">%% License:</span>
2242 <span class="comment">% MIT License</span>
2243 <span class="comment">%</span>
2244 <span class="comment">% Copyright (c) 2018 Thomas Hiller</span>
2245 <span class="comment">%</span>
2246 <span class="comment">% Permission is hereby granted, free of charge, to any person obtaining a copy</span>
2247 <span class="comment">% of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
2248 <span class="comment">% in the Software without restriction, including without limitation the rights</span>
2249 <span class="comment">% to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
2250 <span class="comment">% copies of the Software, and to permit persons to whom the Software is</span>
2251 <span class="comment">% furnished to do so, subject to the following conditions:</span>
2252 <span class="comment">%</span>
2253 <span class="comment">% The above copyright notice and this permission notice shall be included in all</span>
2254 <span class="comment">% copies or substantial portions of the Software.</span>
2255 <span class="comment">%</span>
2256 <span class="comment">% THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
2257 <span class="comment">% IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
2258 <span class="comment">% FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
2259 <span class="comment">% AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
2260 <span class="comment">% LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
2261 <span class="comment">% OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
2262 <span class="comment">% SOFTWARE.</span></pre></div>
<hr><address>Generated by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>