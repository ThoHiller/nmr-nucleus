<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of importNMRdata</title>
  <meta name="keywords" content="importNMRdata">
  <meta name="description" content=" is the general import routine for NMR data">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- # nucleus --><!-- # functions --><!-- menu.html interface -->
<h1>importNMRdata
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong> is the general import routine for NMR data</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function importNMRdata(src) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment">importNMRdata is the general import routine for NMR data

 Syntax:
       importNMRdata(src)

 Inputs:
       src - handle of the calling menu

 Outputs:
       none

 Example:
       importNMRdata(src)

 Other m-files required:
       cleanupGUIData
       clearAllAxes
       displayStatusText
       enableGUIelements('NMR');
       LoadNMRData_driver
       NUCLEUSinv_updateInterface

 Subfunctions:
       getNMRPathFile
       importDataBGR
       importDataBGRmat
       importDataDart
       importDataGeneral
       importDataLIAG
       importDataLIAGproject
       importDataMouse
       importDataHelios
       loadGUIParameters
       loadGUIrawdata

 MAT-files required:
       none

 See also: NUCLEUSinv, NUCLEUSmod
 Author: see AUTHORS.md
 email: see AUTHORS.md
 License: MIT License (at end)</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../nucleus/NUCLEUSinv/NUCLEUSinv_updateInterface.html" class="code" title="function NUCLEUSinv_updateInterface">NUCLEUSinv_updateInterface</a>	 updates all GUI elements</li><li><a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>	 loads NMR raw data from different file formats</li><li><a href="../../../nucleus/functions/import/fixParameterString.html" class="code" title="function str = fixParameterString(str)">fixParameterString</a>	 cleans parameter file lines when the properties have a</li><li><a href="../../../nucleus/functions/import/rotateT2phase.html" class="code" title="function [s_rot,alpha] = rotateT2phase(s,varargin)">rotateT2phase</a>	 rotateT2phase rotates the complex NMR T2 signal so that the imaginary</li><li><a href="Inv2DView.html" class="code" title="function Inv2DView(src,~)">Inv2DView</a>	 is an extra subGUI to calculate 2D inversion of T1-T2 data</li><li><a href="cleanupGUIData.html" class="code" title="function data = cleanupGUIData(data)">cleanupGUIData</a>	 removes unnecessary fields from the global "data" struct</li><li><a href="clearAllAxes.html" class="code" title="function clearAllAxes(figh)">clearAllAxes</a>	 clears all axes of a given figure</li><li><a href="displayStatusText.html" class="code" title="function displayStatusText(gui,string)">displayStatusText</a>	 shows status information either in the GUI or on the</li><li><a href="enableGUIelements.html" class="code" title="function enableGUIelements(importtype)">enableGUIelements</a>	 activates all necessary GUI elements after successful</li><li><a href="makeINIfile.html" class="code" title="function gui = makeINIfile(gui,method)">makeINIfile</a>	 creates or updates the ini-File</li><li><a href="../../../nucleus/functions/interface/subGUIs/Inv2DView.html" class="code" title="function Inv2DView(src,~)">Inv2DView</a>	 is an extra subGUI to calculate 2D inversion of T1-T2 data</li><li><a href="../../../nucleus/functions/inversion/fitDataFree.html" class="code" title="function [fitdata] = fitDataFree(time,signal,flag,parameter,nExp)">fitDataFree</a>	 is a control routine that uses 'lsqcurvefit' to fit NMR data</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../nucleus/callbacks/menus/onMenuImport.html" class="code" title="function onMenuImport(src,~)">onMenuImport</a>	 handles the import menu entries</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function [NMRpath,NMRfile] = getNMRPathFile(label,import)</a></li><li><a href="#_sub2" class="code">function [data,gui] = importDataMouseCPMG(data,gui)</a></li><li><a href="#_sub3" class="code">function [data,gui] = importDataBGRmat(data,gui)</a></li><li><a href="#_sub4" class="code">function [data,gui] = importDataBGRliftSingle(data,gui)</a></li><li><a href="#_sub5" class="code">function [data,gui] = importDataBGRlift(data,gui)</a></li><li><a href="#_sub6" class="code">function [data,gui] = importDataBGRMouseT1T2(data,gui)</a></li><li><a href="#_sub7" class="code">function [data,gui] = importDataHeliosCPMG(data,gui)</a></li><li><a href="#_sub8" class="code">function [data,gui] = importDataHeliosSeries(data,gui)</a></li><li><a href="#_sub9" class="code">function [data,gui] = importDataDartSeries(data,gui)</a></li><li><a href="#_sub10" class="code">function [data,gui] = importDataDart(data,gui)</a></li><li><a href="#_sub11" class="code">function [data,gui] = importDataRoCAT1T2(data,gui)</a></li><li><a href="#_sub12" class="code">function [data,gui] = importDataGeneral(data,gui)</a></li><li><a href="#_sub13" class="code">function [data,gui] = importDataLIAG(data,gui)</a></li><li><a href="#_sub14" class="code">function [data,gui] = importDataLIAGcore(data,gui)</a></li><li><a href="#_sub15" class="code">function [data,gui] = importDataLIAGproject(data,gui)</a></li><li><a href="#_sub16" class="code">function [data,gui] = importDataMouse(data,gui)</a></li><li><a href="#_sub17" class="code">function [data,gui] = importDataMRSMatlab(data,gui)</a></li><li><a href="#_sub18" class="code">function [data,gui] = importDataIBAC(data,gui)</a></li><li><a href="#_sub19" class="code">function data = loadGUIParameters(datapath,fname)</a></li><li><a href="#_sub20" class="code">function data = loadGUIrawdata(data,NMRpath,NMRfile)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function importNMRdata(src)</a>
0002 <span class="comment">%importNMRdata is the general import routine for NMR data</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% Syntax:</span>
0005 <span class="comment">%       importNMRdata(src)</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% Inputs:</span>
0008 <span class="comment">%       src - handle of the calling menu</span>
0009 <span class="comment">%</span>
0010 <span class="comment">% Outputs:</span>
0011 <span class="comment">%       none</span>
0012 <span class="comment">%</span>
0013 <span class="comment">% Example:</span>
0014 <span class="comment">%       importNMRdata(src)</span>
0015 <span class="comment">%</span>
0016 <span class="comment">% Other m-files required:</span>
0017 <span class="comment">%       cleanupGUIData</span>
0018 <span class="comment">%       clearAllAxes</span>
0019 <span class="comment">%       displayStatusText</span>
0020 <span class="comment">%       enableGUIelements('NMR');</span>
0021 <span class="comment">%       LoadNMRData_driver</span>
0022 <span class="comment">%       NUCLEUSinv_updateInterface</span>
0023 <span class="comment">%</span>
0024 <span class="comment">% Subfunctions:</span>
0025 <span class="comment">%       getNMRPathFile</span>
0026 <span class="comment">%       importDataBGR</span>
0027 <span class="comment">%       importDataBGRmat</span>
0028 <span class="comment">%       importDataDart</span>
0029 <span class="comment">%       importDataGeneral</span>
0030 <span class="comment">%       importDataLIAG</span>
0031 <span class="comment">%       importDataLIAGproject</span>
0032 <span class="comment">%       importDataMouse</span>
0033 <span class="comment">%       importDataHelios</span>
0034 <span class="comment">%       loadGUIParameters</span>
0035 <span class="comment">%       loadGUIrawdata</span>
0036 <span class="comment">%</span>
0037 <span class="comment">% MAT-files required:</span>
0038 <span class="comment">%       none</span>
0039 <span class="comment">%</span>
0040 <span class="comment">% See also: NUCLEUSinv, NUCLEUSmod</span>
0041 <span class="comment">% Author: see AUTHORS.md</span>
0042 <span class="comment">% email: see AUTHORS.md</span>
0043 <span class="comment">% License: MIT License (at end)</span>
0044 
0045 <span class="comment">%------------- BEGIN CODE --------------</span>
0046 
0047 <span class="comment">%% get GUI handle and data</span>
0048 fig = findobj(<span class="string">'Tag'</span>,<span class="string">'INV'</span>);
0049 gui = getappdata(fig,<span class="string">'gui'</span>);
0050 data = getappdata(fig,<span class="string">'data'</span>);
0051 
0052 <span class="comment">% try is used to catch any import error</span>
0053 <span class="comment">% often the wrong input file format is the case</span>
0054 <span class="keyword">try</span>
0055     <span class="comment">% check what import format is chosen</span>
0056     label = get(src,<span class="string">'Label'</span>);
0057 
0058     <span class="comment">% set file format for later use</span>
0059     <span class="keyword">if</span> strcmp(label,<span class="string">'Dart (jrd)'</span>)
0060         data.import.fileformat = <span class="string">'dartjrd'</span>;
0061     <span class="keyword">elseif</span> strcmp(label,<span class="string">'BAM TOM'</span>)
0062         data.import.fileformat = <span class="string">'bamtom'</span>;
0063     <span class="keyword">elseif</span> strcmp(label,<span class="string">'BGR mat'</span>)
0064         data.import.fileformat = <span class="string">'bgrmat'</span>;
0065     <span class="keyword">elseif</span> strcmp(label,<span class="string">'BGR std'</span>)
0066         data.import.fileformat = <span class="string">'bgr'</span>;
0067     <span class="keyword">elseif</span> strcmp(label,<span class="string">'CoreLab ascii'</span>)
0068         data.import.fileformat = <span class="string">'corelab'</span>;
0069     <span class="keyword">elseif</span> strcmp(label,<span class="string">'DART'</span>)
0070         data.import.fileformat = <span class="string">'dart'</span>;
0071     <span class="keyword">elseif</span> strcmp(label,<span class="string">'GGE ascii'</span>)
0072         data.import.fileformat = <span class="string">'rwth'</span>;
0073     <span class="keyword">elseif</span> strcmp(label,<span class="string">'GGE field'</span>)
0074         data.import.fileformat = <span class="string">'field'</span>;
0075     <span class="keyword">elseif</span> strcmp(label,<span class="string">'GGE Dart'</span>)
0076         data.import.fileformat = <span class="string">'dart'</span>;
0077     <span class="keyword">elseif</span> strcmp(label,<span class="string">'HeliosCPMG'</span>)
0078         data.import.fileformat = <span class="string">'heliosCPMG'</span>;
0079     <span class="keyword">elseif</span> strcmp(label,<span class="string">'HeliosSeries'</span>)
0080         data.import.fileformat = <span class="string">'heliosSeries'</span>;
0081     <span class="keyword">elseif</span> strcmp(label,<span class="string">'LIAG core'</span>)
0082         data.import.fileformat = <span class="string">'liag'</span>;
0083     <span class="keyword">elseif</span> strcmp(label,<span class="string">'LIAG from project'</span>)
0084         data.import.fileformat = <span class="string">'liag'</span>;
0085     <span class="keyword">elseif</span> strcmp(label,<span class="string">'LIAG last project'</span>)
0086         data.import.fileformat = <span class="string">'liag'</span>;
0087     <span class="keyword">elseif</span> strcmp(label,<span class="string">'LIAG single'</span>)
0088         data.import.fileformat = <span class="string">'liag'</span>;
0089     <span class="keyword">elseif</span> strcmp(label,<span class="string">'MOUSE'</span>)
0090         data.import.fileformat = <span class="string">'mouse'</span>;
0091     <span class="keyword">elseif</span> strcmp(label,<span class="string">'MouseCPMG'</span>)
0092         data.import.fileformat = <span class="string">'MouseCPMG'</span>;
0093     <span class="keyword">elseif</span> strcmp(label,<span class="string">'MouseLift'</span>)
0094         data.import.fileformat = <span class="string">'MouseLift'</span>;
0095     <span class="keyword">elseif</span> strcmp(label,<span class="string">'MouseT1T2'</span>)
0096         data.import.fileformat = <span class="string">'MouseT1T2'</span>;
0097     <span class="keyword">elseif</span> strcmp(label,<span class="string">'MRSMatlab (FIT)'</span>)
0098         data.import.fileformat = <span class="string">'mrsd'</span>;
0099     <span class="keyword">elseif</span> strcmp(label,<span class="string">'PM5'</span>)
0100         data.import.fileformat = <span class="string">'pm5'</span>;
0101     <span class="keyword">elseif</span> strcmp(label,<span class="string">'PM25'</span>)
0102         data.import.fileformat = <span class="string">'pm25'</span>;
0103     <span class="keyword">elseif</span> strcmp(label,<span class="string">'RoCA T1T2'</span>)
0104         data.import.fileformat = <span class="string">'rocaT1T2'</span>;
0105     <span class="keyword">else</span>
0106         helpdlg(<span class="string">'Something is utterly wrong.'</span>,<span class="string">'onMenuImport: Choose again.'</span>);
0107     <span class="keyword">end</span>
0108 
0109     <span class="comment">% remove info field if any</span>
0110     ih = findobj(<span class="string">'Tag'</span>,<span class="string">'inv_info'</span>);
0111     <span class="keyword">if</span> ~isempty(ih); delete(ih); <span class="keyword">end</span>
0112 
0113     <span class="comment">% depending on the import format get the corresponding path / file</span>
0114     [NMRpath,NMRfile] = <a href="#_sub1" class="code" title="subfunction [NMRpath,NMRfile] = getNMRPathFile(label,import)">getNMRPathFile</a>(label,data.import);
0115 
0116     <span class="comment">% only continue if user didn't cancel</span>
0117     <span class="keyword">if</span> sum([NMRpath NMRfile]) &gt; 0
0118         <span class="comment">%  remove old fields and data</span>
0119         data = <a href="cleanupGUIData.html" class="code" title="function data = cleanupGUIData(data)">cleanupGUIData</a>(data);
0120 
0121         <span class="comment">% check for mat-file with GUI rawdata and import data</span>
0122         isfile = dir(fullfile(NMRpath,<span class="string">'NUCLEUSinv_raw.mat'</span>));
0123 
0124         <span class="comment">% if there is no raw-file import from folder/file</span>
0125         <span class="keyword">if</span> isempty(isfile)
0126             <span class="comment">% import data</span>
0127             data.import.path = NMRpath;
0128             data.import.file = -1;
0129             <a href="displayStatusText.html" class="code" title="function displayStatusText(gui,string)">displayStatusText</a>(gui,<span class="string">'Reading NMR Data ...'</span>);
0130             <span class="comment">% call the corresponding subroutines</span>
0131             <span class="keyword">switch</span> label
0132                 <span class="keyword">case</span> {<span class="string">'BAM TOM'</span>,<span class="string">'BGR std'</span>,<span class="string">'CoreLab ascii'</span>,<span class="string">'GGE ascii'</span>,<span class="keyword">...</span>
0133                         <span class="string">'GGE field'</span>}
0134                     [data,gui] = <a href="#_sub12" class="code" title="subfunction [data,gui] = importDataGeneral(data,gui)">importDataGeneral</a>(data,gui);
0135                 <span class="keyword">case</span> <span class="string">'GGE Dart'</span>
0136                     data.import.file = NMRfile;
0137                     <span class="comment">% the data in the example folder is an older type</span>
0138                     <span class="keyword">if</span> contains(NMRpath,<span class="string">'nucleus\example_data\dart'</span>)
0139                         data.import.version = 1;
0140                     <span class="keyword">else</span>
0141                         data.import.version = 2;
0142                     <span class="keyword">end</span>
0143                     [data,gui] = <a href="#_sub10" class="code" title="subfunction [data,gui] = importDataDart(data,gui)">importDataDart</a>(data,gui);
0144                 <span class="keyword">case</span> <span class="string">'DART'</span>
0145                     data.import.file = NMRfile;
0146                     data.import.version = 3;
0147                     [data,gui] = <a href="#_sub10" class="code" title="subfunction [data,gui] = importDataDart(data,gui)">importDataDart</a>(data,gui);
0148                 <span class="keyword">case</span> <span class="string">'MOUSE'</span>
0149                     [data,gui] = <a href="#_sub16" class="code" title="subfunction [data,gui] = importDataMouse(data,gui)">importDataMouse</a>(data,gui);
0150                 <span class="keyword">case</span> <span class="string">'LIAG single'</span>
0151                     [data,gui] = <a href="#_sub13" class="code" title="subfunction [data,gui] = importDataLIAG(data,gui)">importDataLIAG</a>(data,gui);
0152                 <span class="keyword">case</span> <span class="string">'LIAG core'</span>
0153                     [data,gui] = <a href="#_sub14" class="code" title="subfunction [data,gui] = importDataLIAGcore(data,gui)">importDataLIAGcore</a>(data,gui);
0154                 <span class="keyword">case</span> {<span class="string">'LIAG from project'</span>,<span class="string">'LIAG last project'</span>}
0155                     [data,gui] = <a href="#_sub15" class="code" title="subfunction [data,gui] = importDataLIAGproject(data,gui)">importDataLIAGproject</a>(data,gui);
0156                     <span class="comment">% make the Petro Panel visible as default</span>
0157                     tmp_h = gui.myui.heights(2,:);
0158                     tmp_h(3) = gui.myui.heights(2,3);
0159                     <span class="comment">% but the CPS panel stays minimized</span>
0160                     tmp_h(5) = gui.myui.heights(1,3);
0161                     set(gui.panels.main,<span class="string">'Heights'</span>,tmp_h);
0162                     set(gui.panels.petro.main,<span class="string">'Minimized'</span>,false);
0163                 <span class="keyword">case</span> <span class="string">'BGR mat'</span>
0164                     data.import.file = NMRfile;
0165                     [data,gui] = <a href="#_sub3" class="code" title="subfunction [data,gui] = importDataBGRmat(data,gui)">importDataBGRmat</a>(data,gui);
0166                 <span class="keyword">case</span> <span class="string">'MouseCPMG'</span>
0167                     [data,gui] = <a href="#_sub2" class="code" title="subfunction [data,gui] = importDataMouseCPMG(data,gui)">importDataMouseCPMG</a>(data,gui);
0168                 <span class="keyword">case</span> <span class="string">'MouseLift'</span>
0169                     [data,gui] = <a href="#_sub5" class="code" title="subfunction [data,gui] = importDataBGRlift(data,gui)">importDataBGRlift</a>(data,gui);
0170                 <span class="keyword">case</span> <span class="string">'MouseT1T2'</span>
0171                     [data,gui] = <a href="#_sub6" class="code" title="subfunction [data,gui] = importDataBGRMouseT1T2(data,gui)">importDataBGRMouseT1T2</a>(data,gui);
0172                 <span class="keyword">case</span> <span class="string">'HeliosCPMG'</span>
0173                     data.import.file = NMRfile;
0174                     [data,gui] = <a href="#_sub7" class="code" title="subfunction [data,gui] = importDataHeliosCPMG(data,gui)">importDataHeliosCPMG</a>(data,gui);
0175                 <span class="keyword">case</span> <span class="string">'HeliosSeries'</span>
0176                     data.import.file = NMRfile;
0177                     [data,gui] = <a href="#_sub8" class="code" title="subfunction [data,gui] = importDataHeliosSeries(data,gui)">importDataHeliosSeries</a>(data,gui);
0178                 <span class="keyword">case</span> {<span class="string">'PM5'</span>,<span class="string">'PM25'</span>}
0179                     data.import.file = NMRfile;
0180                     [data,gui] = <a href="#_sub18" class="code" title="subfunction [data,gui] = importDataIBAC(data,gui)">importDataIBAC</a>(data,gui);
0181                 <span class="keyword">case</span> <span class="string">'Dart (jrd)'</span>
0182                     data.import.file = NMRfile;
0183                     [data,gui] = <a href="#_sub9" class="code" title="subfunction [data,gui] = importDataDartSeries(data,gui)">importDataDartSeries</a>(data,gui);
0184                 <span class="keyword">case</span> <span class="string">'RoCA T1T2'</span>
0185                     data.import.file = NMRfile;
0186                     [data,gui] = <a href="#_sub11" class="code" title="subfunction [data,gui] = importDataRoCAT1T2(data,gui)">importDataRoCAT1T2</a>(data,gui);
0187                 <span class="keyword">case</span> <span class="string">'MRSMatlab (FIT)'</span>
0188                     data.import.file = NMRfile;
0189                     [data,gui] = <a href="#_sub17" class="code" title="subfunction [data,gui] = importDataMRSMatlab(data,gui)">importDataMRSMatlab</a>(data,gui);
0190             <span class="keyword">end</span>
0191             <a href="displayStatusText.html" class="code" title="function displayStatusText(gui,string)">displayStatusText</a>(gui,<span class="string">'Reading NMR Data ... done'</span>);
0192         <span class="keyword">else</span>
0193             <span class="comment">% import from mat-file</span>
0194             <a href="displayStatusText.html" class="code" title="function displayStatusText(gui,string)">displayStatusText</a>(gui,<span class="string">'Importing NMR raw data from mat-file ...'</span>);
0195             data = <a href="#_sub20" class="code" title="subfunction data = loadGUIrawdata(data,NMRpath,NMRfile)">loadGUIrawdata</a>(data,NMRpath,NMRfile);
0196             <a href="displayStatusText.html" class="code" title="function displayStatusText(gui,string)">displayStatusText</a>(gui,<span class="string">'Importing NMR raw data from mat-file ... done'</span>);
0197         <span class="keyword">end</span>
0198 
0199         <span class="comment">% update the path info field with &quot;NMRpath&quot; (&quot;NMRfile&quot;)</span>
0200         <span class="keyword">if</span> NMRfile &gt; 0
0201             tmpstr = fullfile(NMRpath,NMRfile);
0202         <span class="keyword">else</span>
0203             tmpstr = NMRpath;
0204         <span class="keyword">end</span>
0205         <span class="keyword">if</span> length(tmpstr)&gt;50
0206             set(gui.text_handles.data_path,<span class="string">'String'</span>,[<span class="string">'...'</span>,tmpstr(end-50:end)],<span class="keyword">...</span>
0207                 <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>);
0208         <span class="keyword">else</span>
0209             set(gui.text_handles.data_path,<span class="string">'String'</span>,tmpstr,<span class="keyword">...</span>
0210                 <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>);
0211         <span class="keyword">end</span>
0212         set(gui.text_handles.data_path,<span class="string">'TooltipString'</span>,tmpstr);
0213 
0214         <span class="comment">% update the ini-file</span>
0215         gui.myui.inidata.importpath = data.import.path;
0216         gui = <a href="makeINIfile.html" class="code" title="function gui = makeINIfile(gui,method)">makeINIfile</a>(gui,<span class="string">'update'</span>);
0217 
0218         <span class="comment">% update the list of file names</span>
0219         set(gui.listbox_handles.signal,<span class="string">'String'</span>,data.import.NMR.filesShort);
0220         set(gui.listbox_handles.signal,<span class="string">'Value'</span>,[],<span class="string">'Max'</span>,2,<span class="string">'Min'</span>,0);
0221 
0222         <span class="comment">% create a global INVdata struct for every file in the list</span>
0223         <span class="keyword">if</span> isstruct(getappdata(fig,<span class="string">'INVdata'</span>))
0224             setappdata(fig,<span class="string">'INVdata'</span>,[]);
0225         <span class="keyword">end</span>
0226         INVdata = cell(length(data.import.NMR.filesShort),1);
0227         setappdata(fig,<span class="string">'INVdata'</span>,INVdata);
0228 
0229         <span class="comment">% clear all axes</span>
0230         <a href="clearAllAxes.html" class="code" title="function clearAllAxes(figh)">clearAllAxes</a>(gui.figh);
0231 
0232         <span class="comment">% update GUI data and interface</span>
0233         setappdata(fig,<span class="string">'data'</span>,data);
0234         setappdata(fig,<span class="string">'gui'</span>,gui);
0235         <a href="enableGUIelements.html" class="code" title="function enableGUIelements(importtype)">enableGUIelements</a>(<span class="string">'NMR'</span>);
0236 
0237         <span class="comment">% special treatment of LIAG projects</span>
0238         <span class="keyword">switch</span> label
0239             <span class="keyword">case</span> {<span class="string">'LIAG from project'</span>,<span class="string">'LIAG last project'</span>}
0240                 cpath = data.import.LIAG.calibrationpath;
0241                 <span class="comment">% check if this calibration file was already used</span>
0242                 isfile = dir(fullfile(cpath,<span class="string">'NUCLEUS_calibData.mat'</span>));
0243                 <span class="keyword">if</span> ~isempty(isfile)
0244                     id = 2;
0245                     <span class="comment">% if data is there reuse it</span>
0246                     calib = load(fullfile(cpath,isfile.name),<span class="string">'calib'</span>);
0247                     INVdata{id} = calib.calib;
0248                     data.calib = INVdata{id}.calib;
0249                     data.import.LIAG.Tbulk = data.calib.Tbulk;<span class="comment">%INVdata{id}.results.invstd.T2;</span>
0250                     setappdata(fig,<span class="string">'INVdata'</span>,INVdata);
0251                     setappdata(fig,<span class="string">'data'</span>,data);
0252                     <span class="comment">% color the list entry</span>
0253                     strL = get(gui.listbox_handles.signal,<span class="string">'String'</span>);
0254                     str1 = strL{id};
0255                     str2 = [<span class="string">'&lt;HTML&gt;&lt;BODY bgcolor=&quot;rgb('</span>,<span class="keyword">...</span>
0256                         sprintf(<span class="string">'%d,%d,%d'</span>,gui.myui.colors.listINV.*255),<span class="string">')&quot;&gt;'</span>,<span class="keyword">...</span>
0257                         str1,<span class="string">'&lt;/BODY&gt;&lt;/HTML&gt;'</span>];
0258                     strL{id} = str2;
0259                     set(gui.listbox_handles.signal,<span class="string">'String'</span>,strL);
0260                 <span class="keyword">end</span>
0261             <span class="keyword">otherwise</span>
0262         <span class="keyword">end</span>
0263         <span class="comment">% update GUI interface</span>
0264         <a href="../../../nucleus/NUCLEUSinv/NUCLEUSinv_updateInterface.html" class="code" title="function NUCLEUSinv_updateInterface">NUCLEUSinv_updateInterface</a>;
0265         <span class="comment">% if the 2D window is open, update it</span>
0266         <span class="keyword">if</span> ~isempty(findobj(<span class="string">'Tag'</span>,<span class="string">'2DINV'</span>))
0267             <span class="comment">% but only if there is 2D data loaded</span>
0268             <span class="keyword">if</span> isfield(data.import,<span class="string">'T1T2map'</span>)
0269                 <a href="Inv2DView.html" class="code" title="function Inv2DView(src,~)">Inv2DView</a>(gui.menu.extra_T1T2map);
0270             <span class="keyword">else</span>
0271                 helpdlg({<span class="string">'function: importNMRdata'</span>,<span class="keyword">...</span>
0272                     <span class="string">'Careful: 2D GUI is open but 1D data set was imported'</span>},<span class="keyword">...</span>
0273                     <span class="string">'Import Notification'</span>);
0274             <span class="keyword">end</span>
0275         <span class="keyword">end</span>
0276     <span class="keyword">end</span>
0277 
0278 <span class="keyword">catch</span> ME
0279     <span class="comment">% show error message in case import fails</span>
0280     errmsg = {ME.message;[ME.stack(1).name,<span class="string">' Line: '</span>,num2str(ME.stack(1).line)];<span class="keyword">...</span>
0281         <span class="string">'Check File Format settings.'</span>};
0282     errordlg(errmsg,<span class="string">'importNMRdata: Error!'</span>);
0283 <span class="keyword">end</span>
0284 
0285 <span class="keyword">end</span>
0286 
0287 <span class="comment">%%</span>
0288 <a name="_sub1" href="#_subfunctions" class="code">function [NMRpath,NMRfile] = getNMRPathFile(label,import)</a>
0289 
0290 NMRpath = -1;
0291 NMRfile = -1;
0292 <span class="comment">% for almost all import cases we load a folder ... but not for all</span>
0293 <span class="keyword">switch</span> label
0294     <span class="keyword">case</span> {<span class="string">'BAM TOM'</span>,<span class="string">'BGR std'</span>,<span class="string">'CoreLab ascii'</span>,<span class="string">'GGE ascii'</span>,<span class="string">'GGE field'</span>,<span class="keyword">...</span>
0295             <span class="string">'HeliosCPMG'</span>,<span class="string">'HeliosSeries'</span>,<span class="string">'LIAG core'</span>,<span class="string">'LIAG single'</span>,<span class="keyword">...</span>
0296             <span class="string">'MOUSE'</span>,<span class="string">'MouseCPMG'</span>,<span class="string">'MouseLift'</span>,<span class="string">'MouseT1T2'</span>,<span class="string">'PM25'</span>,<span class="string">'Dart (jrd)'</span>,<span class="keyword">...</span>
0297             <span class="string">'RoCA T1T2'</span>}
0298         <span class="comment">% if there is already a data folder present we start from here</span>
0299         <span class="keyword">if</span> isfield(import,<span class="string">'path'</span>)
0300             NMRpath = uigetdir(import.path,<span class="string">'Choose Data Path'</span>);
0301         <span class="keyword">else</span>
0302             <span class="comment">% otherwise we start at the current working dircetory</span>
0303             <span class="comment">% 'NMRpath' holds the name of the choosen data path</span>
0304             here = mfilename(<span class="string">'fullpath'</span>);
0305             [pathstr,~,~] = fileparts(here);
0306             NMRpath = uigetdir(pathstr,<span class="string">'Choose Data Path'</span>);
0307         <span class="keyword">end</span>
0308     <span class="keyword">case</span> <span class="string">'LIAG from project'</span>
0309         <span class="comment">% if there is already a data folder present we start from here</span>
0310         <span class="keyword">if</span> isfield(import,<span class="string">'path'</span>)
0311             NMRpath = uigetdir(import.path,<span class="string">'Choose Project Path'</span>);
0312         <span class="keyword">else</span>
0313             <span class="comment">% otherwise we start at the current working dircetory</span>
0314             <span class="comment">% 'NMRpath' holds the name of the choosen data path</span>
0315             here = mfilename(<span class="string">'fullpath'</span>);
0316             [pathstr,~,~] = fileparts(here);
0317             NMRpath = uigetdir(pathstr,<span class="string">'Choose Project Path'</span>);
0318         <span class="keyword">end</span>
0319     <span class="keyword">case</span> <span class="string">'LIAG last project'</span>
0320         <span class="comment">% there is already a data folder and we use this one</span>
0321         <span class="keyword">if</span> isfield(import,<span class="string">'path'</span>)
0322             NMRpath = import.path;
0323         <span class="keyword">else</span>
0324             <span class="comment">% otherwise we start at the current working dircetory</span>
0325             <span class="comment">% 'NMRpath' holds the name of the choosen data path</span>
0326             here = mfilename(<span class="string">'fullpath'</span>);
0327             [pathstr,~,~] = fileparts(here);
0328             NMRpath = uigetdir(pathstr,<span class="string">'Choose Project Path'</span>);
0329         <span class="keyword">end</span>
0330     <span class="keyword">case</span> {<span class="string">'GGE Dart'</span>,<span class="string">'DART'</span>,<span class="string">'BGR mat'</span>,<span class="string">'NMR mat'</span>}
0331         <span class="comment">% if there is already a data folder present we start from here</span>
0332         <span class="keyword">if</span> isfield(import,<span class="string">'path'</span>)
0333             [NMRfile,NMRpath] = uigetfile(import.path,<span class="string">'Choose Data file'</span>);
0334         <span class="keyword">else</span>
0335             <span class="comment">% otherwise we start at the current working dircetory</span>
0336             <span class="comment">% 'foldername' hold s the name of the choosen data path</span>
0337             here = mfilename(<span class="string">'fullpath'</span>);
0338             [pathstr,~,~] = fileparts(here);
0339             [NMRfile,NMRpath] = uigetfile(pathstr,<span class="string">'Choose Data file'</span>);
0340         <span class="keyword">end</span>
0341     <span class="keyword">case</span> <span class="string">'MRSMatlab (FIT)'</span>
0342         <span class="comment">% if there is already a data folder present we start from here</span>
0343         <span class="keyword">if</span> isfield(import,<span class="string">'path'</span>)
0344             [NMRfile,NMRpath] = uigetfile(<span class="string">'*.mrsd'</span>,<span class="string">'Choose mrsd Data file'</span>,import.path);
0345         <span class="keyword">else</span>
0346             <span class="comment">% otherwise we start at the current working dircetory</span>
0347             <span class="comment">% 'foldername' hold s the name of the choosen data path</span>
0348             here = mfilename(<span class="string">'fullpath'</span>);
0349             [pathstr,~,~] = fileparts(here);
0350             [NMRfile,NMRpath] = uigetfile(<span class="string">'*.mrsd'</span>,<span class="string">'mrsd Choose Data file'</span>,pathstr);
0351         <span class="keyword">end</span>
0352     <span class="keyword">case</span> <span class="string">'PM5'</span>
0353         <span class="comment">% if there is already a data folder present we start from here</span>
0354         <span class="keyword">if</span> isfield(import,<span class="string">'path'</span>)
0355             NMRpath = uigetdir(import.path,<span class="string">'Choose PM5 Data Path'</span>);
0356         <span class="keyword">else</span>
0357             <span class="comment">% otherwise we start at the current working dircetory</span>
0358             <span class="comment">% 'NMRpath' holds the name of the choosen data path</span>
0359             here = mfilename(<span class="string">'fullpath'</span>);
0360             [pathstr,~,~] = fileparts(here);
0361             NMRpath = uigetdir(pathstr,<span class="string">'Choose PM5 Data Path'</span>);
0362         <span class="keyword">end</span>
0363 
0364         <span class="comment">% check if there are multiple inf-files available</span>
0365         <span class="comment">% if yes -&gt; choose one</span>
0366         inffiles = dir(fullfile(NMRpath,<span class="string">'*.inf'</span>));
0367         <span class="keyword">if</span> numel(inffiles) &gt; 1
0368             [NMRfile,NMRpath] = uigetfile(fullfile(NMRpath,<span class="string">'*.inf'</span>),<span class="keyword">...</span>
0369                 <span class="string">'Choose INF file'</span>);
0370         <span class="keyword">elseif</span> numel(inffiles) == 1
0371             NMRfile = inffiles.name;
0372         <span class="keyword">end</span>
0373 <span class="keyword">end</span>
0374 
0375 <span class="keyword">end</span>
0376 
0377 <span class="comment">%%</span>
0378 <a name="_sub2" href="#_subfunctions" class="code">function [data,gui] = importDataMouseCPMG(data,gui)</a>
0379 
0380 csv_t2path = dir(fullfile(data.import.path,<span class="string">'CPMG'</span>));
0381 csv_t2path = csv_t2path(~ismember({csv_t2path.name},{<span class="string">'.'</span>,<span class="string">'..'</span>}));
0382 
0383 fnames = struct;
0384 <span class="comment">% shownames is just a dummy to hold all data file names that</span>
0385 <span class="comment">% will be shown in the listbox</span>
0386 shownames = cell(1,1);
0387 
0388 c = 0;
0389 <span class="keyword">if</span> ~isempty(csv_t2path)
0390     <span class="keyword">for</span> i = 1:size(csv_t2path,1)
0391         in.T1T2 = <span class="string">'T2'</span>;
0392         in.path = fullfile(data.import.path,<span class="string">'CPMG'</span>,csv_t2path(i).name);
0393         in.fileformat = data.import.fileformat;
0394         out = <a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>(in);
0395 
0396         <span class="keyword">for</span> j = 1:size(out.nmrData,2)
0397             <span class="comment">% the individual file names</span>
0398             c = c + 1;
0399             fnames(c).parfile = <span class="string">'acqu.par'</span>;
0400             fnames(c).datafile = out.nmrData{j}.datfile;
0401             fnames(c).T2specfile = <span class="string">''</span>;
0402 
0403             shownames{c} = [<span class="string">'T2_'</span>,csv_t2path(i).name,<span class="string">'_'</span>,fnames(c).datafile];
0404 
0405             <span class="comment">% the NMR data</span>
0406             <span class="comment">% here we fix the time scale from [ms] to [s]</span>
0407             <span class="keyword">if</span> max(out.nmrData{j}.time) &gt; 100
0408                 out.nmrData{j}.time = out.nmrData{j}.time/1000;
0409                 out.nmrData{j}.raw.time = out.nmrData{j}.raw.time/1000;
0410             <span class="keyword">end</span>
0411             data.import.NMR.data{c} = out.nmrData{j};
0412             data.import.NMR.para{c} = out.parData;
0413         <span class="keyword">end</span>
0414     <span class="keyword">end</span>
0415 <span class="keyword">end</span>
0416 
0417 <span class="keyword">if</span> isempty(csv_t2path)
0418     helpdlg(<span class="string">'No data folders in the given directory.'</span>,<span class="string">'onMenuImport: No data.'</span>);
0419 <span class="keyword">else</span>
0420     <span class="comment">% update the global data structure</span>
0421     data.import.NMR.files = fnames;
0422     data.import.NMR.filesShort = shownames;
0423 <span class="keyword">end</span>
0424 
0425 <span class="keyword">end</span>
0426 
0427 <span class="comment">%%</span>
0428 <a name="_sub3" href="#_subfunctions" class="code">function [data,gui] = importDataBGRmat(data,gui)</a>
0429 
0430 in.path = fullfile(data.import.path);
0431 in.name = data.import.file;
0432 in.fileformat = data.import.fileformat;
0433 out = <a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>(in);
0434 
0435 fnames = struct;
0436 <span class="comment">% shownames is just a dummy to hold all data file names that</span>
0437 <span class="comment">% will be shown in the listbox</span>
0438 shownames = cell(1,1);
0439 
0440 c = 0;
0441 table = {true,0,1,<span class="string">'D'</span>};
0442 <span class="keyword">for</span> j = 1:size(out.nmrData,2)
0443     <span class="comment">% the individual file names</span>
0444     c = c + 1;
0445     fnames(c).parfile = <span class="string">''</span>;
0446     fnames(c).datafile = data.import.file;
0447     fnames(c).T2specfile = <span class="string">''</span>;
0448 
0449     shownames{c} = out.parData{j}.file;
0450 
0451     data.import.NMR.data{c} = out.nmrData{j};
0452     data.import.NMR.para{c} = out.parData{j};
0453 
0454     <span class="keyword">if</span> isfield(out,<span class="string">'pressData'</span>)
0455         <span class="comment">% convert hPa to Pa</span>
0456         table{c,1} = true;
0457         table{c,2} = out.pressData.p(j)*1e2;
0458         table{c,3} = out.pressData.S(j);
0459         table{c,4} = <span class="string">'D'</span>;
0460     <span class="keyword">end</span>
0461 <span class="keyword">end</span>
0462 
0463 <span class="comment">% global Tbulk</span>
0464 data.invstd.Tbulk = out.parData{1}.Tbulk;
0465 <span class="comment">% global porosity</span>
0466 data.import.BGR.porosity = out.parData{1}.porosity;
0467 
0468 data.import.NMR.files = fnames;
0469 data.import.NMR.filesShort = shownames;
0470 
0471 <span class="comment">% import pressure / saturation data</span>
0472 <span class="keyword">if</span> isfield(out,<span class="string">'pressData'</span>)
0473     data.pressure.unit = <span class="string">'kPa'</span>;
0474     data.pressure.unitfac = 1e-3;
0475     data.pressure.table = table;
0476 <span class="keyword">end</span>
0477 
0478 <span class="keyword">end</span>
0479 
0480 <span class="comment">%%</span>
0481 <a name="_sub4" href="#_subfunctions" class="code">function [data,gui] = importDataBGRliftSingle(data,gui)</a>
0482 
0483 <span class="comment">% first check whether T1 or T2 was measured...</span>
0484 <span class="comment">% by analyzing the name of data folder</span>
0485 ind = find(data.import.path == filesep);
0486 checkT1T2 = data.import.path(ind(end-1)+1:ind(end)-1);
0487 <span class="keyword">if</span> strcmp(checkT1T2,<span class="string">'t1test'</span>)
0488     in.T1T2 = <span class="string">'T1'</span>;
0489 <span class="keyword">elseif</span> strcmp(checkT1T2,<span class="string">'T1auto'</span>)
0490     in.T1T2 = <span class="string">'T1'</span>;
0491 <span class="keyword">elseif</span> strcmp(checkT1T2,<span class="string">'cpmgfastautotest'</span>)
0492     in.T1T2 = <span class="string">'T2'</span>;
0493 <span class="keyword">elseif</span> strcmp(checkT1T2,<span class="string">'cpmgfastauto'</span>)
0494     in.T1T2 = <span class="string">'T2'</span>;
0495 <span class="keyword">else</span>
0496     disp(<span class="string">'Please chose an original Prospa folder for Mouse Lift data!'</span>);
0497 <span class="keyword">end</span>
0498 
0499 <span class="comment">% % there should be folders with integer values in their names</span>
0500 <span class="comment">% t1t2path = data.import.path;</span>
0501 
0502 fnames = struct;
0503 <span class="comment">% shownames is just a dummy to hold all data file names that</span>
0504 <span class="comment">% will be shown in the listbox</span>
0505 shownames = cell(1,1);
0506 
0507 c = 0;
0508 <span class="keyword">if</span> ~isempty(data.import.path)
0509     <span class="comment">%    for i = 1:size(t1t2path,1)</span>
0510     in.path = data.import.path;
0511     in.fileformat = data.import.fileformat;
0512     out = <a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>(in);
0513 
0514     <span class="keyword">for</span> j = 1:size(out.nmrData,2)
0515         <span class="comment">% the individual file names</span>
0516         c = c + 1;
0517         fnames(c).parfile = <span class="string">'acq.par'</span>;
0518         fnames(c).datafile = out.nmrData{j}.datfile;
0519 
0520         shownames{c} = [in.T1T2,<span class="string">'_'</span>,fnames(c).datafile];
0521 
0522         <span class="comment">% the NMR data</span>
0523         <span class="comment">% here we fix the time scale from [ms] to [s]</span>
0524         <span class="keyword">if</span> max(out.nmrData{j}.time) &gt; 100
0525             out.nmrData{j}.time = out.nmrData{j}.time/1000;
0526             out.nmrData{j}.raw.time = out.nmrData{j}.raw.time/1000;
0527         <span class="keyword">end</span>
0528         data.import.NMR.data{c} = out.nmrData{j};
0529         data.import.NMR.para{c} = out.parData;
0530     <span class="keyword">end</span>
0531 <span class="keyword">else</span>
0532     helpdlg(<span class="string">'No data folders in the given directory.'</span>,<span class="string">'onMenuImport: No data.'</span>);
0533 <span class="keyword">end</span>
0534 
0535 <span class="comment">% update the global data structure</span>
0536 data.import.NMR.files = fnames;
0537 data.import.NMR.filesShort = shownames;
0538 
0539 <span class="keyword">end</span>
0540 
0541 <span class="comment">%%</span>
0542 <a name="_sub5" href="#_subfunctions" class="code">function [data,gui] = importDataBGRlift(data,gui)</a>
0543 
0544 <span class="comment">% 1) show all folders and ask for sample</span>
0545 subdirs = dir(data.import.path);
0546 <span class="comment">% remove the dot-dirs</span>
0547 subdirs = subdirs(~ismember({subdirs.name},{<span class="string">'.'</span>,<span class="string">'..'</span>}));
0548 
0549 fnames = {subdirs.name};
0550 [indx,~] = listdlg(<span class="string">'PromptString'</span>,<span class="string">'Choose data set:'</span>,<span class="keyword">...</span>
0551     <span class="string">'SelectionMode'</span>,<span class="string">'multiple'</span>,<span class="keyword">...</span>
0552     <span class="string">'ListString'</span>,fnames);
0553 
0554 <span class="comment">% first check whether T1 or T2 was measured</span>
0555 ind = find(data.import.path == filesep);
0556 checkT1T2 = data.import.path(ind(end)+1:end);
0557 <span class="keyword">if</span> strcmp(checkT1T2,<span class="string">'t1test'</span>)
0558     in.T1T2 = <span class="string">'T1'</span>;
0559 <span class="keyword">elseif</span> strcmp(checkT1T2,<span class="string">'T1auto'</span>)
0560     in.T1T2 = <span class="string">'T1'</span>;
0561 <span class="keyword">elseif</span> strcmp(checkT1T2,<span class="string">'cpmgfastautotest'</span>)
0562     in.T1T2 = <span class="string">'T2'</span>;
0563 <span class="keyword">elseif</span> strcmp(checkT1T2,<span class="string">'cpmgfastauto'</span>)
0564     in.T1T2 = <span class="string">'T2'</span>;
0565 <span class="keyword">else</span>
0566     helpdlg(<span class="string">'No original data folder'</span>,<span class="string">'onMenuImport: No data.'</span>);
0567 <span class="keyword">end</span>
0568 
0569 <span class="comment">% now ask for stacking</span>
0570 answer = questdlg(<span class="string">'Do you want to stack the slices?'</span>);
0571 <span class="keyword">switch</span> answer
0572     <span class="keyword">case</span> <span class="string">'Yes'</span>
0573         doSliceStack = true;
0574         <span class="comment">% if stacking ask for stack-rotate-order</span>
0575         answer = questdlg(<span class="string">'Select stack-rotate-order:'</span>,<span class="keyword">...</span>
0576             <span class="string">'Select order'</span>, <span class="keyword">...</span>
0577             <span class="string">'stack-rotate (default)'</span>,<span class="string">'rotate-stack'</span>,<span class="string">'Cancel'</span>,<span class="string">'stack-rotate (default)'</span>);
0578         <span class="keyword">switch</span> answer
0579             <span class="keyword">case</span> <span class="string">'stack-rotate'</span>
0580                 StackFirst = true;
0581             <span class="keyword">case</span> <span class="string">'rotate-stack'</span>
0582                 StackFirst = false;
0583             <span class="keyword">otherwise</span>
0584                 StackFirst = true;
0585         <span class="keyword">end</span>
0586     <span class="keyword">otherwise</span>
0587         doSliceStack = false;
0588 <span class="keyword">end</span>
0589 
0590 fnames = struct;
0591 <span class="comment">% shownames is just a dummy to hold all data file names that</span>
0592 <span class="comment">% will be shown in the listbox</span>
0593 shownames = cell(1,1);
0594 
0595 c = 0;
0596 <span class="keyword">if</span> ~isempty(indx)
0597     <span class="keyword">for</span> i = indx
0598         in.path = fullfile(data.import.path,subdirs(i).name);
0599         in.fileformat = data.import.fileformat;
0600         out = <a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>(in);
0601 
0602         <span class="keyword">if</span> doSliceStack
0603             <span class="comment">% the individual file names</span>
0604             c = c + 1;
0605             fnames(c).parfile = <span class="string">'acq.par'</span>;
0606             fnames(c).datafile = out.nmrData{1}.datfile;
0607 
0608             shownames{c} = [in.T1T2,<span class="string">'_'</span>,subdirs(i).name];
0609 
0610             <span class="comment">% use the meta data from the first slice</span>
0611             <span class="comment">% fix the time scale from [ms] to [s]</span>
0612             <span class="keyword">if</span> max(out.nmrData{1}.time) &gt; 100
0613                 out.nmrData{1}.time = out.nmrData{1}.time/1000;
0614                 out.nmrData{1}.raw.time = out.nmrData{1}.raw.time/1000;
0615             <span class="keyword">end</span>
0616             <span class="comment">% import into GUI data struct</span>
0617             data.import.NMR.data{c} = out.nmrData{1};
0618 
0619             <span class="comment">% stacking</span>
0620             <span class="keyword">for</span> j = 1:size(out.nmrData,2)
0621                 <span class="keyword">if</span> j == 1
0622                     signal = out.nmrData{j}.signal;
0623                 <span class="keyword">else</span>
0624                     signal = signal + out.nmrData{j}.signal;
0625                 <span class="keyword">end</span>
0626             <span class="keyword">end</span>
0627             signal = signal./size(out.nmrData,2);
0628 
0629             <span class="comment">% now rotate after the stacking</span>
0630             <span class="keyword">if</span> StackFirst
0631                 [signal,phase] = <a href="../../../nucleus/functions/import/rotateT2phase.html" class="code" title="function [s_rot,alpha] = rotateT2phase(s,varargin)">rotateT2phase</a>(signal);
0632                 data.import.NMR.data{c}.phase = phase;
0633                 data.import.NMR.data{c}.signal = signal;
0634                 data.import.NMR.data{c}.raw.signal = signal;
0635             <span class="keyword">else</span>
0636                 <span class="comment">% no rotation after stacking</span>
0637                 data.import.NMR.data{c}.signal = signal;
0638                 data.import.NMR.data{c}.raw.signal = signal;
0639             <span class="keyword">end</span>
0640 
0641             <span class="comment">% parameter data</span>
0642             data.import.NMR.para{c} = out.parData;
0643         <span class="keyword">else</span>
0644 
0645             <span class="keyword">for</span> j = 1:size(out.nmrData,2)
0646                 <span class="comment">% the individual file names</span>
0647                 c = c + 1;
0648                 fnames(c).parfile = <span class="string">'acq.par'</span>;
0649                 fnames(c).datafile = out.nmrData{j}.datfile;
0650 
0651                 shownames{c} = [in.T1T2,<span class="string">'_'</span>,subdirs(i).name,<span class="string">'_'</span>,fnames(c).datafile];
0652 
0653                 <span class="comment">% the NMR data</span>
0654                 <span class="comment">% here we fix the time scale from [ms] to [s]</span>
0655                 <span class="keyword">if</span> max(out.nmrData{j}.time) &gt; 100
0656                     out.nmrData{j}.time = out.nmrData{j}.time/1000;
0657                     out.nmrData{j}.raw.time = out.nmrData{j}.raw.time/1000;
0658                 <span class="keyword">end</span>
0659                 data.import.NMR.data{c} = out.nmrData{j};
0660                 data.import.NMR.para{c} = out.parData;
0661             <span class="keyword">end</span>
0662         <span class="keyword">end</span>
0663     <span class="keyword">end</span>
0664 <span class="keyword">else</span>
0665     helpdlg(<span class="string">'No data folders in the given directory.'</span>,<span class="string">'onMenuImport: No data.'</span>);
0666 <span class="keyword">end</span>
0667 
0668 <span class="comment">% update the global data structure</span>
0669 data.import.NMR.files = fnames;
0670 data.import.NMR.filesShort = shownames;
0671 
0672 <span class="keyword">end</span>
0673 
0674 <span class="comment">%%</span>
0675 <a name="_sub6" href="#_subfunctions" class="code">function [data,gui] = importDataBGRMouseT1T2(data,gui)</a>
0676 
0677 <span class="comment">% first ask the user if it is a series of T1 measurements or one T1T2map</span>
0678 answer = questdlg(<span class="string">'Is this a series of T1 measurements or one T1-T2 map?'</span>, <span class="keyword">...</span>
0679     <span class="string">'Mouse T1T2 import'</span>,<span class="string">'T1 series'</span>,<span class="string">'T1-T2 map'</span>,<span class="string">'T1-T2 map'</span>);
0680 <span class="keyword">switch</span> answer
0681     <span class="keyword">case</span> <span class="string">'T1 series'</span>
0682         is_T1 = true;
0683     <span class="keyword">case</span> <span class="string">'T1-T2 map'</span>
0684         is_T1 = false;
0685     <span class="keyword">otherwise</span>
0686         is_T1 = false;
0687 <span class="keyword">end</span>
0688 
0689 <span class="comment">% there should be some folders with names ...</span>
0690 <span class="comment">% ... similar to the data filenames inside them</span>
0691 datpath = dir(data.import.path);
0692 datpath = datpath(~ismember({datpath.name},{<span class="string">'.'</span>,<span class="string">'..'</span>}));
0693 
0694 fnames = struct;
0695 <span class="comment">% shownames is just a dummy to hold all data file names that</span>
0696 <span class="comment">% will be shown in the listbox</span>
0697 shownames = cell(1,1);
0698 
0699 <span class="comment">% ask the user for the amount of T2 echoes to sum for the T1 curve</span>
0700 prompt = {<span class="string">'Enter T2 #echos for one T1 point'</span>};
0701 dlgtitle = <span class="string">'How many T2 echos'</span>;
0702 fieldsize = [1 45];
0703 <span class="keyword">if</span> is_T1
0704     definput = {<span class="string">'30'</span>};
0705 <span class="keyword">else</span>
0706     definput = {<span class="string">'3'</span>};
0707 <span class="keyword">end</span>
0708 answer = inputdlg(prompt,dlgtitle,fieldsize,definput);
0709 Nechos = str2double(answer{1});
0710 
0711 <span class="keyword">if</span> is_T1
0712     <span class="comment">% load a series of T1-T2 data and extract only the T1 curves</span>
0713     c = 0;
0714     <span class="keyword">if</span> ~isempty(datpath)
0715         content = datpath;
0716         <span class="keyword">for</span> j = 1:size(content,1)
0717             in.T1T2 = <span class="string">'T2'</span>;
0718             in.name = <span class="string">'data2D.dat'</span>;
0719             in.path = fullfile(data.import.path,content(j).name);
0720             in.fileformat = data.import.fileformat;
0721             in.importflag = <span class="string">'T1'</span>;
0722             in.Nechos = Nechos;
0723             out = <a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>(in);
0724 
0725             <span class="keyword">for</span> j1 = 1:numel(out.nmrData)
0726                 <span class="comment">% the individual file names</span>
0727                 c = c + 1;
0728                 fnames(c).parfile = <span class="string">'acqu.par'</span>;
0729                 fnames(c).datafile = out.nmrData{j1}.datfile;
0730                 fnames(c).T2specfile = <span class="string">''</span>;
0731 
0732                 shownames{c} = [<span class="string">'T1_'</span>,content(j).name];
0733 
0734                 data.import.NMR.data{c} = out.nmrData{j1};
0735                 data.import.NMR.para{c} = out.parData;
0736             <span class="keyword">end</span>
0737 
0738         <span class="keyword">end</span>
0739     <span class="keyword">end</span>
0740 <span class="keyword">else</span>
0741     <span class="comment">% load a single T1-T2 data set</span>
0742     c = 0;
0743     <span class="keyword">if</span> ~isempty(datpath)
0744         content = datpath;
0745         <span class="keyword">for</span> j = 1:size(content,1)
0746             <span class="keyword">if</span> strcmp(content(j).name,<span class="string">'data2D.dat'</span>)
0747                 in.T1T2 = <span class="string">'T2'</span>;
0748                 in.name = content(j).name;
0749                 in.path = fullfile(data.import.path);
0750                 in.fileformat = data.import.fileformat;
0751                 in.importflag = <span class="string">'T1T2map'</span>;
0752                 out = <a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>(in);
0753 
0754                 <span class="keyword">for</span> j1 = 1:numel(out.nmrData)
0755                     <span class="comment">% the individual file names</span>
0756                     c = c + 1;
0757                     fnames(c).parfile = <span class="string">'acqu.par'</span>;
0758                     fnames(c).datafile = out.nmrData{j1}.datfile;
0759                     fnames(c).T2specfile = <span class="string">''</span>;
0760 
0761                     shownames{c} = [<span class="string">'T2_'</span>,content(j).name,<span class="string">'_'</span>,sprintf(<span class="string">'%03d'</span>,j1)];
0762 
0763                     data.import.NMR.data{c} = out.nmrData{j1};
0764                     data.import.NMR.para{c} = out.parData;
0765                 <span class="keyword">end</span>
0766             <span class="keyword">end</span>
0767         <span class="keyword">end</span>
0768 
0769         <span class="comment">% save the recovery time vector for later use</span>
0770         t_recov = out.parData.T1Axis;
0771         t2 = out.parData.T2Axis;
0772         t2N = numel(t2);
0773         data.import.T1T2map.t_recov = t_recov(:);
0774         data.import.T1T2map.t1N = numel(t_recov);
0775         data.import.T1T2map.t2 = t2;
0776         data.import.T1T2map.t2N = t2N;
0777 
0778         <span class="comment">% add the stacked signal to the data</span>
0779         flag = <span class="string">'T1'</span>;
0780         time = data.import.T1T2map.t_recov;
0781         signal = zeros(numel(data.import.NMR.data),1);
0782         <span class="keyword">for</span> i1 = 1:numel(data.import.NMR.data)
0783             signal(i1) = mean(real(data.import.NMR.data{i1}.signal(1:Nechos)));
0784         <span class="keyword">end</span>
0785 
0786         disp(<span class="string">'NUCLUESinv import: Estimating noise from exponential fit ...'</span>);
0787         param.T1IRfac = 1;
0788         param.noise = 0;
0789         param.optim = <span class="string">'off'</span>;
0790         param.Tfixed_bool = [0 0 0 0 0];
0791         param.Tfixed_val = [0 0 0 0 0];
0792         <span class="keyword">for</span> i1 = 1:5
0793             invstd = <a href="../../../nucleus/functions/inversion/fitDataFree.html" class="code" title="function [fitdata] = fitDataFree(time,signal,flag,parameter,nExp)">fitDataFree</a>(time,signal,flag,param,i1);
0794             <span class="keyword">if</span> i1 == 1
0795                 noise = invstd.rms;
0796             <span class="keyword">else</span>
0797                 noise = min([noise invstd.rms]);
0798             <span class="keyword">end</span>
0799         <span class="keyword">end</span>
0800         disp(<span class="string">'NUCLUESinv import: done.'</span>)
0801 
0802         <span class="comment">% finally create a new &quot;import&quot; data set</span>
0803         data_new = data.import.NMR.data(1);
0804         para_new = data.import.NMR.para(1);
0805 
0806         data_new{1}.flag = flag;
0807         data_new{1}.T1IRfac = param.T1IRfac;
0808         data_new{1}.time = time;
0809         data_new{1}.signal = signal;
0810         data_new{1}.noise = noise;
0811         data_new{1}.raw.time = time;
0812         data_new{1}.raw.signal = signal;
0813 
0814         data.import.NMR.data{c+1} = data_new{1};
0815         data.import.NMR.para{c+1} = para_new{1};
0816         fnames(c+1).datafile = <span class="string">'T1_merged.dat'</span>;
0817         shownames{c+1} = <span class="string">'T1_merged'</span>;
0818         <span class="comment">% set global echo time</span>
0819         data.inv2D.prop.te = data.import.NMR.para{1}.echoTime/1e6; <span class="comment">% [s]</span>
0820         <span class="comment">% set T1 SR/IR factor</span>
0821         data.inv2D.inv.T1IRfac = 1; <span class="comment">% PM25 Mouse does SR</span>
0822     <span class="keyword">end</span>
0823 
0824 <span class="keyword">end</span>
0825 
0826 <span class="comment">% update the global data structure</span>
0827 data.import.NMR.files = fnames;
0828 data.import.NMR.filesShort = shownames;
0829 <span class="keyword">end</span>
0830 
0831 <span class="comment">%%</span>
0832 <a name="_sub7" href="#_subfunctions" class="code">function [data,gui] = importDataHeliosCPMG(data,gui)</a>
0833 
0834 <span class="comment">% first check the subpaths</span>
0835 <span class="comment">% there should be some folders with names ...</span>
0836 <span class="comment">% ... similar to the data filenames inside them</span>
0837 datpath = dir(data.import.path);
0838 datpath = datpath(~ismember({datpath.name},{<span class="string">'.'</span>,<span class="string">'..'</span>}));
0839 
0840 fnames = struct;
0841 <span class="comment">% shownames is just a dummy to hold all data file names that</span>
0842 <span class="comment">% will be shown in the listbox</span>
0843 shownames = cell(1,1);
0844 
0845 c = 0;
0846 <span class="keyword">if</span> ~isempty(datpath)
0847     <span class="keyword">for</span> i = 1:size(datpath,1)
0848         <span class="comment">% does datpath.name points to a folder?</span>
0849         <span class="keyword">if</span> datpath(i).isdir
0850             <span class="comment">% check if datpath.name includes regular Helios data files</span>
0851             content = dir([data.import.path,filesep,datpath(i).name]);
0852             content = content(~ismember({content.name},{<span class="string">'.'</span>,<span class="string">'..'</span>}));
0853             <span class="comment">% only keep hrd-files</span>
0854             content = content(contains({content.name},<span class="string">'.hrd'</span>));
0855             <span class="comment">% remove reference hrd-files</span>
0856             content = content(~contains({content.name},<span class="string">'_ref.hrd'</span>));
0857             <span class="keyword">for</span> j = 1:size(content,1)
0858                 in.T1T2 = <span class="string">'T2'</span>;
0859                 in.name = content(j).name;
0860                 in.path = fullfile(data.import.path,filesep,datpath(i).name);
0861                 in.fileformat = data.import.fileformat;
0862                 out = <a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>(in);
0863 
0864                 <span class="comment">% the individual file names</span>
0865                 c = c + 1;
0866                 fnames(c).parfile = <span class="string">''</span>;
0867                 fnames(c).datafile = out.nmrData.datfile;
0868                 fnames(c).T2specfile = <span class="string">''</span>;
0869                 shownames{c} = [<span class="string">'T2_'</span>,datpath(i).name];
0870 
0871                 data.import.NMR.data{c} = out.nmrData;
0872                 data.import.NMR.para{c} = out.parData;
0873             <span class="keyword">end</span>
0874         <span class="keyword">end</span>
0875     <span class="keyword">end</span>
0876 <span class="keyword">end</span>
0877 
0878 <span class="comment">% update the global data structure</span>
0879 data.import.NMR.files = fnames;
0880 data.import.NMR.filesShort = shownames;
0881 
0882 <span class="keyword">end</span>
0883 
0884 <span class="comment">%%</span>
0885 <a name="_sub8" href="#_subfunctions" class="code">function [data,gui] = importDataHeliosSeries(data,gui)</a>
0886 
0887 <span class="comment">% first ask the user if it is pure T2 data or T2 data belonging to a T1</span>
0888 <span class="comment">% measurement to generate T1-T2 maps</span>
0889 answer = questdlg(<span class="string">'Is this series a T1 measurement or pure T2?'</span>, <span class="keyword">...</span>
0890     <span class="string">'HELIOS import'</span>, <span class="keyword">...</span>
0891     <span class="string">'T1'</span>,<span class="string">'T2'</span>,<span class="string">'T2'</span>);
0892 <span class="keyword">switch</span> answer
0893     <span class="keyword">case</span> <span class="string">'T1'</span>
0894         is_T1 = true;
0895     <span class="keyword">case</span> <span class="string">'T2'</span>
0896         is_T1 = false;
0897     <span class="keyword">otherwise</span>
0898         is_T1 = false;
0899 <span class="keyword">end</span>
0900 
0901 <span class="comment">% now ask for manualS stacking (only for T2 data)</span>
0902 <span class="keyword">if</span> ~is_T1
0903     answer = questdlg(<span class="string">'Do you want to stack several files?'</span>,<span class="string">'Stack Dialog'</span>,<span class="string">'No'</span>);
0904     <span class="keyword">switch</span> answer
0905         <span class="keyword">case</span> <span class="string">'Yes'</span>
0906             doStack = true;
0907             prompt = {<span class="string">'Enter No. of files to stack together'</span>};
0908             dlgtitle = <span class="string">'Stack Value'</span>;
0909             fieldsize = [1 40];
0910             definput = {<span class="string">'16'</span>};
0911             answer2 = inputdlg(prompt,dlgtitle,fieldsize,definput);
0912             <span class="keyword">if</span> ~isempty(answer2)
0913                 nstacks = str2double(answer2{1,1});
0914             <span class="keyword">else</span>
0915                 doStack = false;
0916             <span class="keyword">end</span>
0917         <span class="keyword">otherwise</span>
0918             doStack = false;
0919     <span class="keyword">end</span>
0920 <span class="keyword">end</span>
0921 
0922 <span class="comment">% now check the subpaths</span>
0923 <span class="comment">% there should be some folders with names ...</span>
0924 <span class="comment">% ... similar to the data filenames inside them</span>
0925 datpath = dir(data.import.path);
0926 datpath = datpath(~ismember({datpath.name},{<span class="string">'.'</span>,<span class="string">'..'</span>}));
0927 <span class="comment">% remove any subfolder within the data directory</span>
0928 datpath = datpath(~ismember([datpath.isdir],true));
0929 <span class="comment">% only keep hrd-files</span>
0930 datpath = datpath(contains({datpath.name},<span class="string">'.hrd'</span>));
0931 <span class="comment">% remove reference hrd-files</span>
0932 datpath = datpath(~contains({datpath.name},<span class="string">'_ref.hrd'</span>));
0933 <span class="comment">% remove duplicate hrd-files</span>
0934 datpath = datpath(~contains({datpath.name},<span class="string">'.dup'</span>));
0935 
0936 fnames = struct;
0937 <span class="comment">% shownames is just a dummy to hold all data file names that</span>
0938 <span class="comment">% will be shown in the listbox</span>
0939 shownames = cell(1,1);
0940 
0941 c = 0;
0942 <span class="keyword">if</span> ~isempty(datpath)
0943     content = datpath;
0944     <span class="keyword">if</span> is_T1
0945         t_recov = zeros(floor(numel(content)/2),2);
0946     <span class="keyword">end</span>
0947     <span class="keyword">for</span> j = 1:size(content,1)
0948         in.T1T2 = <span class="string">'T2'</span>;
0949         in.name = content(j).name;
0950         in.path = fullfile(data.import.path);
0951         in.fileformat = data.import.fileformat;
0952         out = <a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>(in);
0953         <span class="comment">% the individual file names</span>
0954         c = c + 1;
0955         fnames(c).parfile = <span class="string">''</span>;
0956         fnames(c).datafile = out.nmrData.datfile;
0957         fnames(c).T2specfile = <span class="string">''</span>;
0958         <span class="keyword">if</span> is_T1
0959             shownames{c} = content(j).name;
0960         <span class="keyword">else</span>
0961             shownames{c} = [<span class="string">'T2_'</span>,content(j).name];
0962         <span class="keyword">end</span>
0963 
0964         data.import.NMR.data{c} = out.nmrData;
0965         data.import.NMR.para{c} = out.parData;
0966 
0967         <span class="comment">% collect recovery times in case of T1 data set</span>
0968         <span class="keyword">if</span> is_T1
0969             t_recov(c,1) = out.parData.t_recov;
0970             t_recov(c,2) = out.nmrData.phase;
0971         <span class="keyword">end</span>
0972     <span class="keyword">end</span>
0973 
0974     <span class="comment">% in case of T1 data, use the phase of the signal with the longest</span>
0975     <span class="comment">% recovery time to rotate the other signals</span>
0976     <span class="keyword">if</span> is_T1
0977         phase = t_recov(t_recov(:,1)==max(t_recov(:,1)),2);
0978         <span class="keyword">for</span> i1 = 1:numel(data.import.NMR.data)
0979             <span class="comment">% the original raw data</span>
0980             s = data.import.NMR.data{i1}.raw.signal;
0981             s =  s * exp(1i*(-data.import.NMR.data{i1}.phase));
0982             <span class="comment">% s_rot is the rotated signal</span>
0983             s_rot = s .* exp(1i*phase);
0984             <span class="comment">% write the rotated signal back to the data struct</span>
0985             data.import.NMR.data{i1}.signal = s_rot;
0986             data.import.NMR.data{i1}.phase = phase;
0987 
0988             <span class="comment">% get the shortest T2 signal length</span>
0989             <span class="keyword">if</span> i1 == 1
0990                 t2N = numel(data.import.NMR.data{i1}.raw.time);
0991             <span class="keyword">else</span>
0992                 t2N = min([t2N numel(data.import.NMR.data{i1}.raw.time)]);
0993             <span class="keyword">end</span>
0994             t2 = data.import.NMR.data{i1}.raw.time(1:t2N);
0995         <span class="keyword">end</span>
0996 
0997         <span class="comment">% for convenience, sort the data by recovery time</span>
0998         [t_s,ix] = sort(t_recov(:,1));
0999         data.import.NMR.data = data.import.NMR.data(ix);
1000         data.import.NMR.para = data.import.NMR.para(ix);
1001         fnames = fnames(ix);
1002         shownames = shownames(ix);
1003 
1004         <span class="comment">% save the recovery time vector for later use</span>
1005         data.import.T1T2map.t_recov = t_s(:,1)/1000;
1006         data.import.T1T2map.t1N = numel(data.import.T1T2map.t_recov);
1007         data.import.T1T2map.t2 = t2;
1008         data.import.T1T2map.t2N = t2N;
1009 
1010         <span class="comment">% ask if the single measurements should be &quot;stacked&quot; to one T1</span>
1011         <span class="comment">% curve</span>
1012         answer = questdlg(<span class="string">'Do you want a single T1 curve or a T1-T2 map?'</span>, <span class="keyword">...</span>
1013             <span class="string">'HELIOS import'</span>, <span class="keyword">...</span>
1014             <span class="string">'single T1'</span>,<span class="string">'T1-T2 map'</span>,<span class="string">'T1-T2 map'</span>);
1015         <span class="keyword">switch</span> answer
1016             <span class="keyword">case</span> <span class="string">'single T1'</span>
1017                 singleT1 = true;
1018             <span class="keyword">case</span> <span class="string">'T1-T2 map'</span>
1019                 singleT1 = false;
1020         <span class="keyword">end</span>
1021 
1022         <span class="keyword">if</span> singleT1
1023             <span class="comment">% ask how many T2-echos should be stacked together to one T1</span>
1024             <span class="comment">% point</span>
1025             prompt = {<span class="string">'Enter T2 #echos for one T1 point'</span>};
1026             dlgtitle = <span class="string">'How many T2 echos'</span>;
1027             fieldsize = [1 45];
1028             definput = {<span class="string">'3'</span>};
1029             answer = inputdlg(prompt,dlgtitle,fieldsize,definput);
1030             Nechos = str2double(answer{1});
1031 
1032             flag = <span class="string">'T1'</span>;
1033             time = data.import.T1T2map.t_recov;
1034             signal = zeros(numel(data.import.NMR.data),1);
1035             <span class="keyword">for</span> i1 = 1:numel(data.import.NMR.data)
1036                 signal(i1) = mean(real(data.import.NMR.data{i1}.signal(1:Nechos)));
1037             <span class="keyword">end</span>
1038 
1039             disp(<span class="string">'NUCLUESinv import: Estimating noise from exponential fit ...'</span>);
1040             param.T1IRfac = 2;
1041             param.noise = 0;
1042             param.optim = data.info.has_optim;
1043             param.Tfixed_bool = [0 0 0 0 0];
1044             param.Tfixed_val = [0 0 0 0 0];
1045             <span class="keyword">for</span> i1 = 1:5
1046                 invstd = <a href="../../../nucleus/functions/inversion/fitDataFree.html" class="code" title="function [fitdata] = fitDataFree(time,signal,flag,parameter,nExp)">fitDataFree</a>(time,signal,flag,param,i1);
1047                 <span class="keyword">if</span> i1 == 1
1048                     noise = invstd.rms;
1049                 <span class="keyword">else</span>
1050                     noise = min([noise invstd.rms]);
1051                 <span class="keyword">end</span>
1052             <span class="keyword">end</span>
1053             disp(<span class="string">'NUCLUESinv import: done.'</span>)
1054 
1055             <span class="comment">% finally create a new &quot;import&quot; data set</span>
1056             data_new = data.import.NMR.data(1);
1057             para_new = data.import.NMR.para(1);
1058             <span class="comment">% remove the 2D data</span>
1059             data.import = rmfield(data.import,<span class="string">'T1T2map'</span>);
1060 
1061             data_new{1}.flag = flag;
1062             data_new{1}.T1IRfac = param.T1IRfac;
1063             data_new{1}.time = time;
1064             data_new{1}.signal = signal;
1065             data_new{1}.noise = noise;
1066             data_new{1}.raw.time = time;
1067             data_new{1}.raw.signal = signal;
1068 
1069             <span class="comment">% use the last sub folder as name</span>
1070             pn = regexp(datpath(1).folder, filesep, <span class="string">'split'</span>);
1071 
1072             fnames = fnames(1);
1073             shownames = shownames(1);
1074             shownames{1} = [pn{end},<span class="string">'_T1_merged'</span>];
1075 
1076             data.import.NMR.data = data_new;
1077             data.import.NMR.para = para_new;
1078         <span class="keyword">else</span>
1079             prompt = {<span class="string">'Enter T2 #echos for one T1 point for the merged T1 curve'</span>};
1080             dlgtitle = <span class="string">'How many T2 echos'</span>;
1081             fieldsize = [1 45];
1082             definput = {<span class="string">'3'</span>};
1083             answer = inputdlg(prompt,dlgtitle,fieldsize,definput);
1084             Nechos = str2double(answer{1});
1085 
1086             <span class="comment">% add the stacked signal to the data</span>
1087             flag = <span class="string">'T1'</span>;
1088             time = data.import.T1T2map.t_recov;
1089             signal = zeros(numel(data.import.NMR.data),1);
1090             <span class="keyword">for</span> i1 = 1:numel(data.import.NMR.data)
1091                 signal(i1) = mean(real(data.import.NMR.data{i1}.signal(1:Nechos)));
1092             <span class="keyword">end</span>
1093 
1094             disp(<span class="string">'NUCLUESinv import: Estimating noise from exponential fit ...'</span>);
1095             param.T1IRfac = 2;
1096             param.noise = 0;
1097             param.optim = <span class="string">'off'</span>;
1098             param.Tfixed_bool = [0 0 0 0 0];
1099             param.Tfixed_val = [0 0 0 0 0];
1100             <span class="keyword">for</span> i1 = 1:5
1101                 invstd = <a href="../../../nucleus/functions/inversion/fitDataFree.html" class="code" title="function [fitdata] = fitDataFree(time,signal,flag,parameter,nExp)">fitDataFree</a>(time,signal,flag,param,i1);
1102                 <span class="keyword">if</span> i1 == 1
1103                     noise = invstd.rms;
1104                 <span class="keyword">else</span>
1105                     noise = min([noise invstd.rms]);
1106                 <span class="keyword">end</span>
1107             <span class="keyword">end</span>
1108             disp(<span class="string">'NUCLUESinv import: done.'</span>)
1109 
1110             <span class="comment">% finally create a new &quot;import&quot; data set</span>
1111             data_new = data.import.NMR.data(1);
1112             para_new = data.import.NMR.para(1);
1113 
1114             data_new{1}.flag = flag;
1115             data_new{1}.T1IRfac = param.T1IRfac;
1116             data_new{1}.time = time;
1117             data_new{1}.signal = signal;
1118             data_new{1}.noise = noise;
1119             data_new{1}.raw.time = time;
1120             data_new{1}.raw.signal = signal;
1121 
1122             data.import.NMR.data{numel(t_s)+1} = data_new{1};
1123             data.import.NMR.para{numel(t_s)+1} = para_new{1};
1124             fnames(numel(t_s)+1).datafile = <span class="string">'T1_merged.dat'</span>;
1125             shownames{numel(t_s)+1} = <span class="string">'T1_merged'</span>;
1126             <span class="comment">% set global echo time</span>
1127             data.inv2D.prop.te = data.import.NMR.para{1}.t_echo;
1128             <span class="comment">% set T1 SR/IR factor</span>
1129             data.inv2D.inv.T1IRfac = 2; <span class="comment">% Helios default</span>
1130         <span class="keyword">end</span>
1131     <span class="keyword">else</span> <span class="comment">% pure T2 data</span>
1132         <span class="comment">% do restacking if desired</span>
1133         <span class="keyword">if</span> doStack
1134             <span class="comment">% before stacking, sort the data by date (time)</span>
1135             N = length(shownames);
1136             time = zeros(N,1);
1137             <span class="keyword">for</span> i = 1:N
1138                 time(i,1) = data.import.NMR.data{i}.datenum;
1139             <span class="keyword">end</span>
1140             [~,ix] = sort(time);
1141             <span class="comment">% now apply changes - resort the imported data</span>
1142             data.import.NMR.data = {data.import.NMR.data{ix'}}; <span class="comment">%#ok&lt;*CCAT1&gt;</span>
1143             data.import.NMR.para = {data.import.NMR.para{ix'}};
1144             fnames = fnames(ix);
1145             shownames = {shownames{ix'}};
1146 
1147             c = 0;
1148             <span class="comment">% prepare data variables</span>
1149             datanew = cell(1,1);
1150             paranew = cell(1,1);
1151             fnamesnew = fnames(1);
1152             shownamesnew = cell(1,1);
1153             tmp_signal = zeros(size(data.import.NMR.data{1}.signal));
1154             <span class="comment">% loop over all already imported files</span>
1155             <span class="keyword">for</span> i1 = 1:numel(fnames)
1156                 <span class="comment">% stack up files</span>
1157                 tmp_signal = tmp_signal + data.import.NMR.data{i1}.signal;
1158                 <span class="comment">% check if stack count is reached</span>
1159                 <span class="keyword">if</span> mod(i1,nstacks)==0
1160                     <span class="comment">% current stack has finished</span>
1161                     c = c + 1;
1162                     <span class="comment">% save data</span>
1163                     datanew{c} = data.import.NMR.data{i1};
1164                     datanew{c}.signal = tmp_signal./nstacks;
1165                     datanew{c}.raw.signal = tmp_signal./nstacks;
1166 
1167                     paranew{c} = data.import.NMR.para{i1};
1168                     paranew{c}.Nscans = paranew{c}.Nscans*nstacks;
1169                     paranew{c}.all{1,1}{6} = [<span class="string">'Nscans = '</span>,num2str(paranew{c}.Nscans)];
1170 
1171                     fnamesnew(c) = fnames(i1);
1172                     shownamesnew{c} = [shownames{i1},<span class="string">'_'</span>,num2str(nstacks)];
1173 
1174                     <span class="comment">% reset the tmp_signal to zero</span>
1175                     tmp_signal = zeros(size(data.import.NMR.data{1}.signal));
1176                 <span class="keyword">end</span>
1177             <span class="keyword">end</span>
1178             data.import.NMR.data = datanew;
1179             data.import.NMR.para = paranew;
1180 
1181             fnames = fnamesnew;
1182             shownames = shownamesnew;
1183         <span class="keyword">end</span>
1184     <span class="keyword">end</span>
1185 <span class="keyword">end</span>
1186 
1187 <span class="comment">% update the global data structure</span>
1188 data.import.NMR.files = fnames;
1189 data.import.NMR.filesShort = shownames;
1190 
1191 <span class="keyword">end</span>
1192 
1193 <span class="comment">%%</span>
1194 <a name="_sub9" href="#_subfunctions" class="code">function [data,gui] = importDataDartSeries(data,gui)</a>
1195 
1196 <span class="comment">% first ask the user if it is pure T2 data or T2 data belonging to a T1</span>
1197 <span class="comment">% measurement to generate a T1 signal or a T1-T2 map</span>
1198 answer = questdlg(<span class="string">'What kind of data you want to import?'</span>, <span class="keyword">...</span>
1199     <span class="string">'DART import'</span>, <span class="keyword">...</span>
1200     <span class="string">'single T1'</span>,<span class="string">'T1-T2 map'</span>,<span class="string">'T2 (log)'</span>,<span class="string">'T2 (log)'</span>);
1201 <span class="keyword">switch</span> answer
1202     <span class="keyword">case</span> <span class="string">'single T1'</span>
1203         is_T1 = true;
1204         singleT1 = true;
1205     <span class="keyword">case</span> <span class="string">'T1-T2 map'</span>
1206         is_T1 = true;
1207         singleT1 = false;
1208     <span class="keyword">otherwise</span>
1209         is_T1 = false;
1210         singleT1 = false;
1211 <span class="keyword">end</span>
1212 
1213 <span class="comment">% now check the subpaths</span>
1214 <span class="comment">% there should be some folders with names ...</span>
1215 <span class="comment">% ... similar to the data filenames inside them</span>
1216 datpath = dir(data.import.path);
1217 datpath = datpath(~ismember({datpath.name},{<span class="string">'.'</span>,<span class="string">'..'</span>}));
1218 <span class="comment">% remove any subfolder within the data directory</span>
1219 datpath = datpath(~ismember([datpath.isdir],true));
1220 
1221 fnames = struct;
1222 <span class="comment">% shownames is just a dummy to hold all data file names that</span>
1223 <span class="comment">% will be shown in the listbox</span>
1224 shownames = cell(1,1);
1225 
1226 useburst = 0;
1227 stackfreq = 1;
1228 c = 0;
1229 <span class="keyword">if</span> ~isempty(datpath)
1230     content = datpath;
1231     <span class="keyword">if</span> is_T1
1232         t_recov = zeros(1,2);
1233     <span class="keyword">else</span>
1234         depth = zeros(1,1);
1235     <span class="keyword">end</span>
1236     <span class="keyword">for</span> j = 1:size(content,1)
1237         <span class="keyword">if</span> strcmp(content(j).name(end-3:end),<span class="string">'.jrd'</span>)
1238             c = c + 1;
1239 
1240             in.T1T2 = <span class="string">'T2'</span>;
1241             in.name = content(j).name;
1242             in.path = fullfile(data.import.path);
1243             in.fileformat = data.import.fileformat;
1244             in.version = 4;
1245             out = <a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>(in);
1246             
1247             <span class="comment">% ask for burst usage and frequency stacking</span>
1248             <span class="keyword">if</span> c == 1 &amp; out.hasburst == 1
1249                 answer = questdlg(<span class="string">'Do you want to use the burst?'</span>, <span class="keyword">...</span>
1250                 <span class="string">'DART import'</span>, <span class="keyword">...</span>
1251                 <span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'Yes'</span>);
1252                 <span class="keyword">switch</span> answer
1253                     <span class="keyword">case</span> <span class="string">'Yes'</span>
1254                         useburst = 1;
1255                     <span class="keyword">otherwise</span>
1256                         useburst = 0;
1257                 <span class="keyword">end</span>
1258             <span class="keyword">end</span>
1259             <span class="keyword">if</span> c == 1 &amp; out.Nfreq &gt; 1
1260                 answer = questdlg(<span class="string">'Do you want to stack frequencies?'</span>, <span class="keyword">...</span>
1261                 <span class="string">'DART import'</span>, <span class="keyword">...</span>
1262                 <span class="string">'F1 only'</span>,<span class="string">'F2 only'</span>,<span class="string">'F1+F2'</span>,<span class="string">'F1+F2'</span>);
1263                 <span class="keyword">switch</span> answer
1264                     <span class="keyword">case</span> <span class="string">'F1 only'</span>
1265                         stackfreq = 1;
1266                     <span class="keyword">case</span> <span class="string">'F2 only'</span>
1267                         stackfreq = 2;
1268                     <span class="keyword">case</span> <span class="string">'F1+F2'</span>
1269                         stackfreq = 3;
1270                 <span class="keyword">end</span>
1271             <span class="keyword">end</span>
1272 
1273             <span class="keyword">if</span> useburst
1274                 <span class="keyword">for</span> i1 = 1:numel(out.nmrData)/2
1275                     sig = real(out.nmrData{i1}.signal);
1276                     burst = real(out.nmrData{i1+out.Nfreq}.signal);
1277                     
1278                     burst_echoes = out.parData{i1+out.Nfreq}.n_echo;
1279                     ms = mean(sig(2:burst_echoes));
1280                     mb = mean(burst(2:burst_echoes));
1281 
1282                     burst_shift = complex(burst+(ms-mb),imag(out.nmrData{i1+out.Nfreq}.signal));
1283                     out.nmrData{i1}.signal(1:burst_echoes) = burst_shift;
1284                     out.nmrData{i1}.raw.signal = out.nmrData{i1}.signal;
1285                 <span class="keyword">end</span>
1286             <span class="keyword">end</span>
1287 
1288             <span class="keyword">if</span> stackfreq == 1
1289                 fnames(c).parfile = <span class="string">''</span>;
1290                 fnames(c).datafile = out.nmrData{1}.datfile;
1291                 fnames(c).T2specfile = <span class="string">''</span>;
1292                 shownames{c} = content(j).name;
1293                 data.import.NMR.data{c} = out.nmrData{1};
1294                 data.import.NMR.para{c} = out.parData{1};
1295 
1296             <span class="keyword">elseif</span> stackfreq == 2
1297                 fnames(c).parfile = <span class="string">''</span>;
1298                 fnames(c).datafile = out.nmrData{2}.datfile;
1299                 fnames(c).T2specfile = <span class="string">''</span>;
1300                 shownames{c} = content(j).name;
1301                 data.import.NMR.data{c} = out.nmrData{2};
1302                 data.import.NMR.para{c} = out.parData{2};
1303 
1304             <span class="keyword">elseif</span> stackfreq == 3
1305                 fnames(c).parfile = <span class="string">''</span>;
1306                 fnames(c).datafile = out.nmrData{1}.datfile;
1307                 fnames(c).T2specfile = <span class="string">''</span>;
1308                 shownames{c} = content(j).name;
1309 
1310                 tmp1 = out.nmrData{1};
1311                 tmp2 = out.nmrData{2};
1312                 signal = (tmp1.signal + tmp2.signal)./2;
1313                 
1314                 out.nmrData{1}.signal = signal;
1315                 out.nmrData{1}.raw.signal = signal;
1316                 data.import.NMR.data{c} = out.nmrData{1};
1317                 data.import.NMR.para{c} = out.parData{1};
1318             <span class="keyword">end</span>            
1319 
1320             <span class="comment">% collect recovery times in case of T1 data set</span>
1321             <span class="keyword">if</span> is_T1
1322                 t_recov(c,1) = out.parData{1}.t_recov;
1323                 t_recov(c,2) = out.nmrData{1}.phase;
1324             <span class="keyword">else</span>
1325                 <span class="comment">% try to collect depth values</span>
1326                 depth(c,1) = data.import.NMR.para{c}.depth;
1327             <span class="keyword">end</span>
1328         <span class="keyword">end</span>
1329     <span class="keyword">end</span>
1330 
1331     <span class="comment">% in case if T1 data, use the phase of the signal with the longest</span>
1332     <span class="comment">% recovery time to rotate the other signals</span>
1333     <span class="keyword">if</span> is_T1
1334         phase = t_recov(t_recov(:,1)==max(t_recov(:,1)),2);
1335         <span class="keyword">for</span> i1 = 1:numel(data.import.NMR.data)
1336             <span class="comment">% the original raw data</span>
1337             s = data.import.NMR.data{i1}.raw.signal;
1338             <span class="comment">% s_rot is the rotated signal</span>
1339             s_rot = s .* exp(1i*phase);
1340             <span class="comment">% write the rotated signal back to the data struct</span>
1341             data.import.NMR.data{i1}.signal = s_rot;
1342             data.import.NMR.data{i1}.phase = phase;
1343 
1344             <span class="comment">% get the shortest T2 signal length</span>
1345             <span class="keyword">if</span> i1 == 1
1346                 t2N = numel(data.import.NMR.data{i1}.raw.time);
1347             <span class="keyword">else</span>
1348                 t2N = min([t2N numel(data.import.NMR.data{i1}.raw.time)]);
1349             <span class="keyword">end</span>
1350             t2 = data.import.NMR.data{i1}.raw.time(1:t2N);
1351         <span class="keyword">end</span>
1352 
1353         <span class="comment">% for convenience, sort the data by recovery time</span>
1354         [t_s,ix] = sort(t_recov(:,1));
1355         data.import.NMR.data = data.import.NMR.data(ix);
1356         data.import.NMR.para = data.import.NMR.para(ix);
1357         fnames = fnames(ix);
1358         shownames = shownames(ix);
1359 
1360         <span class="comment">% save the recovery time vector for later use</span>
1361         data.import.T1T2map.t_recov = t_s(:,1)/1000;
1362         data.import.T1T2map.t1N = numel(data.import.T1T2map.t_recov);
1363         data.import.T1T2map.t2 = t2;
1364         data.import.T1T2map.t2N = t2N;
1365 
1366         <span class="comment">% ask how many T2-echos should be stacked together to one T1</span>
1367         <span class="comment">% point</span>
1368         prompt = {<span class="string">'Enter T2 #echos for one T1 point for the merged T1 curve'</span>};
1369         dlgtitle = <span class="string">'How many T2 echos'</span>;
1370         fieldsize = [1 45];
1371         definput = {<span class="string">'3'</span>};
1372         answer = inputdlg(prompt,dlgtitle,fieldsize,definput);
1373         Nechos = str2double(answer{1});
1374 
1375         flag = <span class="string">'T1'</span>;
1376         time = data.import.T1T2map.t_recov;
1377         signal = zeros(numel(data.import.NMR.data),1);
1378         <span class="keyword">for</span> i1 = 1:numel(data.import.NMR.data)
1379             signal(i1) = mean(real(data.import.NMR.data{i1}.signal(1:Nechos)));
1380         <span class="keyword">end</span>
1381 
1382         disp(<span class="string">'NUCLUESinv import: Estimating noise from exponential fit ...'</span>);
1383         param.T1IRfac = 1;
1384         param.noise = 0;
1385         param.optim = <span class="string">'off'</span>;
1386         param.Tfixed_bool = [0 0 0 0 0];
1387         param.Tfixed_val = [0 0 0 0 0];
1388         <span class="keyword">for</span> i1 = 1:5
1389             invstd = <a href="../../../nucleus/functions/inversion/fitDataFree.html" class="code" title="function [fitdata] = fitDataFree(time,signal,flag,parameter,nExp)">fitDataFree</a>(time,signal,flag,param,i1);
1390             <span class="keyword">if</span> i1 == 1
1391                 noise = invstd.rms;
1392             <span class="keyword">else</span>
1393                 noise = min([noise invstd.rms]);
1394             <span class="keyword">end</span>
1395         <span class="keyword">end</span>
1396         disp(<span class="string">'NUCLUESinv import: done.'</span>)
1397 
1398         <span class="keyword">if</span> singleT1
1399             <span class="comment">% finally create a new &quot;import&quot; data set</span>
1400             data_new = data.import.NMR.data(1);
1401             para_new = data.import.NMR.para(1);
1402             data.import = rmfield(data.import,<span class="string">'T1T2map'</span>);
1403 
1404             data_new{1}.flag = flag;
1405             data_new{1}.T1IRfac = param.T1IRfac;
1406             data_new{1}.time = time;
1407             data_new{1}.signal = signal;
1408             data_new{1}.noise = noise;
1409             data_new{1}.raw.time = time;
1410             data_new{1}.raw.signal = signal;
1411 
1412             fnames = fnames(1);
1413             shownames = {<span class="string">'T1_merged'</span>};
1414 
1415             data.import.NMR.data = data_new;
1416             data.import.NMR.para = para_new;
1417         <span class="keyword">else</span>
1418             <span class="comment">% finally create a new &quot;import&quot; data set</span>
1419             data_new = data.import.NMR.data(1);
1420             para_new = data.import.NMR.para(1);
1421 
1422             data_new{1}.flag = flag;
1423             data_new{1}.T1IRfac = param.T1IRfac;
1424             data_new{1}.time = time;
1425             data_new{1}.signal = signal;
1426             data_new{1}.noise = noise;
1427             data_new{1}.raw.time = time;
1428             data_new{1}.raw.signal = signal;
1429 
1430             data.import.NMR.data{numel(t_s)+1} = data_new{1};
1431             data.import.NMR.para{numel(t_s)+1} = para_new{1};
1432             fnames(numel(t_s)+1).datafile = <span class="string">'T1_merged.dat'</span>;
1433             shownames{numel(t_s)+1} = <span class="string">'T1_merged'</span>;
1434             <span class="comment">% set global echo time</span>
1435             data.inv2D.prop.te = data.import.NMR.para{1}.t_echo;
1436             <span class="comment">% set T1 SR/IR factor</span>
1437             data.inv2D.inv.T1IRfac = 1; <span class="comment">% Dart default</span>
1438         <span class="keyword">end</span>
1439     <span class="keyword">else</span>
1440         <span class="comment">% T2 data</span>
1441         data.import.BAM.use_z = true;
1442         data.import.BAM.z_unit = <span class="string">'m'</span>;
1443         data.import.BAM.zslice = depth - data.import.NMR.para{1}.stick_up_height;
1444         <span class="keyword">for</span> i1 = 1:numel(shownames)
1445             tmp = shownames{i1};
1446             shownames{i1} = [<span class="string">'z:'</span>,sprintf(<span class="string">'%05.2f'</span>,depth(i1)),<span class="string">'m '</span>,tmp];
1447         <span class="keyword">end</span>
1448     <span class="keyword">end</span>
1449 <span class="keyword">end</span>
1450 
1451 <span class="comment">% update the global data structure</span>
1452 data.import.NMR.files = fnames;
1453 data.import.NMR.filesShort = shownames;
1454 
1455 <span class="keyword">end</span>
1456 
1457 <span class="comment">%%</span>
1458 <a name="_sub10" href="#_subfunctions" class="code">function [data,gui] = importDataDart(data,gui)</a>
1459 
1460 in.path = fullfile(data.import.path);
1461 in.name = data.import.file;
1462 in.fileformat = data.import.fileformat;
1463 in.version = data.import.version;
1464 out = <a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>(in);
1465 
1466 fnames = struct;
1467 <span class="comment">% shownames is just a dummy to hold all data file names that</span>
1468 <span class="comment">% will be shown in the listbox</span>
1469 shownames = cell(1,1);
1470 
1471 c = 0;
1472 <span class="keyword">for</span> j = 1:size(out.nmrData,2)
1473     <span class="comment">% the individual file names</span>
1474     c = c + 1;
1475     fnames(c).parfile = <span class="string">''</span>;
1476     fnames(c).datafile = data.import.file;
1477     fnames(c).T2specfile = <span class="string">''</span>;
1478 
1479     shownames{c} = [<span class="string">'depth_'</span>,sprintf(<span class="string">'%04.3f'</span>,out.parData{j}.depth)];
1480 
1481     <span class="comment">% the NMR data</span>
1482     <span class="comment">% here we fix the time scale from [ms] to [s]</span>
1483     <span class="keyword">if</span> max(out.nmrData{j}.time) &gt; 100
1484         out.nmrData{j}.time = out.nmrData{j}.time/1000;
1485         out.nmrData{j}.raw.time = out.nmrData{j}.raw.time/1000;
1486     <span class="keyword">end</span>
1487     data.import.NMR.data{c} = out.nmrData{j};
1488     data.import.NMR.para{c} = out.parData{j};
1489 <span class="keyword">end</span>
1490 
1491 <span class="comment">% update the global data structure</span>
1492 data.import.NMR.files = fnames;
1493 data.import.NMR.filesShort = shownames;
1494 
1495 <span class="keyword">end</span>
1496 
1497 <span class="comment">%%</span>
1498 <a name="_sub11" href="#_subfunctions" class="code">function [data,gui] = importDataRoCAT1T2(data,gui)</a>
1499 
1500 <span class="comment">% there should be some folders with names ...</span>
1501 <span class="comment">% ... similar to the data filenames inside them</span>
1502 datpath = dir(data.import.path);
1503 datpath = datpath(~ismember({datpath.name},{<span class="string">'.'</span>,<span class="string">'..'</span>}));
1504 <span class="comment">% remove any subfolder within the data directory</span>
1505 datpath = datpath(~ismember([datpath.isdir],true));
1506 
1507 fnames = struct;
1508 <span class="comment">% shownames is just a dummy to hold all data file names that</span>
1509 <span class="comment">% will be shown in the listbox</span>
1510 shownames = cell(1,1);
1511 
1512 c = 0;
1513 <span class="keyword">if</span> ~isempty(datpath)
1514     content = datpath;
1515     <span class="keyword">for</span> j = 1:size(content,1)
1516         <span class="keyword">if</span> strcmp(content(j).name,<span class="string">'data2.csv'</span>)
1517             in.T1T2 = <span class="string">'T2'</span>;
1518             in.name = content(j).name;
1519             in.path = fullfile(data.import.path);
1520             in.fileformat = data.import.fileformat;
1521             out = <a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>(in);
1522 
1523             <span class="keyword">for</span> j1 = 1:numel(out.nmrData)
1524                 <span class="comment">% the individual file names</span>
1525                 c = c + 1;
1526                 fnames(c).parfile = <span class="string">'acqu.par'</span>;
1527                 fnames(c).datafile = out.nmrData{j1}.datfile;
1528                 fnames(c).T2specfile = <span class="string">''</span>;
1529 
1530                 shownames{c} = [<span class="string">'T2_'</span>,content(j).name,<span class="string">'_'</span>,sprintf(<span class="string">'%03d'</span>,j1)];
1531 
1532                 data.import.NMR.data{c} = out.nmrData{j1};
1533                 data.import.NMR.para{c} = out.parData;
1534             <span class="keyword">end</span>
1535         <span class="keyword">end</span>
1536     <span class="keyword">end</span>
1537 
1538     <span class="comment">% save the recovery time vector for later use</span>
1539     t2 = data.import.NMR.data{1}.time;
1540     t2N = numel(t2);
1541     t_recov = logspace(log10(out.parData.minTau),log10(out.parData.maxTau),out.parData.tauSteps);
1542     data.import.T1T2map.t_recov = t_recov(:)./1e3; <span class="comment">% to [s]</span>
1543     data.import.T1T2map.t1N = numel(data.import.T1T2map.t_recov);
1544     data.import.T1T2map.t2 = t2;
1545     data.import.T1T2map.t2N = t2N;
1546 
1547     <span class="comment">% add the stacked signal to the data</span>
1548     Nechos = 1;
1549     flag = <span class="string">'T1'</span>;
1550     time = data.import.T1T2map.t_recov;
1551     signal = zeros(numel(data.import.NMR.data),1);
1552     <span class="keyword">for</span> i1 = 1:numel(data.import.NMR.data)
1553         signal(i1) = mean(real(data.import.NMR.data{i1}.signal(1:Nechos)));
1554     <span class="keyword">end</span>
1555 
1556     disp(<span class="string">'NUCLUESinv import: Estimating noise from exponential fit ...'</span>);
1557     param.T1IRfac = 2;
1558     param.noise = 0;
1559     param.optim = <span class="string">'off'</span>;
1560     param.Tfixed_bool = [0 0 0 0 0];
1561     param.Tfixed_val = [0 0 0 0 0];
1562     <span class="keyword">for</span> i1 = 1:5
1563         invstd = <a href="../../../nucleus/functions/inversion/fitDataFree.html" class="code" title="function [fitdata] = fitDataFree(time,signal,flag,parameter,nExp)">fitDataFree</a>(time,signal,flag,param,i1);
1564         <span class="keyword">if</span> i1 == 1
1565             noise = invstd.rms;
1566         <span class="keyword">else</span>
1567             noise = min([noise invstd.rms]);
1568         <span class="keyword">end</span>
1569     <span class="keyword">end</span>
1570     disp(<span class="string">'NUCLUESinv import: done.'</span>)
1571 
1572     <span class="comment">% finally create a new &quot;import&quot; data set</span>
1573     data_new = data.import.NMR.data(1);
1574     para_new = data.import.NMR.para(1);
1575 
1576     data_new{1}.flag = flag;
1577     data_new{1}.T1IRfac = param.T1IRfac;
1578     data_new{1}.time = time;
1579     data_new{1}.signal = signal;
1580     data_new{1}.noise = noise;
1581     data_new{1}.raw.time = time;
1582     data_new{1}.raw.signal = signal;
1583 
1584     data.import.NMR.data{c+1} = data_new{1};
1585     data.import.NMR.para{c+1} = para_new{1};
1586     fnames(c+1).datafile = <span class="string">'T1_merged.dat'</span>;
1587     shownames{c+1} = <span class="string">'T1_merged'</span>;
1588     <span class="comment">% set global echo time</span>
1589     data.inv2D.prop.te = data.import.NMR.para{1}.echoTime/1e6; <span class="comment">% [s]</span>
1590     <span class="comment">% set T1 SR/IR factor</span>
1591     data.inv2D.inv.T1IRfac = 2; <span class="comment">% Rock Core Analyzer default(?)</span>
1592 <span class="keyword">end</span>
1593 
1594 <span class="comment">% update the global data structure</span>
1595 data.import.NMR.files = fnames;
1596 data.import.NMR.filesShort = shownames;
1597 <span class="keyword">end</span>
1598 
1599 <span class="comment">%%</span>
1600 <a name="_sub12" href="#_subfunctions" class="code">function [data,gui] = importDataGeneral(data,gui)</a>
1601 
1602 <span class="comment">% look for all files ending with '.par'</span>
1603 <span class="comment">% should exist for T1 and T2 measurements</span>
1604 filenames = dir(fullfile(data.import.path,<span class="string">'*.par'</span>));
1605 
1606 fnames = struct;
1607 <span class="comment">% shownames is just a dummy to hold all data file names that</span>
1608 <span class="comment">% will be shown in the listbox</span>
1609 shownames = cell(1,1);
1610 
1611 <span class="comment">% loop over all found files and import the data</span>
1612 c = 0;
1613 in.path = data.import.path;
1614 <span class="keyword">for</span> i = 1:size(filenames,1)
1615     ind = strfind(filenames(i).name,<span class="string">'.'</span>);
1616     ind = max(ind);
1617     in.name = filenames(i).name(1:ind-1);
1618     in.fileformat = data.import.fileformat;
1619     out = <a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>(in);
1620 
1621     <span class="keyword">for</span> j = 1:size(out.nmrData,2)
1622         <span class="comment">% the individual file names</span>
1623         c = c + 1;
1624         fnames(c).parfile = filenames(i).name;
1625         fnames(c).datafile = out.nmrData{j}.datfile;
1626         <span class="keyword">if</span> strcmp(out.nmrData{j}.flag,<span class="string">'T2'</span>) &amp;&amp; isfield(out.nmrData{j},<span class="string">'specfile'</span>)
1627             fnames(c).T2specfile = out.nmrData{j}.specfile;
1628         <span class="keyword">else</span>
1629             fnames(c).T2specfile = <span class="string">''</span>;
1630         <span class="keyword">end</span>
1631         shownames{c} = fnames(c).datafile;
1632 
1633         <span class="comment">% the NMR data</span>
1634         <span class="comment">% here we fix the time scale from [ms] to [s]</span>
1635         <span class="keyword">if</span> max(out.nmrData{j}.time) &gt; 100
1636             out.nmrData{j}.time = out.nmrData{j}.time/1000;
1637             out.nmrData{j}.raw.time = out.nmrData{j}.raw.time/1000;
1638         <span class="keyword">end</span>
1639         data.import.NMR.data{c} = out.nmrData{j};
1640         data.import.NMR.para{c} = out.parData;
1641     <span class="keyword">end</span>
1642 <span class="keyword">end</span>
1643 
1644 <span class="keyword">switch</span> data.import.fileformat
1645     <span class="keyword">case</span> <span class="string">'bamtom'</span>
1646         nslices = out.parData.nSlices;
1647         ncsvfiles = numel(fnames);
1648 
1649         <span class="comment">% check for background file (&quot;Leermessung&quot;)</span>
1650         has_bg = false;
1651         <span class="keyword">for</span> i = 1:numel(fnames)
1652             <span class="keyword">if</span> ~isempty(strfind(fnames(i).datafile,<span class="string">'000'</span>))
1653                 has_bg = true;
1654                 index_bg = i;
1655                 <span class="keyword">break</span>;
1656             <span class="keyword">end</span>
1657         <span class="keyword">end</span>
1658 
1659         <span class="keyword">if</span> has_bg
1660             <span class="comment">% background data set</span>
1661             bg = data.import.NMR.data{index_bg};
1662 
1663             <span class="comment">% vector of indices of the files that get corrected</span>
1664             ind_files = 1:1:ncsvfiles;
1665             ind_files(ind_files==index_bg) = [];
1666 
1667             <span class="keyword">for</span> i = ind_files
1668                 <span class="comment">% subtract the background signal</span>
1669                 s = data.import.NMR.data{i}.signal;
1670                 s_bg = bg.signal;
1671                 <span class="comment">% if the background signal is longer than the signal cut it</span>
1672                 <span class="keyword">if</span> numel(s_bg) &gt; numel(s)
1673                     tmp_s = s_bg(1:numel(s));
1674                 <span class="keyword">else</span> <span class="comment">% if not pad it with zeros</span>
1675                     tmp_s = zeros(size(s));
1676                     tmp_s(1:numel(s_bg)) = s_bg;
1677                 <span class="keyword">end</span>
1678                 s = complex(real(s)-real(tmp_s),imag(s)-imag(tmp_s));
1679                 <span class="comment">% update original data set</span>
1680                 data.import.NMR.data{i}.signal = s;
1681             <span class="keyword">end</span>
1682 
1683             <span class="comment">% check if the number of slices is equal to the number of files</span>
1684             <span class="comment">% (excluding the background file)</span>
1685             <span class="keyword">if</span> nslices == numel(ind_files)
1686                 <span class="comment">% create z-vector</span>
1687                 p = out.parData;
1688                 zslice = linspace(p.startPos,p.endPos,p.nSlices)';
1689                 data.import.BAM.use_z = true;
1690                 data.import.BAM.zslice = zslice;
1691                 <span class="keyword">if</span> numel(zslice) &gt; 1
1692                     c = 0;
1693                     <span class="keyword">for</span> i = ind_files
1694                         c = c + 1;
1695                         tmp = shownames{i};
1696                         shownames{i} = [tmp,<span class="string">' z:'</span>,sprintf(<span class="string">'%5.4f'</span>,zslice(c))];
1697                     <span class="keyword">end</span>
1698                 <span class="keyword">end</span>
1699             <span class="keyword">else</span>
1700                 data.import.BAM.use_z = false;
1701                 data.import.BAM.zslice = 1:1:max([numel(ind_files) 1]);
1702             <span class="keyword">end</span>
1703         <span class="keyword">else</span>
1704             <span class="keyword">if</span> nslices == ncsvfiles
1705                 <span class="comment">% create z-vector</span>
1706                 p = out.parData;
1707                 zslice = linspace(p.startPos,p.endPos,p.nSlices)';
1708                 data.import.BAM.use_z = true;
1709                 data.import.BAM.zslice = zslice;
1710                 <span class="keyword">if</span> numel(zslice) &gt; 1
1711                     <span class="keyword">for</span> i = 1:numel(zslice)
1712                         tmp = shownames{i};
1713                         shownames{i} = [tmp,<span class="string">' z:'</span>,sprintf(<span class="string">'%5.4f'</span>,zslice(i))];
1714                     <span class="keyword">end</span>
1715                 <span class="keyword">end</span>
1716             <span class="keyword">else</span>
1717                 data.import.BAM.use_z = false;
1718                 data.import.BAM.zslice = 1:1:ncsvfiles;
1719             <span class="keyword">end</span>
1720         <span class="keyword">end</span>
1721         data.import.BAM.z_unit = <span class="string">'µm'</span>;
1722 <span class="keyword">end</span>
1723 
1724 <span class="comment">% update the global data structure</span>
1725 data.import.NMR.files = fnames;
1726 data.import.NMR.filesShort = shownames;
1727 
1728 <span class="keyword">end</span>
1729 
1730 <span class="comment">%%</span>
1731 <a name="_sub13" href="#_subfunctions" class="code">function [data,gui] = importDataLIAG(data,gui)</a>
1732 
1733 in.path = fullfile(data.import.path);
1734 in.fileformat = data.import.fileformat;
1735 out = <a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>(in);
1736 
1737 fnames = struct;
1738 <span class="comment">% shownames is just a dummy to hold all data file names that</span>
1739 <span class="comment">% will be shown in the listbox</span>
1740 shownames = cell(1,1);
1741 
1742 c = 0;
1743 <span class="keyword">for</span> j = 1:size(out.nmrData,2)
1744     <span class="comment">% the individual file names</span>
1745     c = c + 1;
1746     fnames(c).parfile = <span class="string">'acqu.par'</span>;
1747     fnames(c).datafile = out.nmrData{j}.datfile;
1748     fnames(c).T2specfile = <span class="string">''</span>;
1749 
1750     shownames{c} = fnames(c).datafile;
1751 
1752     <span class="comment">% the NMR data</span>
1753     <span class="comment">% here we fix the time scale to [s] if neccessary</span>
1754     TE = out.parData.echoTime; <span class="comment">% [µs]</span>
1755     <span class="keyword">if</span> out.nmrData{j}.time(1)== TE/1e3
1756         <span class="comment">% change [ms] to [s]</span>
1757         out.nmrData{j}.time = out.nmrData{j}.time/1e3;
1758         out.nmrData{j}.raw.time = out.nmrData{j}.raw.time/1e3;
1759     <span class="keyword">elseif</span> out.nmrData{j}.time(1)== TE
1760         <span class="comment">% change [µs] to [s] -&gt; very unlikely</span>
1761         out.nmrData{j}.time = out.nmrData{j}.time/1e6;
1762         out.nmrData{j}.raw.time = out.nmrData{j}.raw.time/1e6;
1763     <span class="keyword">end</span>
1764     data.import.NMR.data{c} = out.nmrData{j};
1765     data.import.NMR.para{c} = out.parData;
1766 <span class="keyword">end</span>
1767 
1768 <span class="comment">% update the global data structure</span>
1769 data.import.NMR.files = fnames;
1770 data.import.NMR.filesShort = shownames;
1771 
1772 <span class="keyword">end</span>
1773 
1774 <span class="comment">%%</span>
1775 <a name="_sub14" href="#_subfunctions" class="code">function [data,gui] = importDataLIAGcore(data,gui)</a>
1776 
1777 <span class="comment">% get all subfolders containing a measurement at a certain heigth</span>
1778 subdirs = dir(data.import.path);
1779 <span class="comment">% remove the dot-dirs</span>
1780 subdirs = subdirs(~ismember({subdirs.name},{<span class="string">'.'</span>,<span class="string">'..'</span>}));
1781 
1782 <span class="comment">% now get the background data (&quot;Leermessung&quot;)</span>
1783 bgPath = uigetdir(data.import.path,<span class="string">'Choose Background Data Path'</span>);
1784 isbgPath = false;
1785 <span class="keyword">if</span> bgPath == 0
1786     disp(<span class="string">'NUCLEUSinv: LIAG core import: No background file provided.'</span>);
1787 <span class="keyword">else</span>
1788     isbgPath = true;
1789     in.path = fullfile(bgPath);
1790     in.fileformat = data.import.fileformat;
1791     bgout = <a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>(in);
1792     ref1.t = bgout.nmrData{1}.time;
1793     ref1.s = bgout.nmrData{1}.signal;
1794     [ref1.s,~] = <a href="../../../nucleus/functions/import/rotateT2phase.html" class="code" title="function [s_rot,alpha] = rotateT2phase(s,varargin)">rotateT2phase</a>(ref1.s);
1795 <span class="keyword">end</span>
1796 
1797 <span class="comment">% get the Position file</span>
1798 [posFile,posFilePath] = uigetfile(<span class="string">'*.*'</span>,<span class="string">'Choose Lift Position File'</span>,data.import.path);
1799 isposFile = false;
1800 <span class="keyword">if</span> posFilePath == 0
1801     disp(<span class="string">'NUCLEUSinv: LIAG core import: No position file provided.'</span>);
1802 <span class="keyword">else</span>
1803     isposFile = true;
1804     <span class="comment">% import LIAG lift file</span>
1805     buffer = fileread(fullfile(posFilePath,posFile));
1806 
1807     <span class="comment">% get the time stamps of the lift positions</span>
1808     substr = <span class="string">'Zeit:'</span> ;
1809     loc = strfind(buffer, substr);
1810     timepoint = cell(1,1);
1811     <span class="keyword">for</span> i = 1:length(loc)
1812         timestr = strtrim(buffer(loc(i)+numel(substr):loc(i)+numel(substr)+19));
1813         timepoint{i} = datetime(timestr,<span class="string">'InputFormat'</span>,<span class="string">'dd.MM.yyyy HH:mm:ss'</span>);
1814     <span class="keyword">end</span>
1815     <span class="comment">% ignore the first time stamp</span>
1816     t_range = [datenum(timepoint{2}), datenum(timepoint{3})];
1817     <span class="comment">% get the z coords</span>
1818     substr = <span class="string">'Z1='</span>;
1819     loc = strfind(buffer, substr) ;
1820     z_range(1) = sscanf(buffer(loc+numel(substr):loc+numel(substr)+10),<span class="string">'%f'</span>,1);
1821     substr = <span class="string">'Z2='</span>;
1822     loc = strfind(buffer, substr) ;
1823     z_range(2) =  sscanf(buffer(loc+numel(substr):loc+numel(substr)+10),<span class="string">'%f'</span>,1);
1824 <span class="keyword">end</span>
1825 
1826 <span class="comment">% import the NMR data</span>
1827 count = 0;
1828 levels = zeros(size(subdirs));
1829 nmrDataTMP = cell(1,1);
1830 <span class="keyword">for</span> i = 1:numel(subdirs)
1831     <span class="keyword">if</span> ~isnan(str2double(subdirs(i).name))
1832 
1833         <span class="comment">% import the NMR file</span>
1834         in.path = fullfile(data.import.path,subdirs(i).name,<span class="string">'T2CPMG'</span>);
1835         in.fileformat = data.import.fileformat;
1836         out = <a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>(in);
1837 
1838         <span class="comment">% if there is a position file</span>
1839         <span class="keyword">if</span> isposFile
1840             <span class="comment">% keep only files within the correct time range</span>
1841             <span class="keyword">if</span> out.nmrData{1}.datenum &gt; t_range(1) &amp;&amp; out.nmrData{1}.datenum &lt; t_range(2)
1842                 count = count + 1;
1843                 <span class="comment">% interpolate the z position via the time stamp of the NMR file</span>
1844                 levels(count) = interp1(t_range,z_range,out.nmrData{1}.datenum,<span class="string">'linear'</span>);
1845                 nmrDataTMP{count} = out;
1846             <span class="keyword">end</span>
1847         <span class="keyword">else</span> <span class="comment">% just read everything</span>
1848             count = count + 1;
1849             levels(count) = str2double(subdirs(i).name);
1850             nmrDataTMP{count} = out;
1851         <span class="keyword">end</span>
1852     <span class="keyword">end</span>
1853 <span class="keyword">end</span>
1854 <span class="comment">% cut off data that is not part of the scan</span>
1855 levels = levels(1:count);
1856 <span class="comment">% sort in ascending order</span>
1857 [levels,idx] = sort(levels);
1858 
1859 <span class="comment">% sort the NMR data accordingly</span>
1860 fnames = struct;
1861 <span class="comment">% shownames is just a dummy to hold all data file names that</span>
1862 <span class="comment">% will be shown in the listbox</span>
1863 shownames = cell(1,1);
1864 <span class="keyword">for</span> c = 1:numel(levels)
1865     <span class="comment">% the individual file names</span>
1866     fnames(c).parfile = <span class="string">'acqu.par'</span>;
1867     fnames(c).datafile = nmrDataTMP{idx(c)}.nmrData{1}.datfile;
1868     fnames(c).T2specfile = <span class="string">''</span>;
1869 
1870     shownames{c} = fnames(c).datafile;
1871     tmp = shownames{c};
1872     <span class="keyword">if</span> isposFile
1873         shownames{c} = [tmp,<span class="string">': '</span>,sprintf(<span class="string">'%4d'</span>,floor(levels(c))),<span class="string">'mm'</span>];
1874     <span class="keyword">else</span>
1875         shownames{c} = [tmp,<span class="string">' level:'</span>,sprintf(<span class="string">'%d'</span>,levels(c))];
1876     <span class="keyword">end</span>
1877     out = nmrDataTMP{idx(c)};
1878 
1879     <span class="comment">% the NMR data</span>
1880     <span class="comment">% here we fix the time scale to [s] if neccessary</span>
1881     TE = out.parData.echoTime; <span class="comment">% [µs]</span>
1882     <span class="keyword">if</span> out.nmrData{1}.time(1) == TE/1e3
1883         <span class="comment">% change [ms] to [s]</span>
1884         out.nmrData{1}.time = out.nmrData{1}.time/1e3;
1885         out.nmrData{1}.raw.time = out.nmrData{1}.raw.time/1e3;
1886     <span class="keyword">elseif</span> out.nmrData{1}.time(1) == TE
1887         <span class="comment">% change [µs] to [s] -&gt; very unlikely</span>
1888         out.nmrData{1}.time = out.nmrData{1}.time/1e6;
1889         out.nmrData{1}.raw.time = out.nmrData{1}.raw.time/1e6;
1890     <span class="keyword">end</span>
1891     data.import.NMR.data{c} = out.nmrData{1};
1892     data.import.NMR.para{c} = out.parData;
1893 
1894     <span class="comment">% subtract the background signal is one is available</span>
1895     <span class="keyword">if</span> isbgPath
1896         <span class="comment">% get the original signal</span>
1897         s = data.import.NMR.data{c}.signal;
1898         <span class="comment">% if the background signal is longer than the signal cut it, if</span>
1899         <span class="comment">% not extend it with zeros</span>
1900         <span class="keyword">if</span> numel(ref1.s) &gt; numel(s)
1901             tmp_r = ref1.s(1:numel(s));
1902         <span class="keyword">else</span>
1903             tmp_r = zeros(size(s));
1904             tmp_r(1:numel(ref1.s)) = ref1.s;
1905         <span class="keyword">end</span>
1906         s = complex(real(s)-real(tmp_r),imag(s)-imag(tmp_r));
1907 
1908         <span class="comment">% sign check</span>
1909         <span class="keyword">if</span> real(s(1:3))&lt;0
1910             s = s*-1;
1911         <span class="keyword">end</span>
1912 
1913         <span class="comment">% rotate phase again - TEST</span>
1914         [s,~] = <a href="../../../nucleus/functions/import/rotateT2phase.html" class="code" title="function [s_rot,alpha] = rotateT2phase(s,varargin)">rotateT2phase</a>(s);
1915 
1916         <span class="comment">% update signal</span>
1917         data.import.NMR.data{c}.signal = s;
1918         data.import.NMR.data{c}.raw.signal = s;
1919     <span class="keyword">end</span>
1920 <span class="keyword">end</span>
1921 <span class="keyword">if</span> isposFile
1922     data.import.LIAGCORE.use_z = true;
1923 <span class="keyword">else</span>
1924     data.import.LIAGCORE.use_z = false;
1925 <span class="keyword">end</span>
1926 data.import.LIAGCORE.zslice = levels;
1927 
1928 <span class="comment">% update the global data structure</span>
1929 data.import.NMR.files = fnames;
1930 data.import.NMR.filesShort = shownames;
1931 
1932 <span class="keyword">end</span>
1933 
1934 <span class="comment">%%</span>
1935 <a name="_sub15" href="#_subfunctions" class="code">function [data,gui] = importDataLIAGproject(data,gui)</a>
1936 
1937 <span class="comment">% 1) show all folders and ask for sample</span>
1938 subdirs = dir(data.import.path);
1939 <span class="comment">% remove the dot-dirs</span>
1940 subdirs = subdirs(~ismember({subdirs.name},{<span class="string">'.'</span>,<span class="string">'..'</span>}));
1941 
1942 fnames = {subdirs.name};
1943 [indx,~] = listdlg(<span class="string">'PromptString'</span>,<span class="string">'Select Sample:'</span>,<span class="keyword">...</span>
1944     <span class="string">'SelectionMode'</span>,<span class="string">'single'</span>,<span class="keyword">...</span>
1945     <span class="string">'ListString'</span>,fnames);
1946 
1947 <span class="keyword">if</span> ~isempty(indx)
1948     <span class="comment">% 2) check corresponding SampleParameter.par file for reference and</span>
1949     <span class="comment">% calibration sample and other parameters</span>
1950     datapath = fullfile(data.import.path,fnames{indx});
1951     <span class="comment">% load SampleParameter file for sample</span>
1952     [SampleParameter] = <a href="#_sub19" class="code" title="subfunction data = loadGUIParameters(datapath,fname)">loadGUIParameters</a>(datapath,<span class="string">'SampleParameters.par'</span>);
1953     <span class="keyword">if</span> isfield(SampleParameter,<span class="string">'sampleVolume'</span>)
1954         dataVol = SampleParameter.sampleVolume;
1955     <span class="keyword">else</span>
1956         dataVol = 1;
1957     <span class="keyword">end</span>
1958 
1959     <span class="comment">% 2a) background file #1</span>
1960     backgroundFile1 = SampleParameter.backgroundFile;
1961     <span class="keyword">if</span> isempty(backgroundFile1)
1962         bnames = {subdirs.name};
1963         bnames(indx) = [];
1964         [indb,~] = listdlg(<span class="string">'PromptString'</span>,<span class="string">'Select Background File:'</span>,<span class="keyword">...</span>
1965             <span class="string">'SelectionMode'</span>,<span class="string">'single'</span>,<span class="keyword">...</span>
1966             <span class="string">'ListString'</span>,bnames);
1967         <span class="keyword">if</span> ~isempty(indb)
1968             backgroundFile1 = bnames{indb};
1969         <span class="keyword">else</span>
1970             backgroundFile1 = <span class="string">''</span>;
1971         <span class="keyword">end</span>
1972     <span class="keyword">end</span>
1973     <span class="keyword">if</span> ~isempty(backgroundFile1)
1974         ind = strfind(backgroundFile1,filesep);
1975         <span class="keyword">if</span> ~isempty(ind)
1976             backgroundFile1 = backgroundFile1(ind(end)+1:end);
1977         <span class="keyword">end</span>
1978         fileInList = ismember(fnames,{backgroundFile1});
1979         <span class="keyword">if</span> any(fileInList)
1980             backgroundpath1 = fullfile(data.import.path,fnames{fileInList});
1981         <span class="keyword">end</span>
1982     <span class="keyword">else</span>
1983         backgroundpath1 = <span class="string">''</span>;
1984         backgroundFile1 = <span class="string">''</span>;
1985     <span class="keyword">end</span>
1986     backVol = 1;
1987 
1988     <span class="comment">% 2b) calibration file</span>
1989     c = 0;
1990     <span class="keyword">if</span> isfield(SampleParameter,<span class="string">'calibrationFile0'</span>)
1991         c = c + 1;
1992         calibrationFiles{c} = SampleParameter.calibrationFile0;
1993     <span class="keyword">end</span>
1994     <span class="keyword">if</span> isfield(SampleParameter,<span class="string">'calibrationFile1'</span>)
1995         c = c + 1;
1996         calibrationFiles{c} = SampleParameter.calibrationFile1;
1997     <span class="keyword">end</span>
1998     <span class="keyword">if</span> isfield(SampleParameter,<span class="string">'calibrationFile2'</span>)
1999         c = c + 1;
2000         calibrationFiles{c} = SampleParameter.calibrationFile2;
2001     <span class="keyword">end</span>
2002     <span class="keyword">if</span> isfield(SampleParameter,<span class="string">'calibrationFile3'</span>)
2003         c = c + 1;
2004         calibrationFiles{c} = SampleParameter.calibrationFile3;
2005     <span class="keyword">end</span>
2006 
2007     <span class="comment">% find the non-empty one</span>
2008     ind = ismember(calibrationFiles,{<span class="string">''</span>});
2009     <span class="comment">% there are three possibilities: 0, 1 and more than 1 calib. files</span>
2010     calibrationFiles(ind) = [];
2011     <span class="keyword">if</span> isempty(calibrationFiles)
2012         cnames = {subdirs.name};
2013         cnames(indx) = [];
2014         [indc,~] = listdlg(<span class="string">'PromptString'</span>,<span class="string">'Select Calibration File:'</span>,<span class="keyword">...</span>
2015             <span class="string">'SelectionMode'</span>,<span class="string">'single'</span>,<span class="keyword">...</span>
2016             <span class="string">'ListString'</span>,cnames);
2017         <span class="keyword">if</span> ~isempty(indc)
2018             calibrationFiles = cnames{indc};
2019         <span class="keyword">else</span>
2020             calibrationFiles = <span class="string">''</span>;
2021         <span class="keyword">end</span>
2022     <span class="keyword">else</span>
2023         <span class="comment">% if there are more than one let the user select the correct one</span>
2024         <span class="keyword">if</span> numel(calibrationFiles) &gt; 1
2025             [ind,~] = listdlg(<span class="string">'PromptString'</span>,<span class="string">'Select Calibration File:'</span>,<span class="keyword">...</span>
2026                 <span class="string">'SelectionMode'</span>,<span class="string">'single'</span>,<span class="keyword">...</span>
2027                 <span class="string">'ListString'</span>,calibrationFiles);
2028             calibrationFiles = calibrationFiles{ind};
2029         <span class="keyword">else</span>
2030             calibrationFiles = calibrationFiles{1};
2031         <span class="keyword">end</span>
2032     <span class="keyword">end</span>
2033     <span class="keyword">if</span> ~isempty(calibrationFiles)
2034         ind = strfind(calibrationFiles,filesep);
2035         <span class="keyword">if</span> ~isempty(ind)
2036             calibrationFiles = calibrationFiles(ind(end)+1:end);
2037         <span class="keyword">end</span>
2038         fileInList = ismember(fnames,{calibrationFiles});
2039         <span class="keyword">if</span> any(fileInList)
2040             calibrationpath = fullfile(data.import.path,fnames{fileInList});
2041         <span class="keyword">end</span>
2042     <span class="keyword">else</span>
2043         calibrationpath = <span class="string">''</span>;
2044         calibrationFiles = <span class="string">''</span>;
2045     <span class="keyword">end</span>
2046 
2047     <span class="keyword">if</span> ~isempty(calibrationpath)
2048         [SampleParameterC] = <a href="#_sub19" class="code" title="subfunction data = loadGUIParameters(datapath,fname)">loadGUIParameters</a>(calibrationpath,<span class="string">'SampleParameters.par'</span>);
2049         <span class="keyword">if</span> isfield(SampleParameterC,<span class="string">'sampleVolume'</span>)
2050             calibVol = SampleParameterC.sampleVolume;
2051         <span class="keyword">else</span>
2052             calibVol = 1;
2053         <span class="keyword">end</span>
2054 
2055         <span class="comment">% 2a) background file #2</span>
2056         backgroundFile2 = SampleParameterC.backgroundFile;
2057         <span class="keyword">if</span> isempty(backgroundFile2)
2058             bnames = {subdirs.name};
2059             bnames(indx) = [];
2060             [indb,~] = listdlg(<span class="string">'PromptString'</span>,<span class="string">'Select Background File for Calibration:'</span>,<span class="keyword">...</span>
2061                 <span class="string">'SelectionMode'</span>,<span class="string">'single'</span>,<span class="keyword">...</span>
2062                 <span class="string">'ListString'</span>,bnames);
2063             <span class="keyword">if</span> ~isempty(indb)
2064                 backgroundFile2 = bnames{indb};
2065             <span class="keyword">else</span>
2066                 backgroundFile2 = <span class="string">''</span>;
2067             <span class="keyword">end</span>
2068         <span class="keyword">end</span>
2069         <span class="keyword">if</span> ~isempty(backgroundFile2)
2070             ind = strfind(backgroundFile2,filesep);
2071             <span class="keyword">if</span> ~isempty(ind)
2072                 backgroundFile2 = backgroundFile2(ind(end)+1:end);
2073             <span class="keyword">end</span>
2074             fileInList = ismember(fnames,{backgroundFile2});
2075             <span class="keyword">if</span> any(fileInList)
2076                 backgroundpath2 = fullfile(data.import.path,fnames{fileInList});
2077             <span class="keyword">end</span>
2078         <span class="keyword">else</span>
2079             backgroundpath2 = <span class="string">''</span>;
2080             backgroundFile2 = <span class="string">''</span>;
2081         <span class="keyword">end</span>
2082     <span class="keyword">else</span>
2083         calibVol = 1;
2084         backgroundpath2 = <span class="string">''</span>;
2085         backgroundFile2 = <span class="string">''</span>;
2086     <span class="keyword">end</span>
2087 
2088     <span class="comment">% 3) now load the data</span>
2089     workpaths = {datapath,calibrationpath,backgroundpath1,backgroundpath2};
2090     workfiles = {fnames{indx},[calibrationFiles,<span class="string">' - calibration'</span>],<span class="keyword">...</span>
2091         [backgroundFile1,<span class="string">' - backgroundS'</span>],[backgroundFile2,<span class="string">' - backgroundC'</span>]};
2092     out = cell(size(workpaths));
2093     count = 0;
2094     keep = false(size(workpaths));
2095     <span class="keyword">for</span> i = 1:numel(workpaths)
2096         <span class="keyword">if</span> ~isempty(workpaths{i})
2097             workdirs = dir(workpaths{i});
2098             workdirs = workdirs(~ismember({workdirs.name},{<span class="string">'.'</span>,<span class="string">'..'</span>}));
2099             isT2 = ismember({workdirs.name},{<span class="string">'T2CPMG'</span>});
2100             <span class="keyword">if</span> any(isT2)
2101                 keep(i) = true;
2102                 count = count + 1;
2103                 T2path = fullfile(workdirs(isT2).folder,workdirs(isT2).name);
2104                 in.path = T2path;
2105                 in.fileformat = data.import.fileformat;
2106                 out{i} = <a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>(in);
2107             <span class="keyword">end</span>
2108         <span class="keyword">end</span>
2109     <span class="keyword">end</span>
2110 
2111     <span class="keyword">if</span> isempty(backgroundpath1)
2112         ref1 = struct;
2113     <span class="keyword">else</span>
2114         background1 = out{3};
2115         <span class="comment">% get the background data 1</span>
2116         ref1.t = background1.nmrData{1}.time;
2117         ref1.s = background1.nmrData{1}.signal;
2118         [ref1.s,~] = <a href="../../../nucleus/functions/import/rotateT2phase.html" class="code" title="function [s_rot,alpha] = rotateT2phase(s,varargin)">rotateT2phase</a>(ref1.s);
2119     <span class="keyword">end</span>
2120 
2121     <span class="keyword">if</span> isempty(backgroundpath2)
2122         ref2 = struct;
2123     <span class="keyword">else</span>
2124         background2 = out{4};
2125         <span class="comment">% get the background data 2</span>
2126         ref2.t = background2.nmrData{1}.time;
2127         ref2.s = background2.nmrData{1}.signal;
2128         [ref2.s,~] = <a href="../../../nucleus/functions/import/rotateT2phase.html" class="code" title="function [s_rot,alpha] = rotateT2phase(s,varargin)">rotateT2phase</a>(ref2.s);
2129     <span class="keyword">end</span>
2130 
2131     workpaths = workpaths(keep);
2132     workfiles = workfiles(keep);
2133     out = out(keep);
2134 
2135     ffnames = struct;
2136     <span class="comment">% shownames is just a dummy to hold all data file names that</span>
2137     <span class="comment">% will be shown in the listbox</span>
2138     shownames = cell(1,1);
2139 
2140     <span class="keyword">for</span> i = 1:count
2141         ffnames(i).parfile = <span class="string">'acqu.par'</span>;
2142         ffnames(i).datafile = workfiles{i};
2143         ffnames(i).T2specfile = <span class="string">''</span>;
2144 
2145         shownames{i} = ffnames(i).datafile;
2146 
2147         <span class="comment">% the NMR data</span>
2148         <span class="comment">% here we fix the time scale to [s] if neccessary</span>
2149         TE = out{i}.parData.echoTime; <span class="comment">% [µs]</span>
2150         <span class="keyword">if</span> out{i}.nmrData{1}.time(1)== TE/1e3
2151             <span class="comment">% change [ms] to [s]</span>
2152             out{i}.nmrData{1}.time = out{i}.nmrData{1}.time/1e3;
2153             out{i}.nmrData{1}.raw.time = out{i}.nmrData{1}.raw.time/1e3;
2154         <span class="keyword">elseif</span> out{i}.nmrData{1}.time(1)== TE
2155             <span class="comment">% change [µs] to [s] -&gt; very unlikely</span>
2156             out{i}.nmrData{1}.time = out{i}.nmrData{1}.time/1e6;
2157             out{i}.nmrData{1}.raw.time = out{i}.nmrData{1}.raw.time/1e6;
2158         <span class="keyword">end</span>
2159 
2160         data.import.NMR.data{i} = out{i}.nmrData{1};
2161         data.import.NMR.para{i} = out{i}.parData;
2162         data.import.NMR.para{i}.SampleParameter = SampleParameter;
2163 
2164         <span class="comment">% subtract the background signal</span>
2165         s = data.import.NMR.data{i}.signal;
2166         <span class="keyword">if</span> i==1 &amp;&amp; isfield(ref1,<span class="string">'s'</span>)
2167             <span class="comment">% if the background signal is longer than the signal cut it, if</span>
2168             <span class="comment">% not extend it with zeros</span>
2169             <span class="keyword">if</span> numel(ref1.s) &gt; numel(s)
2170                 tmp_r = ref1.s(1:numel(s));
2171             <span class="keyword">else</span>
2172                 tmp_r = zeros(size(s));
2173                 tmp_r(1:numel(ref1.s)) = ref1.s;
2174             <span class="keyword">end</span>
2175             s = complex(real(s)-real(tmp_r),imag(s)-imag(tmp_r));
2176         <span class="keyword">elseif</span> i==2 &amp;&amp; isfield(ref2,<span class="string">'s'</span>)
2177             <span class="comment">% if the background signal is longer than the signal cut it, if</span>
2178             <span class="comment">% not extend it with zeros</span>
2179             <span class="keyword">if</span> numel(ref2.s) &gt; numel(s)
2180                 tmp_r = ref2.s(1:numel(s));
2181             <span class="keyword">else</span>
2182                 tmp_r = zeros(size(s));
2183                 tmp_r(1:numel(ref2.s)) = ref2.s;
2184             <span class="keyword">end</span>
2185             s = complex(real(s)-real(tmp_r),imag(s)-imag(tmp_r));
2186         <span class="keyword">end</span>
2187         data.import.NMR.data{i}.signal = s;
2188         data.import.NMR.data{i}.raw.signal = s;
2189 
2190         <span class="keyword">if</span> ~isempty(strfind(workfiles{i},<span class="string">' - background'</span>))
2191             data.import.LIAG.sampleVol(i) = backVol;
2192         <span class="keyword">elseif</span> ~isempty(strfind(workfiles{i},<span class="string">' - calibration'</span>))
2193             data.import.LIAG.sampleVol(i) = calibVol;
2194         <span class="keyword">elseif</span> isempty(strfind(workfiles{i},<span class="string">' - background'</span>)) &amp;&amp;<span class="keyword">...</span>
2195                 isempty(strfind(workfiles{i},<span class="string">' - calibration'</span>))
2196             data.import.LIAG.sampleVol(i) = dataVol;
2197         <span class="keyword">end</span>
2198     <span class="keyword">end</span>
2199     data.import.LIAG.Tbulk = 1e6;
2200     data.import.LIAG.Tbulk_keep_fit = false;
2201     data.import.LIAG.workpaths = workpaths;
2202     data.import.LIAG.datapath = datapath;
2203     data.import.LIAG.calibrationpath = calibrationpath;
2204     data.import.LIAG.backgroundpath1 = backgroundpath1;
2205     data.import.LIAG.backgroundpath2 = backgroundpath2;
2206 
2207     <span class="comment">% update the global data structure</span>
2208     data.import.NMR.files = ffnames;
2209     data.import.NMR.filesShort = shownames;
2210 <span class="keyword">end</span>
2211 
2212 <span class="keyword">end</span>
2213 
2214 <span class="comment">%%</span>
2215 <a name="_sub16" href="#_subfunctions" class="code">function [data,gui] = importDataMouse(data,gui)</a>
2216 
2217 in.path = fullfile(data.import.path);
2218 in.fileformat = data.import.fileformat;
2219 out = <a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>(in);
2220 
2221 fnames = struct;
2222 <span class="comment">% shownames is just a dummy to hold all data file names that</span>
2223 <span class="comment">% will be shown in the listbox</span>
2224 shownames = cell(1,1);
2225 
2226 c = 0;
2227 <span class="keyword">for</span> j = 1:size(out.nmrData,2)
2228     <span class="comment">% the individual file names</span>
2229     c = c + 1;
2230     fnames(c).parfile = <span class="string">'acq.par'</span>;
2231     fnames(c).datafile = out.nmrData{j}.datfile;
2232     fnames(c).T2specfile = <span class="string">''</span>;
2233 
2234     shownames{c} = [<span class="string">'T2_'</span>,fnames(c).datafile];
2235 
2236     <span class="comment">% the NMR data</span>
2237     <span class="comment">% here we fix the time scale from [ms] to [s]</span>
2238     <span class="keyword">if</span> max(out.nmrData{j}.time) &gt; 100
2239         out.nmrData{j}.time = out.nmrData{j}.time/1000;
2240         out.nmrData{j}.raw.time = out.nmrData{j}.raw.time/1000;
2241     <span class="keyword">end</span>
2242     data.import.NMR.data{c} = out.nmrData{j};
2243     data.import.NMR.para{c} = out.parData;
2244 <span class="keyword">end</span>
2245 
2246 <span class="comment">% update the global data structure</span>
2247 data.import.NMR.files = fnames;
2248 data.import.NMR.filesShort = shownames;
2249 
2250 <span class="keyword">end</span>
2251 
2252 <span class="comment">%%</span>
2253 <a name="_sub17" href="#_subfunctions" class="code">function [data,gui] = importDataMRSMatlab(data,gui)</a>
2254 
2255 in.path = fullfile(data.import.path);
2256 in.name = data.import.file;
2257 in.fileformat = data.import.fileformat;
2258 out = <a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>(in);
2259 
2260 fnames = struct;
2261 <span class="comment">% shownames is just a dummy to hold all data file names that</span>
2262 <span class="comment">% will be shown in the listbox</span>
2263 shownames = cell(1,1);
2264 
2265 c = 0;
2266 <span class="keyword">for</span> j = 1:size(out.nmrData,2)
2267     <span class="comment">% the individual file names</span>
2268     c = c + 1;
2269     fnames(c).parfile = <span class="string">''</span>;
2270     fnames(c).datafile = data.import.file;
2271     fnames(c).T2specfile = <span class="string">''</span>;
2272 
2273     shownames{c} = out.parData{j}.file;
2274 
2275     data.import.NMR.data{c} = out.nmrData{j};
2276     data.import.NMR.para{c} = out.parData{j};
2277 <span class="keyword">end</span>
2278 
2279 data.import.MRSMATLAB.q = out.q;
2280 data.import.NMR.files = fnames;
2281 data.import.NMR.filesShort = shownames;
2282 
2283 answer = questdlg(<span class="string">'Stack all or stack individually'</span>, <span class="keyword">...</span>
2284     <span class="string">'MRSD import'</span>, <span class="keyword">...</span>
2285     <span class="string">'all'</span>,<span class="string">'individual'</span>,<span class="string">'none'</span>,<span class="string">'none'</span>);
2286 
2287 <span class="keyword">switch</span> answer
2288     <span class="keyword">case</span> <span class="string">'all'</span>
2289         s = zeros(size(data.import.NMR.data{1}.signal));
2290         <span class="keyword">for</span> c = 1:numel(data.import.NMR.data)
2291             s = s + data.import.NMR.data{c}.signal;
2292         <span class="keyword">end</span>
2293         s = s./numel(data.import.NMR.data);
2294 
2295     <span class="keyword">case</span> <span class="string">'individual'</span>
2296         [indx,~] = listdlg(<span class="string">'PromptString'</span>,<span class="string">'Select pulse moments:'</span>,<span class="keyword">...</span>
2297             <span class="string">'SelectionMode'</span>,<span class="string">'multi'</span>,<span class="keyword">...</span>
2298             <span class="string">'ListString'</span>,shownames);
2299 
2300         <span class="keyword">if</span> ~isempty(indx)
2301             s = zeros(size(data.import.NMR.data{1}.signal));
2302             <span class="keyword">for</span> c = indx
2303                 s = s + data.import.NMR.data{c}.signal;
2304             <span class="keyword">end</span>
2305             s = s./numel(indx);
2306         <span class="keyword">end</span>
2307 <span class="keyword">end</span>
2308 
2309 <span class="keyword">switch</span> answer
2310     <span class="keyword">case</span> {<span class="string">'all'</span>,<span class="string">'individual'</span>}
2311         tmpdata = data.import.NMR.data{1};
2312         tmpdata.signal = s;
2313         tmpdata.raw.signal = s;
2314 
2315         data.import.NMR.data = cell(1,1);
2316         data.import.NMR.data{1} = tmpdata;
2317 
2318         tmppar = data.import.NMR.para{1};
2319         data.import.NMR.para = cell(1,1);
2320         data.import.NMR.para{1} = tmppar;
2321 
2322         fnames = fnames(1);
2323         shownames = cell(1,1);
2324         shownames{1} = fnames.datafile;
2325 
2326         data.import.NMR.files = fnames;
2327         data.import.NMR.filesShort = shownames;
2328     <span class="keyword">otherwise</span>
2329         <span class="comment">% nothing to do</span>
2330 <span class="keyword">end</span>
2331 
2332 <span class="keyword">end</span>
2333 
2334 <span class="comment">%%</span>
2335 <a name="_sub18" href="#_subfunctions" class="code">function [data,gui] = importDataIBAC(data,gui)</a>
2336 
2337 in.path = fullfile(data.import.path);
2338 in.name = data.import.file;
2339 in.fileformat = data.import.fileformat;
2340 out = <a href="../../../nucleus/functions/import/LoadNMRData_driver.html" class="code" title="function out = LoadNMRData_driver(in)">LoadNMRData_driver</a>(in);
2341 
2342 nslices = out.parData.depths;
2343 nfiles = size(out.nmrData,2);
2344 
2345 fnames = struct;
2346 <span class="comment">% shownames is just a dummy to hold all data file names that</span>
2347 <span class="comment">% will be shown in the listbox</span>
2348 shownames = cell(1,1);
2349 
2350 c = 0;
2351 <span class="keyword">for</span> j = 1:size(out.nmrData,2)
2352     <span class="comment">% the individual file names</span>
2353     c = c + 1;
2354     fnames(c).parfile = out.parData.parfile;
2355     fnames(c).datafile = out.nmrData{j}.datfile;
2356     fnames(c).T2specfile = <span class="string">''</span>;
2357 
2358     shownames{c} = [fnames(c).datafile];
2359 
2360     data.import.NMR.data{c} = out.nmrData{j};
2361     data.import.NMR.para{c} = out.parData;
2362 <span class="keyword">end</span>
2363 
2364 <span class="comment">% check if the number of depth levels is equal to the number of</span>
2365 <span class="comment">% measurements</span>
2366 <span class="keyword">if</span> nslices == nfiles
2367     <span class="comment">% create z-vector</span>
2368     p = out.parData;
2369     zslice = linspace(p.initialdepth,p.finaldepth,p.depths)';
2370     data.import.IBAC.use_z = true;
2371     data.import.IBAC.zslice = zslice;
2372     <span class="keyword">if</span> numel(zslice) &gt; 1
2373         c = 0;
2374         <span class="keyword">for</span> i = 1:nfiles
2375             c = c + 1;
2376             tmp = shownames{i};
2377             shownames{i} = [tmp,<span class="string">' z:'</span>,sprintf(<span class="string">'%05d'</span>,zslice(c))];
2378         <span class="keyword">end</span>
2379     <span class="keyword">end</span>
2380 <span class="keyword">else</span>
2381     data.import.IBAC.use_z = false;
2382     data.import.IBAC.zslice = 1:1:max([nfiles 1]);
2383 <span class="keyword">end</span>
2384 
2385 <span class="comment">% update the global data structure</span>
2386 data.import.NMR.files = fnames;
2387 data.import.NMR.filesShort = shownames;
2388 
2389 <span class="keyword">end</span>
2390 
2391 <span class="comment">%%</span>
2392 <a name="_sub19" href="#_subfunctions" class="code">function data = loadGUIParameters(datapath,fname)</a>
2393 fid = fopen(fullfile(datapath,fname));
2394 d = textscan(fid,<span class="string">'%s'</span>,<span class="string">'Delimiter'</span>,<span class="string">'\n'</span>);
2395 fclose(fid);
2396 data = struct;
2397 <span class="keyword">for</span> i = 1:size(d{1},1)
2398     str = char(d{1}(i));
2399     str = <a href="../../../nucleus/functions/import/fixParameterString.html" class="code" title="function str = fixParameterString(str)">fixParameterString</a>(str);
2400     eval([<span class="string">'data.'</span>,str,<span class="string">';'</span>]); <span class="comment">%#ok&lt;EVLDOT&gt;</span>
2401 <span class="keyword">end</span>
2402 
2403 <span class="keyword">end</span>
2404 
2405 <span class="comment">%%</span>
2406 <a name="_sub20" href="#_subfunctions" class="code">function data = loadGUIrawdata(data,NMRpath,NMRfile)</a>
2407 
2408 load(fullfile(NMRpath,<span class="string">'NUCLEUSinv_raw.mat'</span>),<span class="string">'savedata'</span>);
2409 
2410 data.import.file = NMRfile;
2411 data.import.path = NMRpath;
2412 data.import.NMR = savedata;
2413 
2414 <span class="keyword">end</span>
2415 
2416 <span class="comment">%------------- END OF CODE --------------</span>
2417 
2418 <span class="comment">%% License:</span>
2419 <span class="comment">% MIT License</span>
2420 <span class="comment">%</span>
2421 <span class="comment">% Copyright (c) 2018 Thomas Hiller</span>
2422 <span class="comment">%</span>
2423 <span class="comment">% Permission is hereby granted, free of charge, to any person obtaining a copy</span>
2424 <span class="comment">% of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
2425 <span class="comment">% in the Software without restriction, including without limitation the rights</span>
2426 <span class="comment">% to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
2427 <span class="comment">% copies of the Software, and to permit persons to whom the Software is</span>
2428 <span class="comment">% furnished to do so, subject to the following conditions:</span>
2429 <span class="comment">%</span>
2430 <span class="comment">% The above copyright notice and this permission notice shall be included in all</span>
2431 <span class="comment">% copies or substantial portions of the Software.</span>
2432 <span class="comment">%</span>
2433 <span class="comment">% THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
2434 <span class="comment">% IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
2435 <span class="comment">% FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
2436 <span class="comment">% AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
2437 <span class="comment">% LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
2438 <span class="comment">% OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
2439 <span class="comment">% SOFTWARE.</span></pre></div>
<hr><address>Generated by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>