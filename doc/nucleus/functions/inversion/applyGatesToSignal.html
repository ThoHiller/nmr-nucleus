<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of applyGatesToSignal</title>
  <meta name="keywords" content="applyGatesToSignal">
  <meta name="description" content=" re-samples (gates) a NMR signal to speedup the">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- # nucleus --><!-- # functions --><!-- menu.html inversion -->
<h1>applyGatesToSignal
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong> re-samples (gates) a NMR signal to speedup the</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function data = applyGatesToSignal(time,signal,varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment">applyGatesToSignal re-samples (gates) a NMR signal to speedup the
inversion

 Syntax:
       applyGatesToSignal(time,signal,varargin)

 Inputs:
       time - time vector
       signal - NMR signal vector (no complex data allowed!)
       varargin - PROPERTY - VALUE OPTIONS:
                    'type' - 'log' or 'lin' (default is 'log')
                      'Ng' - No. of gates (default is 100)
                  'plotit' - '0' or '1' (default is 0)
                 'special' - 'rwth' or '' (default is '')
 Outputs:
       data(:,1) - re-sampled time t
       data(:,2) - re-sampled signal
       data(:,3) - No. of echoes per gate

 Example:
       applyGatesToSignal(time,signal,'type','log')

 Other m-files required:
       none

 Subfunctions:
       none

 MAT-files required:
       none

 See also:
 Author: Thomas Hiller
 email: thomas.hiller[at]leibniz-liag.de
 License: MIT License (at end)</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../nucleus/functions/interface/processNMRData.html" class="code" title="function [nmrraw,nmrproc] = processNMRData(nmrraw,nmrproc)">processNMRData</a>	 processes the NMR raw data</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function data = applyGatesToSignal(time,signal,varargin)</a>
0002 <span class="comment">%applyGatesToSignal re-samples (gates) a NMR signal to speedup the</span>
0003 <span class="comment">%inversion</span>
0004 <span class="comment">%</span>
0005 <span class="comment">% Syntax:</span>
0006 <span class="comment">%       applyGatesToSignal(time,signal,varargin)</span>
0007 <span class="comment">%</span>
0008 <span class="comment">% Inputs:</span>
0009 <span class="comment">%       time - time vector</span>
0010 <span class="comment">%       signal - NMR signal vector (no complex data allowed!)</span>
0011 <span class="comment">%       varargin - PROPERTY - VALUE OPTIONS:</span>
0012 <span class="comment">%                    'type' - 'log' or 'lin' (default is 'log')</span>
0013 <span class="comment">%                      'Ng' - No. of gates (default is 100)</span>
0014 <span class="comment">%                  'plotit' - '0' or '1' (default is 0)</span>
0015 <span class="comment">%                 'special' - 'rwth' or '' (default is '')</span>
0016 <span class="comment">% Outputs:</span>
0017 <span class="comment">%       data(:,1) - re-sampled time t</span>
0018 <span class="comment">%       data(:,2) - re-sampled signal</span>
0019 <span class="comment">%       data(:,3) - No. of echoes per gate</span>
0020 <span class="comment">%</span>
0021 <span class="comment">% Example:</span>
0022 <span class="comment">%       applyGatesToSignal(time,signal,'type','log')</span>
0023 <span class="comment">%</span>
0024 <span class="comment">% Other m-files required:</span>
0025 <span class="comment">%       none</span>
0026 <span class="comment">%</span>
0027 <span class="comment">% Subfunctions:</span>
0028 <span class="comment">%       none</span>
0029 <span class="comment">%</span>
0030 <span class="comment">% MAT-files required:</span>
0031 <span class="comment">%       none</span>
0032 <span class="comment">%</span>
0033 <span class="comment">% See also:</span>
0034 <span class="comment">% Author: Thomas Hiller</span>
0035 <span class="comment">% email: thomas.hiller[at]leibniz-liag.de</span>
0036 <span class="comment">% License: MIT License (at end)</span>
0037 
0038 <span class="comment">%------------- BEGIN CODE --------------</span>
0039 
0040 <span class="comment">%% default settings</span>
0041 type = <span class="string">'log'</span>;
0042 Ng = 100;
0043 plotit = 0;
0044 special = <span class="string">''</span>;
0045 
0046 <span class="comment">%% input argument checking</span>
0047 <span class="keyword">if</span> nargin &gt; 2
0048     lv = length(varargin);
0049     <span class="keyword">if</span> mod(lv,2)~=0
0050         disp(<span class="string">'applyGatesToSignal: Check you input Property/Value!'</span>);
0051         disp(<span class="string">'applyGatesToSignal: Using defaults.'</span>);
0052     <span class="keyword">else</span>
0053         <span class="keyword">for</span> i = 1:lv/2
0054             prop = varargin{2*i-1};
0055             value = varargin{2*i};
0056             <span class="keyword">if</span> strcmpi(prop,<span class="string">'type'</span>) || strcmpi(prop,<span class="string">'flag'</span>)
0057                 <span class="keyword">if</span> ischar(value) &amp;&amp; (strcmpi(value,<span class="string">'log'</span>) || strcmpi(value,<span class="string">'lin'</span>))
0058                     type = value;
0059                 <span class="keyword">else</span>
0060                     disp(<span class="string">'applyGatesToSignal: ''type'' must be either ''log'' or ''lin'''</span>);
0061                     disp(<span class="string">'applyGatesToSignal: Using default: log.'</span>);
0062                 <span class="keyword">end</span>
0063             <span class="keyword">end</span>
0064             <span class="keyword">if</span> strcmpi(prop,<span class="string">'Ng'</span>)|| strcmpi(prop,<span class="string">'No'</span>)
0065                 <span class="keyword">if</span> isnumeric(value)
0066                     Ng = value;
0067                 <span class="keyword">else</span>
0068                     disp(<span class="string">'applyGatesToSignal: ''Ng'' must be a scalar value.'</span>);
0069                     disp(<span class="string">'applyGatesToSignal: Using default: 100.'</span>);
0070                 <span class="keyword">end</span>
0071             <span class="keyword">end</span>
0072             <span class="keyword">if</span> strcmpi(prop,<span class="string">'plot'</span>)|| strcmpi(prop,<span class="string">'plotit'</span>)
0073                 <span class="keyword">if</span> isnumeric(value)
0074                     plotit = value;
0075                 <span class="keyword">else</span>
0076                     disp(<span class="string">'applyGatesToSignal: ''plotit'' must be a scalar value.'</span>);
0077                     disp(<span class="string">'applyGatesToSignal: Using default: 0.'</span>);
0078                 <span class="keyword">end</span>
0079             <span class="keyword">end</span>
0080             <span class="keyword">if</span> strcmpi(prop,<span class="string">'special'</span>)
0081                 <span class="keyword">if</span> ischar(value) &amp;&amp; strcmpi(value,<span class="string">'rwth'</span>)
0082                     special = value;
0083                 <span class="keyword">else</span>
0084                     disp(<span class="string">'applyGatesToSignal: ''special'' can only be ''rwth''.'</span>);
0085                     disp(<span class="string">'applyGatesToSignal: Using default: none'</span>);
0086                 <span class="keyword">end</span>
0087             <span class="keyword">end</span>
0088         <span class="keyword">end</span>
0089     <span class="keyword">end</span>
0090 <span class="keyword">end</span>
0091 
0092 <span class="comment">%% complex signal -&gt; noise per gate</span>
0093 isimag = false;
0094 <span class="keyword">if</span> ~isreal(signal)
0095     isimag = true;
0096     Ipart = imag(signal);
0097     signal = real(signal);
0098 <span class="keyword">end</span>
0099 
0100 <span class="comment">%% shift correction from MMP:</span>
0101 VbaseCorr = abs(10*min(signal)); <span class="comment">% necessary for log to be real</span>
0102 signal = signal + VbaseCorr;  <span class="comment">% shift signal into positive</span>
0103 
0104 <span class="comment">%% get time range 'ms' or 's'</span>
0105 tfak = 1;
0106 <span class="keyword">if</span> max(time) &gt; 30
0107     tfak = 1e3;
0108 <span class="keyword">end</span>
0109 
0110 <span class="comment">%% applying the gates</span>
0111 <span class="keyword">switch</span> type
0112     <span class="keyword">case</span> <span class="string">'log'</span>
0113         <span class="comment">% get a log-spaced vector with numbers of echoes per gate</span>
0114         index = round(logspace(log10(1),3,Ng));
0115         
0116         <span class="keyword">if</span> strcmp(special,<span class="string">'rwth'</span>)
0117             <span class="comment">% merge the first 3 data points if they are below 0.001 s</span>
0118             <span class="keyword">if</span> all(time(1:3)&lt;1e-3*tfak)
0119                 index(1) = 3;
0120             <span class="keyword">end</span>
0121         <span class="keyword">end</span>
0122         <span class="comment">% the maximal No of echoes per time gates is set to M=50</span>
0123         <span class="comment">% this stabilizes / improves the RMS estimation</span>
0124         <span class="keyword">if</span> numel(time) &lt; 20000
0125             M = 50;
0126         <span class="keyword">else</span>
0127             M = 150;
0128         <span class="keyword">end</span>
0129         <span class="comment">% find the first on where the number of echoes is M</span>
0130         ind = find(abs(index-M)==min(abs(index-M)),1,<span class="string">'first'</span>);
0131         <span class="comment">% maybe M is not exactly within index due to rounding issues</span>
0132         <span class="comment">% then take the closest one</span>
0133         M = index(ind);
0134         i1 = find(index==M,1,<span class="string">'last'</span>);
0135         <span class="comment">% sum up all gates up to M</span>
0136         s1 = cumsum(index(1:i1));
0137         <span class="comment">% how many gates with M echoes we need to add to get the whole</span>
0138         <span class="comment">% signal</span>
0139         N = ceil((length(time)-s1(end))/M);
0140         <span class="comment">% make a new index vector</span>
0141         index = [index(1:i1) M*ones(1,N)];
0142         <span class="comment">% sum up all gates</span>
0143         ci = cumsum(index);
0144         <span class="comment">% find the last one we need to re-sample the whole signal</span>
0145         indc = find(ci&gt;=length(time),1,<span class="string">'first'</span>);
0146         
0147         t = zeros(indc,1);
0148         signal_g = zeros(indc,1);
0149         Nechos = zeros(indc,1);
0150         Noise = zeros(indc,1);
0151         <span class="comment">% now loop over all gates</span>
0152         <span class="keyword">for</span> i = 1:indc
0153             <span class="keyword">if</span> i == 1                
0154                 t(i) = mean(time(1:ci(i)));
0155                 signal_g(i) = exp(mean(log(signal(1:ci(i)))));
0156                 Nechos(i) = index(i);
0157                 <span class="keyword">if</span> isimag
0158                     <span class="keyword">if</span> numel(1:ci(i)) == 1
0159                         Noise(i) = Ipart(1:ci(i));
0160                     <span class="keyword">else</span>
0161                         Noise(i) = std(Ipart(1:ci(i)));
0162                     <span class="keyword">end</span>
0163                 <span class="keyword">end</span>
0164             <span class="keyword">elseif</span> i &gt; 1 &amp;&amp; i &lt; indc
0165                 t(i) = mean(time(ci(i-1)+1:ci(i)));
0166                 signal_g(i) = exp(mean(log(signal(ci(i-1)+1:ci(i)))));
0167                 Nechos(i) = index(i);
0168                 <span class="keyword">if</span> isimag
0169                     <span class="keyword">if</span> numel(ci(i-1)+1:ci(i)) == 1
0170                         Noise(i) = Ipart(ci(i-1)+1:ci(i));
0171                     <span class="keyword">else</span>
0172                         Noise(i) = std(Ipart(ci(i-1)+1:ci(i)));
0173                     <span class="keyword">end</span>
0174                     
0175                 <span class="keyword">end</span>
0176             <span class="keyword">end</span>
0177             <span class="keyword">if</span> i == indc
0178                 t(i) = mean(time(ci(i-1):end));
0179                 signal_g(i) = exp(mean(log(signal(ci(i-1):end))));
0180                 Nechos(i) = length(time)-ci(i-1)+1;
0181                 <span class="keyword">if</span> isimag                    
0182                     Noise(i) = std(Ipart(ci(i-1):end));
0183                 <span class="keyword">end</span>
0184             <span class="keyword">end</span>
0185         <span class="keyword">end</span>
0186         
0187     <span class="keyword">case</span> <span class="string">'lin'</span>
0188         <span class="comment">% get a lin-spaced vector with numbers of echoes per gate</span>
0189         timeg = linspace(time(2),time(end),Ng);
0190         t = zeros(Ng,1);
0191         signal_g = zeros(Ng,1);
0192         signal_std = zeros(Ng,1);
0193         Nechos = zeros(Ng,1);
0194         <span class="keyword">for</span> i = 1:Ng
0195             <span class="keyword">if</span> i == 1
0196                 signal_g(i,1)= mean( signal(time&lt;=timeg(i)) );
0197                 signal_std(i,1) = std( signal(time&lt;=timeg(i)) );
0198                 Nechos(i,1) = length( signal(time&lt;=timeg(i)) );
0199                 t(i,1) = 0 + timeg(1)/2;
0200             <span class="keyword">else</span>
0201                 signal_g(i,1) = mean( signal(time&lt;=timeg(i) &amp; time&gt;timeg(i-1)) );
0202                 signal_std(i,1) = std( signal(time&lt;=timeg(i) &amp; time&gt;timeg(i-1)) );
0203                 Nechos(i,1) = length( signal(time&lt;=timeg(i) &amp; time&gt;timeg(i-1)) );
0204                 t(i,1) = timeg(i-1) + (timeg(i)-timeg(i-1))/2;
0205             <span class="keyword">end</span>
0206         <span class="keyword">end</span>
0207 <span class="keyword">end</span>
0208 
0209 <span class="comment">% shift correction from MMP:</span>
0210 signal = signal - VbaseCorr; <span class="comment">% subtract shift</span>
0211 signal_g = signal_g - VbaseCorr; <span class="comment">% subtract shift</span>
0212 
0213 <span class="comment">% output struct</span>
0214 data(:,1) = t;
0215 data(:,2) = signal_g;
0216 data(:,3) = Nechos;
0217 <span class="keyword">if</span> isimag
0218  data(:,4) = Noise;
0219 <span class="keyword">end</span>
0220 
0221 <span class="comment">% if plotit is set to 1</span>
0222 <span class="keyword">if</span> plotit == 1
0223     figure;
0224     subplot(211)
0225     plot(time,signal); hold on
0226     <span class="keyword">if</span> strcmp(type,<span class="string">'lin'</span>)
0227         errorbar(t,signal_g,signal_std,<span class="string">'ko'</span>);
0228     <span class="keyword">else</span>
0229         plot(t,signal_g,<span class="string">'ko'</span>);
0230     <span class="keyword">end</span>    
0231     subplot(212);
0232     semilogx(time,signal,<span class="string">'+-'</span>); hold on
0233     semilogx(t,signal_g,<span class="string">'ko'</span>);
0234 <span class="keyword">end</span>
0235 
0236 <span class="keyword">return</span>
0237 
0238 <span class="comment">%------------- END OF CODE --------------</span>
0239 
0240 <span class="comment">%% License:</span>
0241 <span class="comment">% MIT License</span>
0242 <span class="comment">%</span>
0243 <span class="comment">% Copyright (c) 2018 Thomas Hiller</span>
0244 <span class="comment">%</span>
0245 <span class="comment">% Permission is hereby granted, free of charge, to any person obtaining a copy</span>
0246 <span class="comment">% of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
0247 <span class="comment">% in the Software without restriction, including without limitation the rights</span>
0248 <span class="comment">% to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
0249 <span class="comment">% copies of the Software, and to permit persons to whom the Software is</span>
0250 <span class="comment">% furnished to do so, subject to the following conditions:</span>
0251 <span class="comment">%</span>
0252 <span class="comment">% The above copyright notice and this permission notice shall be included in all</span>
0253 <span class="comment">% copies or substantial portions of the Software.</span>
0254 <span class="comment">%</span>
0255 <span class="comment">% THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
0256 <span class="comment">% IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
0257 <span class="comment">% FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
0258 <span class="comment">% AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
0259 <span class="comment">% LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
0260 <span class="comment">% OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
0261 <span class="comment">% SOFTWARE.</span></pre></div>
<hr><address>Generated on Tue 12-Feb-2019 08:26:00 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>